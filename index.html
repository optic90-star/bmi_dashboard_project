<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>가족 건강 대시보드</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase config and auth token are provided by the environment.
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth;
        let userId = null;
        let familyHealthData = [];
        let myChart = null;

        window.onload = async () => {
            if (Object.keys(firebaseConfig).length > 0) {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error("Firebase authentication error: ", error);
                }
            } else {
                console.error("Firebase config is missing. Data persistence will not work.");
            }
        };

        const getBmiStatusText = (bmi) => {
            if (bmi < 18.5) return '저체중';
            if (bmi >= 18.5 && bmi < 24.9) return '정상';
            if (bmi >= 25 && bmi < 29.9) return '과체중';
            return '비만';
        };

        const calculateBMI = (height, weight) => {
            if (!height || !weight || height <= 0 || weight <= 0) return 0;
            const heightM = height / 100;
            return weight / (heightM * heightM);
        };

        const calculateAchievementRate = (data) => {
            if (data.length === 0) return 0;
            let normalCount = 0;
            let weightGoalCount = 0;

            data.forEach(member => {
                const latestBmi = member.bmi_history.length > 0 ? member.bmi_history[member.bmi_history.length - 1].bmi : 0;
                const latestWeight = member.weight_history.length > 0 ? member.weight_history[member.weight_history.length - 1].weight : 0;
                
                // BMI 정상 여부
                if (latestBmi >= 18.5 && latestBmi < 24.9) {
                    normalCount++;
                }

                // 목표 체중 달성 여부 (+- 1kg 허용)
                const isWeightGoalAchieved = member.target_weight && latestWeight >= member.target_weight - 1 && latestWeight <= member.target_weight + 1;
                if (isWeightGoalAchieved) {
                    weightGoalCount++;
                }
            });

            // 전체 목표 달성률 (BMI 정상 + 체중 목표 달성)
            const totalGoals = data.length * 2;
            const achievedGoals = normalCount + weightGoalCount;
            return Math.round((achievedGoals / totalGoals) * 100);
        };

        window.handleSave = async () => {
            if (!userId) {
                alert("로그인 중이 아닙니다. 데이터를 저장할 수 없습니다.");
                return;
            }

            const name = document.getElementById('memberName').value;
            const age = parseInt(document.getElementById('memberAge').value);
            const gender = document.getElementById('memberGender').value;
            const bodyType = document.getElementById('memberBodyType').value;
            const height = parseFloat(document.getElementById('memberHeight').value);
            const weight = parseFloat(document.getElementById('memberWeight').value);
            const targetWeight = parseFloat(document.getElementById('memberTargetWeight').value);

            if (!name || !age || !gender || !bodyType || !height || !weight || !targetWeight) {
                alert('모든 정보를 정확히 입력해주세요.');
                return;
            }

            const bmi = calculateBMI(height, weight);
            const today = new Date().toISOString().split('T')[0];

            const docRef = doc(db, `artifacts/${appId}/users/${userId}/family_health/${name}`);

            try {
                const docSnap = await getDoc(docRef);
                const existingData = docSnap.exists() ? docSnap.data() : {
                    bmi_history: [],
                    weight_history: [],
                    initial_weight: weight
                };

                const newBmiHistory = [...(existingData.bmi_history || []), { date: today, bmi: bmi }];
                const newWeightHistory = [...(existingData.weight_history || []), { date: today, weight: weight }];
                
                await setDoc(docRef, {
                    name,
                    age,
                    gender,
                    body_type: bodyType,
                    height,
                    target_weight: targetWeight,
                    initial_weight: existingData.initial_weight,
                    bmi_history: newBmiHistory.slice(-5), // 최신 5개 데이터만 유지
                    weight_history: newWeightHistory.slice(-5) // 최신 5개 데이터만 유지
                });
                
                document.getElementById('memberName').value = '';
                document.getElementById('memberAge').value = '';
                document.getElementById('memberGender').value = '';
                document.getElementById('memberBodyType').value = '';
                document.getElementById('memberHeight').value = '';
                document.getElementById('memberWeight').value = '';
                document.getElementById('memberTargetWeight').value = '';
                
            } catch (e) {
                console.error("Error adding document: ", e);
            }
        };

        const renderFamilyList = (data) => {
            const listContainer = document.getElementById('family-list-container');
            listContainer.innerHTML = '';
            if (data.length === 0) {
                listContainer.innerHTML = '<p class="text-gray-400">가족 정보를 추가해주세요.</p>';
            } else {
                data.forEach(member => {
                    const latestBmi = member.bmi_history.length > 0 ? member.bmi_history[member.bmi_history.length - 1].bmi : 0;
                    const latestWeight = member.weight_history.length > 0 ? member.weight_history[member.weight_history.length - 1].weight : 0;
                    const bmiStatusText = getBmiStatusText(latestBmi);
                    
                    const memberCard = `
                        <div class="bg-[#2e2e4a] p-4 rounded-xl shadow-md transition-transform hover:scale-105">
                            <h3 class="text-xl font-semibold mb-2">${member.name} (${member.age}, ${member.gender})</h3>
                            <div class="text-sm text-gray-400 space-y-1">
                                <p>체형: ${member.body_type}</p>
                                <p>초기 체중: <span class="text-white font-bold">${member.initial_weight}kg</span></p>
                                <p>현재 체중: <span class="text-white font-bold">${latestWeight}kg</span></p>
                                <p>목표 체중: <span class="text-white font-bold">${member.target_weight}kg</span></p>
                                <p>현재 BMI: <span class="text-white font-bold">${latestBmi.toFixed(1)}</span> (${bmiStatusText})</p>
                            </div>
                        </div>
                    `;
                    listContainer.innerHTML += memberCard;
                });
            }
        };

        const renderAchievementRate = (rate) => {
            const rateDisplay = document.getElementById('achievement-rate-display');
            const progressBar = document.getElementById('progress-bar');
            rateDisplay.textContent = `${rate}%`;
            progressBar.style.width = `${rate}%`;
            progressBar.style.backgroundColor = rate >= 100 ? '#4CAF50' : '#FFC107'; // 100% 달성 시 색상 변경
        };

        window.renderChart = (data) => {
            const chartCanvas = document.getElementById('bmi-chart');
            if (myChart) {
                myChart.destroy();
            }

            const allDates = [...new Set(data.flatMap(member => member.bmi_history.map(d => d.date)))].sort();
            
            const bmiDatasets = data.map(member => ({
                label: `${member.name} BMI`,
                data: member.bmi_history.map(d => d.bmi),
                borderColor: '#' + Math.floor(Math.random() * 16777215).toString(16),
                borderWidth: 2,
                borderDash: [5, 5],
                type: 'line',
                fill: false,
                datalabels: {
                    display: true,
                    formatter: (value) => value.toFixed(1)
                },
                yAxisID: 'y'
            }));

            const weightDatasets = data.map(member => ({
                label: `${member.name} 체중`,
                data: member.weight_history.map(d => d.weight),
                borderColor: '#' + Math.floor(Math.random() * 16777215).toString(16),
                borderWidth: 2,
                borderDash: [2, 2],
                type: 'line',
                fill: false,
                datalabels: {
                    display: true,
                    formatter: (value) => value.toFixed(1)
                },
                yAxisID: 'y1'
            }));

            const targetWeightDatasets = data.map(member => ({
                label: `${member.name} 목표 체중`,
                data: allDates.map(() => member.target_weight),
                borderColor: 'rgba(255, 255, 255, 0.5)',
                borderWidth: 1,
                borderDash: [5, 5],
                pointRadius: 0,
                type: 'line',
                fill: false,
                datalabels: { display: false },
                yAxisID: 'y1'
            }));

            myChart = new Chart(chartCanvas, {
                data: {
                    labels: allDates,
                    datasets: [...bmiDatasets, ...weightDatasets, ...targetWeightDatasets]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: 'white' }
                        },
                        title: {
                            display: true,
                            text: '가족 BMI 및 체중 추이',
                            color: 'white',
                            font: { size: 18 }
                        },
                        datalabels: {
                            color: 'white',
                            anchor: 'end',
                            align: 'top',
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: 'white' },
                            grid: { color: 'rgba(255, 255, 255, 0.2)' }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'BMI',
                                color: 'white'
                            },
                            ticks: { color: 'white' },
                            grid: { color: 'rgba(255, 255, 255, 0.2)' },
                            min: 15, max: 35
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: '체중 (kg)',
                                color: 'white'
                            },
                            ticks: { color: 'white' },
                            grid: { drawOnChartArea: false }
                        }
                    }
                },
                plugins: [ChartDataLabels]
            });
        };

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                const userColRef = doc(db, `artifacts/${appId}/users/${userId}/health_data/family_info`);
                
                onSnapshot(userColRef, async (docSnap) => {
                    if (docSnap.exists()) {
                        familyHealthData = Object.values(docSnap.data());
                    } else {
                        // 문서가 없을 경우 빈 객체로 초기화
                        await setDoc(userColRef, {});
                        familyHealthData = [];
                    }

                    // 최신 데이터로 UI 업데이트
                    renderFamilyList(familyHealthData);
                    renderChart(familyHealthData);
                    renderAchievementRate(calculateAchievementRate(familyHealthData));
                    
                    document.getElementById('user-id-display').textContent = userId;
                }, (error) => {
                    console.error("Error listening to document: ", error);
                });

            } else {
                console.log("No user is signed in.");
                document.getElementById('user-id-display').textContent = '로그인 필요';
            }
        });
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a1a2e;
            color: #ffffff;
        }
        .bmi-container {
            background-color: #272740;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .progress-bar-container {
            width: 100%;
            height: 12px;
            background-color: #1a1a2e;
            border-radius: 6px;
            overflow: hidden;
        }
        .progress-bar {
            height: 100%;
            background-color: #4CAF50;
            transition: width 0.5s ease-in-out;
        }
    </style>
</head>
<body class="p-6 md:p-12 min-h-screen flex items-center justify-center">
    <div class="w-full max-w-4xl mx-auto flex flex-col md:flex-row gap-8">
        <!-- Input Form and Family List -->
        <div class="md:w-1/3 w-full space-y-8">
            <div class="bmi-container p-6">
                <h2 class="text-2xl font-bold mb-4">가족 정보 입력</h2>
                <div class="space-y-4">
                    <div>
                        <label for="memberName" class="block text-sm font-medium text-gray-300">이름</label>
                        <input type="text" id="memberName" class="mt-1 block w-full rounded-md bg-[#1a1a2e] border-gray-600 focus:border-indigo-500 focus:ring-indigo-500 text-white shadow-sm" placeholder="예: 아빠">
                    </div>
                    <div>
                        <label for="memberAge" class="block text-sm font-medium text-gray-300">나이</label>
                        <input type="number" id="memberAge" class="mt-1 block w-full rounded-md bg-[#1a1a2e] border-gray-600 focus:border-indigo-500 focus:ring-indigo-500 text-white shadow-sm" placeholder="예: 45">
                    </div>
                    <div>
                        <label for="memberGender" class="block text-sm font-medium text-gray-300">성별</label>
                        <select id="memberGender" class="mt-1 block w-full rounded-md bg-[#1a1a2e] border-gray-600 focus:border-indigo-500 focus:ring-indigo-500 text-white shadow-sm">
                            <option value="남자">남자</option>
                            <option value="여자">여자</option>
                        </select>
                    </div>
                    <div>
                        <label for="memberBodyType" class="block text-sm font-medium text-gray-300">체형</label>
                        <select id="memberBodyType" class="mt-1 block w-full rounded-md bg-[#1a1a2e] border-gray-600 focus:border-indigo-500 focus:ring-indigo-500 text-white shadow-sm">
                            <option value="표준">표준</option>
                            <option value="마른 체형">마른 체형</option>
                            <option value="근육형">근육형</option>
                        </select>
                    </div>
                    <div>
                        <label for="memberHeight" class="block text-sm font-medium text-gray-300">키 (cm)</label>
                        <input type="number" id="memberHeight" class="mt-1 block w-full rounded-md bg-[#1a1a2e] border-gray-600 focus:border-indigo-500 focus:ring-indigo-500 text-white shadow-sm" placeholder="예: 175">
                    </div>
                    <div>
                        <label for="memberWeight" class="block text-sm font-medium text-gray-300">몸무게 (kg)</label>
                        <input type="number" id="memberWeight" class="mt-1 block w-full rounded-md bg-[#1a1a2e] border-gray-600 focus:border-indigo-500 focus:ring-indigo-500 text-white shadow-sm" placeholder="예: 70">
                    </div>
                    <div>
                        <label for="memberTargetWeight" class="block text-sm font-medium text-gray-300">목표 체중 (kg)</label>
                        <input type="number" id="memberTargetWeight" class="mt-1 block w-full rounded-md bg-[#1a1a2e] border-gray-600 focus:border-indigo-500 focus:ring-indigo-500 text-white shadow-sm" placeholder="예: 68">
                    </div>
                    <button onclick="handleSave()" class="w-full py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors">
                        저장
                    </button>
                </div>
            </div>
            
            <div class="bmi-container p-6">
                <h2 class="text-2xl font-bold mb-4">종합 건강 달성률</h2>
                <div class="text-center">
                    <p class="text-4xl font-bold mb-2"><span id="achievement-rate-display">0%</span></p>
                    <div class="progress-bar-container">
                        <div id="progress-bar" class="progress-bar"></div>
                    </div>
                </div>
            </div>

            <div class="bmi-container p-6">
                <h2 class="text-2xl font-bold mb-4">등록된 가족</h2>
                <div id="family-list-container" class="space-y-4">
                    <p class="text-gray-400">가족 정보를 추가해주세요.</p>
                </div>
                <div class="mt-4 p-2 bg-[#1a1a2e] text-center rounded-lg text-sm text-gray-400">
                    <p>유저 아이디: <span id="user-id-display">로딩 중...</span></p>
                </div>
            </div>
        </div>

        <!-- BMI Chart -->
        <div class="md:w-2/3 w-full bmi-container p-6 flex flex-col items-center justify-center">
            <h2 class="text-2xl font-bold mb-4 text-center">가족 건강 추이</h2>
            <div class="w-full h-80">
                <canvas id="bmi-chart"></canvas>
            </div>
        </div>
    </div>
</body>
</html>                  beginAtZero: false,
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)',
                            },
                            ticks: {
                                color: '#ffffff',
                            },
                            title: {
                                display: true,
                                text: '체중 (kg)',
                                color: '#ffffff',
                            }
                        }
                    }
                }
            };

            const ctx = document.getElementById('weightChart').getContext('2d');
            if (chart) {
                chart.destroy();
            }
            chart = new Chart(ctx, config);
        }

        // Function to call AI for advice
        async function generateAdvice(memberData, currentWeight, bmi, achievementPercentage) {
            aiAdvice.textContent = "AI가 조언을 생성 중입니다...";
            bmiReferenceTable.textContent = "BMI 기준표를 생성 중입니다...";

            const systemPrompt = "당신은 체중 관리에 대한 전문가이자 친절한 코치입니다. 사용자의 나이, 성별, 현재 BMI, 목표 달성률을 기반으로 긍정적이고 실용적인 건강 조언을 1-2 문장으로 작성해 주세요. 전문적인 의학적 조언 대신 동기 부여와 일상적인 습관에 대한 팁을 제공하세요. 존댓말을 사용해 주세요. 체중 기록에 대한 분석을 바탕으로, 체형에 따른 BMI 기준표도 제공해 주세요.";
            const userQuery = `이름: ${memberData.name}, 나이: ${memberData.age}, 성별: ${memberData.gender}, 현재 체중: ${currentWeight}kg, BMI: ${bmi}, 목표 달성률: ${achievementPercentage}%`;
            
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                }
            };

            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                if (text) {
                    const [advice, ...rest] = text.split('BMI 기준표:');
                    aiAdvice.textContent = advice.trim();
                    if (rest.length > 0) {
                        bmiReferenceTable.innerHTML = `
                            <p class="font-bold mb-2">나이 및 성별을 고려한 기준표:</p>
                            ${rest[0].trim().replace(/\n/g, '<br>')}
                        `;
                    } else {
                         bmiReferenceTable.textContent = "나이와 성별을 반영한 BMI 기준표가 없습니다.";
                    }
                } else {
                    aiAdvice.textContent = "조언을 생성하는 데 실패했습니다. 잠시 후 다시 시도해 주세요.";
                    bmiReferenceTable.textContent = "BMI 기준표를 불러올 수 없습니다.";
                }
            } catch (error) {
                console.error("AI Advice generation failed:", error);
                aiAdvice.textContent = "네트워크 오류로 인해 조언을 생성할 수 없습니다.";
                bmiReferenceTable.textContent = "네트워크 오류로 인해 BMI 기준표를 불러올 수 없습니다.";
            }
        }
    </script>
</body>
</html>        />
              ))}
            </main>
            
            <div className="text-center mt-12 text-white/50 text-sm">
              <p>&copy; 2024 가족 건강 관리</p>
            </div>
          </div>
        </div>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>]);

      if (!hasAccess) {
        return <PasswordGate onAccess={setHasAccess} />;
      }
      
      const familyMembers = Object.values(data);

      return (
        <div className="min-h-screen animated-bg">
          {toast && <ToastMessage message={toast.message} type={toast.type} onClose={() => setToast(null)} />}
          <div className="p-4 md:p-8 lg:p-12 text-white">
            <header className="text-center py-8">
              <h1 className="text-4xl md:text-5xl font-extrabold gradient-text leading-tight drop-shadow-md">
                가족 건강 대시보드
              </h1>
              <p className="text-white/70 mt-4 max-w-2xl mx-auto">
                우리 가족의 건강 데이터를 한눈에 확인하고 관리하세요.
              </p>
              <div className="mt-4 text-xs text-white/50">
                <span>공유 ID: </span>
                <span className="font-mono">{appId}</span>
              </div>
            </header>

            <main className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
              {familyMembers.map(member => (
                <FamilyMember 
                  key={member.id} 
                  memberData={member} 
                  onUpdate={updateData} 
                  baseData={initialFamilyData[member.id]}
                  setToast={setToast}
                  isLoading={isLoading}
                />
              ))}
            </main>
            
            <div className="text-center mt-12 text-white/50 text-sm">
              <p>&copy; 2024 가족 건강 관리</p>
            </div>
          </div>
        </div>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>        let progress = ((currentWeight - initialWeight) / (targetWeight - initialWeight)) * 100;
          progress = Math.min(100, Math.max(0, progress));
          return progress;
        });

        chartRef.current = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: labels,
            datasets: [{
              label: '현재 BMI',
              data: currentBmis,
              backgroundColor: [
                'rgba(75, 192, 192, 0.6)', 
                'rgba(255, 159, 64, 0.6)', 
                'rgba(54, 162, 235, 0.6)', 
                'rgba(153, 102, 255, 0.6)'
              ],
              borderColor: [
                'rgba(75, 192, 192, 1)', 
                'rgba(255, 159, 64, 1)', 
                'rgba(54, 162, 235, 1)', 
                'rgba(153, 102, 255, 1)'
              ],
              borderWidth: 1,
              datalabels: {
                color: 'white',
                anchor: 'end',
                align: 'top',
                offset: 5,
                formatter: (value) => value > 0 ? value.toFixed(1) : ''
              }
            },
            {
              label: '목표 BMI',
              data: targetBmis,
              backgroundColor: 'rgba(255, 255, 255, 0.2)',
              borderColor: 'rgba(255, 255, 255, 0.8)',
              borderWidth: 2,
              type: 'line',
              fill: false,
              datalabels: {
                display: false
              }
            },
            {
              label: '목표 달성률 (%)',
              data: progressPercentages,
              type: 'line',
              fill: false,
              borderColor: '#f5576c',
              borderWidth: 2,
              borderDash: [5, 5],
              pointBackgroundColor: '#f5576c',
              datalabels: {
                color: '#f5576c',
                anchor: 'start',
                align: 'end',
                offset: 10,
                formatter: (value) => {
                  return value !== null ? `${value.toFixed(0)}%` : '';
                }
              }
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                labels: { color: 'white' }
              },
              title: {
                display: true,
                text: '가족 BMI 및 목표 달성률',
                color: 'white',
                font: { size: 18, family: 'Noto Sans KR' }
              }
            },
            scales: {
              x: {
                ticks: { color: 'white' },
                grid: { color: 'rgba(255, 255, 255, 0.2)' }
              },
              y: {
                ticks: { color: 'white' },
                grid: { color: 'rgba(255, 255, 255, 0.2)' },
                min: 15, max: 35
              }
            }
          },
          plugins: [ChartDataLabels]
        });

        return () => {
          if (chartRef.current) {
            chartRef.current.destroy();
          }
        };
      }, [familyHealthData]);

      return <canvas ref={canvasRef} />;
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
    if (auth && !auth.currentUser) {
            authLogin();
        }

        return () => unsubscribeAuth();
      }, []);

      useEffect(() => {
        if (toast) {
          const timer = setTimeout(() => setToast(null), 3000);
          return () => clearTimeout(timer);
        }
      }, [toast]);
      
      if (!hasAccess) {
        return <PasswordGate onAccess={setHasAccess} />;
      }
      
      return (
        <div className="min-h-screen animated-bg">
          {toast && <ToastMessage message={toast.message} type={toast.type} onClose={() => setToast(null)} />}
          <div className="p-4 md:p-8 lg:p-12 text-white">
            <header className="text-center py-8">
              <h1 className="text-5xl md:text-6xl font-extrabold mb-2 gradient-text">
                Ultimate Health Dashboard
              </h1>
              <p className="text-lg md:text-xl font-medium text-white/80">
                <i className="fas fa-heartbeat mr-2 pulse"></i> 우리 가족 건강 관리
              </p>
              {userId && (
                  <div className="text-xs text-white/50 mt-2 break-all">User ID: {userId}</div>
              )}
            </header>
            <div className="fade-in">
              <div className="grid gap-8 mb-12 lg:grid-cols-2 xl:grid-cols-4">
                {Object.keys(data).map(id => (
                  <FamilyMember
                    key={id}
                    memberData={data[id]}
                    onUpdate={() => {}} // Placeholder, logic is in handleSave
                    baseData={initialFamilyData[id]}
                    setToast={setToast}
                    auth={window.firebase.auth}
                  />
                ))}
              </div>
              <div className="w-full h-[400px] glassmorphism p-4 rounded-3xl">
                {authReady ? (
                  <AdvancedBMIChart familyHealthData={data} initialData={initialFamilyData} />
                ) : (
                  <div className="flex items-center justify-center w-full h-full text-white/70">
                    <div className="animate-spin rounded-full h-10 w-10 border-4 border-white border-t-transparent mr-4"></div>
                    데이터를 불러오는 중입니다...
                  </div>
                )}
              </div>
            </div>
            <footer className="text-center text-white/50 text-sm mt-12 py-4 border-t border-white/20">
              © 2025. 수아동혁가족. All Rights Reserved.
              <div className="mt-2 text-xs break-all">이 앱은 파이어베이스 데이터베이스에 데이터를 저장합니다.</div>
            </footer>
          </div>
        </div>
      );
    };

    // Chart.js Component
    const AdvancedBMIChart = ({ familyHealthData, initialData }) => {
      const canvasRef = useRef(null);
      const chartRef = useRef(null);

      useEffect(() => {
        if (!familyHealthData || Object.keys(familyHealthData).length === 0) return;
        
        const ctx = canvasRef.current.getContext('2d');
        
        if (chartRef.current) {
            chartRef.current.destroy();
        }

        const labels = Object.values(familyHealthData).map(member => member.name);
        const currentBmis = Object.values(familyHealthData).map(member => {
          const heightM = initialData[member.id].height / 100;
          return member.weight ? (member.weight / (heightM * heightM)) : 0;
        });
        
        const targetBmis = Object.values(initialData).map(member => member.recommendedBMI);
        
        const progressPercentages = Object.values(familyHealthData).map(member => {
          const initialWeight = initialData[member.id].weight;
          const targetWeight = member.targetWeight;
          const currentWeight = member.weight;
          
          if (!targetWeight || initialWeight === targetWeight) {
            return null;
          }
          
          let progress = ((currentWeight - initialWeight) / (targetWeight - initialWeight)) * 100;
          progress = Math.min(100, Math.max(0, progress));
          return progress;
        });

        chartRef.current = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: labels,
            datasets: [{
              label: '현재 BMI',
              data: currentBmis,
              backgroundColor: [
                'rgba(75, 192, 192, 0.6)', 
                'rgba(255, 159, 64, 0.6)', 
                'rgba(54, 162, 235, 0.6)', 
                'rgba(153, 102, 255, 0.6)'
              ],
              borderColor: [
                'rgba(75, 192, 192, 1)', 
                'rgba(255, 159, 64, 1)', 
                'rgba(54, 162, 235, 1)', 
                'rgba(153, 102, 255, 1)'
              ],
              borderWidth: 1,
              datalabels: {
                color: 'white',
                anchor: 'end',
                align: 'top',
                offset: 5,
                formatter: (value) => value > 0 ? value.toFixed(1) : ''
              }
            },
            {
              label: '목표 BMI',
              data: targetBmis,
              backgroundColor: 'rgba(255, 255, 255, 0.2)',
              borderColor: 'rgba(255, 255, 255, 0.8)',
              borderWidth: 2,
              type: 'line',
              fill: false,
              datalabels: {
                display: false
              }
            },
            {
              label: '목표 달성률 (%)',
              data: progressPercentages,
              type: 'line',
              fill: false,
              borderColor: '#f5576c',
              borderWidth: 2,
              borderDash: [5, 5],
              pointBackgroundColor: '#f5576c',
              datalabels: {
                color: '#f5576c',
                anchor: 'start',
                align: 'end',
                offset: 10,
                formatter: (value) => {
                  return value !== null ? `${value.toFixed(0)}%` : '';
                }
              }
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                labels: { color: 'white' }
              },
              title: {
                display: true,
                text: '가족 BMI 및 목표 달성률',
                color: 'white',
                font: { size: 18, family: 'Noto Sans KR' }
              }
            },
            scales: {
              x: {
                ticks: { color: 'white' },
                grid: { color: 'rgba(255, 255, 255, 0.2)' }
              },
              y: {
                ticks: { color: 'white' },
                grid: { color: 'rgba(255, 255, 255, 0.2)' },
                min: 15, max: 35
              }
            }
          },
          plugins: [ChartDataLabels]
        });

        return () => {
          if (chartRef.current) {
            chartRef.current.destroy();
          }
        };
      }, [familyHealthData]);

      return <canvas ref={canvasRef} />;
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>               onUpdate={updateData}
                      baseData={initialFamilyData[id]}
                      setToast={setToast}
                    />
                  ))}
                </div>
                <div className="w-full h-[400px] glassmorphism p-4 rounded-3xl">
                  <AdvancedBMIChart familyHealthData={data} />
                </div>
              </div>
            )}
            <footer className="text-center text-white/50 text-sm mt-12 py-4 border-t border-white/20">
              © 2025. 수아동혁가족. All Rights Reserved.
              <div className="mt-2 text-xs break-all">User ID: {displayUserId}</div>
            </footer>
          </div>
        </div>
      );
    };

    // Chart.js Component
    const AdvancedBMIChart = ({ familyHealthData }) => {
      const canvasRef = useRef(null);
      const chartRef = useRef(null);

      useEffect(() => {
        if (!familyHealthData || Object.keys(familyHealthData).length === 0) return;
        
        const ctx = canvasRef.current.getContext('2d');
        
        if (chartRef.current) {
            chartRef.current.destroy();
        }

        const labels = Object.values(familyHealthData).map(member => member.name);
        const currentBmis = Object.values(familyHealthData).map(member => {
          const heightM = initialFamilyData[member.id].height / 100;
          return member.weight ? (member.weight / (heightM * heightM)) : 0;
        });
        const targetBmis = Object.values(initialFamilyData).map(member => member.recommendedBMI);
        
        chartRef.current = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: labels,
            datasets: [{
              label: '현재 BMI',
              data: currentBmis,
              backgroundColor: [
                'rgba(75, 192, 192, 0.6)', 
                'rgba(255, 159, 64, 0.6)', 
                'rgba(54, 162, 235, 0.6)', 
                'rgba(153, 102, 255, 0.6)'
              ],
              borderColor: [
                'rgba(75, 192, 192, 1)', 
                'rgba(255, 159, 64, 1)', 
                'rgba(54, 162, 235, 1)', 
                'rgba(153, 102, 255, 1)'
              ],
              borderWidth: 1
            },
            {
              label: '목표 BMI',
              data: targetBmis,
              backgroundColor: 'rgba(255, 255, 255, 0.2)',
              borderColor: 'rgba(255, 255, 255, 0.8)',
              borderWidth: 2,
              type: 'line',
              fill: false,
              datalabels: {
                display: false
              }
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                labels: { color: 'white' }
              },
              title: {
                display: true,
                text: '가족 BMI 추이',
                color: 'white',
                font: { size: 18, family: 'Noto Sans KR' }
              },
              datalabels: {
                color: 'white',
                anchor: 'end',
                align: 'top',
                formatter: (value) => value.toFixed(1)
              }
            },
            scales: {
              x: {
                ticks: { color: 'white' },
                grid: { color: 'rgba(255, 255, 255, 0.2)' }
              },
              y: {
                ticks: { color: 'white' },
                grid: { color: 'rgba(255, 255, 255, 0.2)' },
                min: 15, max: 35
              }
            }
          },
          plugins: [ChartDataLabels]
        });

        return () => {
          if (chartRef.current) {
            chartRef.current.destroy();
          }
        };
      }, [familyHealthData]);

      return <canvas ref={canvasRef} />;
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>