<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>수아동혁가족 BMI 대시보드</title>
  <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">

  <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore-compat.js"></script>

  <style>
    body { 
      font-family: 'Noto Sans KR', sans-serif; 
      background: #0f172a; 
      color: white; 
      min-height: 100vh;
      transition: background 0.5s ease;
    }
    .glassmorphism { 
      background: rgba(255,255,255,0.1); 
      backdrop-filter: blur(10px);
      box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
      border: 1px solid rgba(255, 255, 255, 0.18);
    }
    .gradient-text { 
      background: linear-gradient(to right, #4facfe, #00f2fe); 
      -webkit-background-clip: text; 
      -webkit-text-fill-color: transparent;
    }
    .bmi-excellent { background-color: #43e97b; color: white; }
    .bmi-good { background-color: #4facfe; color: white; }
    .bmi-warning { background-color: #feca57; color: white; }
    .bmi-danger { background-color: #ff6b6b; color: white; }
    .card-hover { transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out; }
    .card-hover:hover { transform: translateY(-5px); box-shadow: 0 10px 40px rgba(0,0,0,0.3); }
    .neon-glow {
      box-shadow: 0 0 5px #00f2fe, 0 0 10px #00f2fe, 0 0 20px #00f2fe;
      transition: box-shadow 0.3s ease-in-out;
    }
    .neon-glow:hover {
      box-shadow: 0 0 10px #00f2fe, 0 0 20px #00f2fe, 0 0 30px #00f2fe;
    }
    .animated-bg {
      background-size: 400% 400%;
      animation: gradientBG 15s ease infinite;
    }
    @keyframes gradientBG {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    .pulse { animation: pulse 2s infinite; }
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }
    .fade-in { animation: fadeIn 1s ease-in-out; }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    .slide-up { animation: slideUp 0.5s ease-out; }
    @keyframes slideUp {
        from { transform: translateY(20px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
    }
  </style>
</head>
<body>
<div id="root"></div>

<script type="text/babel">
  const { useState, useEffect, useRef } = React;
  const { createRoot } = ReactDOM;
  const Chart = window.Chart;
  const ChartDataLabels = window.ChartDataLabels;

  // Firebase 초기화
  const firebaseConfig = {
    apiKey: "AIzaSyDVvT5a8vh8CICbT18cqF5dMqRkxalgJWk",
    authDomain: "bmi-dashboard-project.firebaseapp.com",
    projectId: "bmi-dashboard-project",
    storageBucket: "bmi-dashboard-project.firebasestorage.app",
    messagingSenderId: "124744707008",
    appId: "1:124744707008:web:02757469b90412cc013625",
    measurementId: "G-CZQNBEYYCW"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // 기본 가족 데이터
  const initialFamilyData = {
    dad: { id: "dad", name: "아빠", height: 178, weight: 95, targetWeight: 80, emoji: "👨", age: 45, profession: "개발자", recommendedBMI: 22 },
    mom: { id: "mom", name: "엄마", height: 165, weight: 60, targetWeight: 55, emoji: "👩", age: 42, profession: "디자이너", recommendedBMI: 21 },
    daughter: { id: "daughter", name: "수아", height: 160, weight: 48, targetWeight: 50, emoji: "👧", age: 15, profession: "학생", recommendedBMI: 20 },
    son: { id: "son", name: "동혁", height: 170, weight: 70, targetWeight: 65, emoji: "👦", age: 18, profession: "학생", recommendedBMI: 22 }
  };
  
  // 비밀번호 게이트
  const PasswordGate = ({ onAccess }) => {
    const [pw, setPw] = useState("");
    return (
      <div className="flex flex-col items-center justify-center h-screen bg-slate-900">
        <div className="bg-slate-800 p-8 rounded-xl shadow-lg">
          <h2 className="text-2xl mb-4 font-bold text-center text-white">접속 비밀번호 입력</h2>
          <input 
            type="password" 
            value={pw} 
            onChange={e => setPw(e.target.value)} 
            className="p-2 rounded text-black w-full mb-4 focus:outline-none focus:ring-2 focus:ring-blue-500"
            onKeyDown={e => { if(e.key==="Enter" && pw==="1115") onAccess(true) }}
          />
          <button 
            onClick={() => { if (pw === "1115") onAccess(true) }} 
            className="bg-blue-500 hover:bg-blue-600 transition-colors px-4 py-2 rounded w-full font-semibold"
          >
            확인
          </button>
        </div>
      </div>
    );
  };

  // Toast 메시지 컴포넌트
  const ToastMessage = ({ message, type, onClose }) => {
    const bgColor = type === "success" ? "bg-green-500" : "bg-red-500";
    return (
      <div className={`fixed bottom-5 right-5 ${bgColor} text-white px-4 py-2 rounded-lg shadow-lg z-50`}>
        {message}
      </div>
    );
  };

  // 원형 프로그레스 바 컴포넌트
  const CircularProgress = ({ value, maxValue, color }) => {
    const size = 120;
    const strokeWidth = 12;
    const radius = (size - strokeWidth) / 2;
    const circumference = 2 * Math.PI * radius;
    const progress = Math.min(Math.max(0, value / maxValue * 100), 100);
    const dashoffset = circumference - (progress / 100) * circumference;

    return (
      <div className="relative flex items-center justify-center" style={{ width: size, height: size }}>
        <svg className="transform -rotate-90" width={size} height={size}>
          <circle 
            className="text-white/20" 
            strokeWidth={strokeWidth} 
            stroke="currentColor" 
            fill="transparent" 
            r={radius} 
            cx={size/2} 
            cy={size/2}
          />
          <circle 
            className="transition-all duration-700 ease-in-out" 
            strokeWidth={strokeWidth} 
            stroke={color}
            fill="transparent" 
            r={radius} 
            cx={size/2} 
            cy={size/2}
            strokeLinecap="round"
            style={{ strokeDasharray: circumference, strokeDashoffset }}
          />
        </svg>
        <div className="absolute text-white font-bold text-2xl">
          {value.toFixed(1)}
        </div>
      </div>
    );
  };

  // AI 건강 조언 컴포넌트
  const HealthInsights = ({ memberData, baseData }) => {
    const [insight, setInsight] = useState("");
    const { weight, targetWeight, bodyType } = memberData;
    const { height, name } = baseData;

    useEffect(() => {
      const getInsight = () => {
        if (!weight || !targetWeight) return "체중과 목표 체중을 입력하시면 맞춤 조언을 받을 수 있습니다.";
        
        const bmi = weight / ((height/100) ** 2);
        const weightDiff = weight - targetWeight;
        const absWeightDiff = Math.abs(weightDiff).toFixed(1);
        
        let message = "";
        if (bmi < 18.5) {
          message = "현재 저체중이십니다. 영양가 있는 식단으로 건강하게 체중을 늘리는 것이 중요해요.";
        } else if (bmi < 25) {
          message = "정상 체중을 유지하고 계시네요! 지금의 건강한 습관을 계속 이어나가세요.";
        } else if (bmi < 30) {
          message = "과체중이십니다. 꾸준한 운동과 식단 조절을 통해 건강한 체중으로 돌아가세요.";
        } else {
          message = "비만으로 분류됩니다. 전문가와 상담하여 체계적인 관리를 시작하는 것을 추천합니다.";
        }

        if (weightDiff > 0) {
          message += ` 목표 체중보다 ${absWeightDiff}kg 초과 상태입니다.`;
        } else if (weightDiff < 0) {
          message += ` 목표까지 ${absWeightDiff}kg 남았습니다. 거의 다 왔어요!`;
        } else {
          message += " 목표 체중에 완벽하게 도달하셨습니다! 정말 대단해요!";
        }

        if (bodyType === "근육형") {
          message += " 체중계의 숫자보다 체지방률 관리가 더 중요할 수 있습니다.";
        } else if (bodyType === "마른 비만") {
          message += " 체지방을 줄이고 근육을 늘리는 것이 핵심입니다.";
        }

        return message;
      };
      setInsight(getInsight());
    }, [memberData, baseData]);

    return (
      <div className="p-4 bg-white/5 rounded-xl text-white/80 border border-white/10">
        <h4 className="text-sm font-semibold mb-2 flex items-center">
          <i className="fas fa-brain mr-2 text-blue-300"></i>AI 건강 인사이트
        </h4>
        <p className="text-sm">{insight}</p>
      </div>
    );
  };


  // 가족 구성원 카드 컴포넌트
  const FamilyMember = ({ memberData, onUpdate, baseData, setToast }) => {
    const [localData, setLocalData] = useState(memberData);
    const [isSaving, setIsSaving] = useState(false);
    const [showDetails, setShowDetails] = useState(false);
    const timeoutRef = useRef(null);

    useEffect(() => {
      setLocalData(memberData);
    }, [memberData]);

    const saveDataToFirestore = async (data) => {
      const { id } = baseData;
      const docRef = db.collection("family").doc(id);

      const heightM = baseData.height / 100;
      const newBmi = data.weight ? (data.weight / (heightM * heightM)).toFixed(1) : null;
      const today = new Date().toISOString().split("T")[0];

      await docRef.set({
        weight: parseFloat(data.weight),
        targetWeight: parseFloat(data.targetWeight),
        bodyType: data.bodyType,
        lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
      }, { merge: true });

      if (data.weight) {
        await docRef.collection("logs").doc(today).set({
          date: today,
          weight: parseFloat(data.weight),
          bmi: parseFloat(newBmi)
        });
      }
    };
    
    const handleChange = (field, value) => {
        setLocalData(prev => ({ ...prev, [field]: value }));
        clearTimeout(timeoutRef.current);
        timeoutRef.current = setTimeout(() => {
            handleSave();
        }, 1500);
    };

    const handleSave = async () => {
      if (isSaving) return;
      setIsSaving(true);
      try {
        await saveDataToFirestore(localData);
        setToast({ message: "데이터가 성공적으로 저장되었습니다. ✅", type: "success" });
      } catch (e) {
        console.error("Save failed:", e);
        setToast({ message: "데이터 저장 실패. 다시 시도해주세요. ❌", type: "error" });
      } finally {
        setIsSaving(false);
      }
    };

    // BMI 계산 (NaN 방지)
    const heightM = baseData.height && baseData.height > 0 ? baseData.height / 100 : null;
    const currentBmi =
      heightM && localData.weight && localData.weight > 0
        ? localData.weight / (heightM * heightM)
        : 0;
    const targetBmi =
      heightM && localData.targetWeight
        ? localData.targetWeight / (heightM * heightM)
        : 0;
    const bmiDifference = targetBmi ? targetBmi - currentBmi : null;

    // BMI 상태 카테고리
    const getBmiCategory = (bmi) => {
      if (!bmi || bmi <= 0) return { text: '미입력', icon: '❔', color: '#999' };
      if (bmi < 18.5) return { text: '저체중', icon: '📉', color: '#4facfe' };
      if (bmi < 25) return { text: '정상', icon: '✅', color: '#43e97b' };
      if (bmi < 30) return { text: '과체중', icon: '⚠️', color: '#feca57' };
      return { text: '비만', icon: '🔴', color: '#ff6b6b' };
    };
    const bmiCategory = getBmiCategory(currentBmi);

    // 진행률 계산 (0~100 사이로 제한)
    const initialWeight = baseData.weight;
    const targetWeight = localData.targetWeight;
    const currentWeight = localData.weight;
    let progress = 0;
    if (targetWeight && initialWeight && initialWeight !== targetWeight) {
      progress = ((currentWeight - initialWeight) / (targetWeight - initialWeight)) * 100;
    }
    progress = Math.min(100, Math.max(0, progress));

    return (
      <div className="glassmorphism rounded-3xl p-6 card-hover fade-in">
        {/* Header */}
        <div className="flex items-center justify-between mb-6">
          <div className="flex items-center space-x-4">
            <div className="text-6xl hover:scale-110 transition-transform cursor-pointer">
              {baseData.emoji}
            </div>
            <div>
              <h2 className="text-2xl font-bold text-white mb-1">{baseData.name}</h2>
              <div className="flex flex-wrap gap-2 text-xs mt-2">
                <span className="bg-white/10 px-2 py-1 rounded-full text-white/80">
                  <i className="fas fa-birthday-cake mr-1"></i>{baseData.age}세
                </span>
                <span className="bg-white/10 px-2 py-1 rounded-full text-white/80">
                  <i className="fas fa-ruler-vertical mr-1"></i>{baseData.height}cm
                </span>
                <span className="bg-white/10 px-2 py-1 rounded-full text-white/80">
                  <i className="fas fa-briefcase mr-1"></i>{baseData.profession}
                </span>
              </div>
            </div>
          </div>
        </div>

        {/* BMI Status */}
        <div className="grid grid-cols-2 gap-6 mb-6">
          <div className="text-center">
            <CircularProgress 
              value={currentBmi} 
              maxValue={35} 
              color={bmiCategory.color}
            />
            <p className="text-white/80 text-sm mt-3 font-medium">현재 BMI</p>
          </div>
          <div className="space-y-3">
            <div className={`${bmiCategory.class} rounded-xl p-4 text-center`}>
              <div className="text-white font-bold text-lg mb-1">
                {bmiCategory.icon} {bmiCategory.text}
              </div>
              <div className="text-white/90 text-sm">BMI {currentBmi.toFixed(1)}</div>
            </div>
            {targetBmi > 0 && (
              <div className="bg-white/10 rounded-xl p-3 text-center">
                <div className="text-white/80 text-sm">목표: {targetBmi.toFixed(1)}</div>
                <div className="text-white/60 text-xs">
                  {bmiDifference > 0 ? '↑' : '↓'} {Math.abs(bmiDifference).toFixed(1)}
                </div>
              </div>
            )}
          </div>
        </div>

        <button 
          onClick={() => setShowDetails(!showDetails)}
          className="w-full py-3 bg-white/20 text-white font-semibold rounded-2xl mb-4 hover:bg-white/30 transition-all transform hover:scale-105"
        >
          {showDetails ? (
            <span><i className="fas fa-chevron-up mr-2"></i>접기</span>
          ) : (
            <span><i className="fas fa-chevron-down mr-2"></i>상세 보기</span>
          )}
        </button>

        {/* Details */}
        {showDetails && (
          <div className="space-y-6 slide-up">
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label className="flex items-center text-white/80 font-medium mb-2 text-sm">
                  <i className="fas fa-weight-scale mr-2"></i>초기 체중 (kg)
                </label>
                <p className="w-full p-3 bg-white/10 rounded-xl text-white/80 backdrop-blur-sm">
                  {initialWeight} kg
                </p>
              </div>
              <div>
                <label className="flex items-center text-white/80 font-medium mb-2 text-sm">
                  <i className="fas fa-bullseye mr-2"></i>목표 체중 (kg)
                </label>
                <input 
                  type="number" 
                  value={localData.targetWeight || ''} 
                  onChange={e => handleChange('targetWeight', e.target.value)} 
                  step="0.1" 
                  className="w-full p-3 bg-white/10 border border-white/20 rounded-xl text-white placeholder-white/50 backdrop-blur-sm focus:outline-none focus:border-white/50 focus:bg-white/15 transition-all"
                  placeholder="목표 체중"
                />
              </div>
              <div>
                <label className="flex items-center text-white/80 font-medium mb-2 text-sm">
                  <i className="fas fa-weight-hanging mr-2"></i>현재 체중 (kg)
                </label>
                <input 
                  type="number" 
                  value={localData.weight || ''} 
                  onChange={e => handleChange('weight', e.target.value)} 
                  step="0.1" 
                  className="w-full p-3 bg-white/10 border border-white/20 rounded-xl text-white placeholder-white/50 backdrop-blur-sm focus:outline-none focus:border-white/50 focus:bg-white/15 transition-all"
                  placeholder="체중 입력"
                />
              </div>
              <div>
                <label className="flex items-center text-white/80 font-medium mb-2 text-sm">
                  <i className="fas fa-percentage mr-2"></i>목표 진행률 (%)
                </label>
                <p className="w-full p-3 bg-white/10 rounded-xl text-white backdrop-blur-sm">
                  {progress.toFixed(1)} %
                </p>
              </div>
              <div>
                  <label className="flex items-center text-white/80 font-medium mb-2 text-sm">
                    <i className="fas fa-dumbbell mr-2"></i>체형
                  </label>
                  <select 
                    value={localData.bodyType || '보통'} 
                    onChange={e => handleChange('bodyType', e.target.value)} 
                    className="w-full p-3 bg-white/10 border border-white/20 rounded-xl text-white backdrop-blur-sm focus:outline-none focus:border-white/50 focus:bg-white/15 transition-all"
                  >
                    <option value="보통">보통</option>
                    <option value="근육형">근육형</option>
                    <option value="마른 비만">마른 비만</option>
                    <option value="마른 체형">마른 체형</option>
                    <option value="과체중">과체중</option>
                  </select>
              </div>
            </div>

            {/* AI Insights */}
            <HealthInsights memberData={localData} baseData={baseData} />

            {/* Save Button */}
            <button 
              onClick={handleSave} 
              disabled={isSaving}
              className="w-full py-4 bg-gradient-to-r from-green-400 to-blue-500 text-white font-bold rounded-2xl neon-glow hover:from-green-500 hover:to-blue-600 disabled:opacity-50 transition-all transform hover:scale-105"
            >
              {isSaving ? (
                <div className="flex items-center justify-center space-x-2">
                  <div className="animate-spin rounded-full h-5 w-5 border-2 border-white border-t-transparent"></div>
                  <span>저장 중...</span>
                </div>
              ) : (
                <span>
                  <i className="fas fa-save mr-2"></i>
                  데이터 저장하기
                </span>
              )}
            </button>
          </div>
        )}
      </div>
    );
  };

  // Main App Component
  const App = () => {
    const [hasAccess, setHasAccess] = useState(false);
    const [data, setData] = useState(initialFamilyData);
    const [authReady, setAuthReady] = useState(false);
    const [toast, setToast] = useState(null);

    // Firestore 실시간 데이터
    useEffect(() => {
      const unsub = db.collection("family").onSnapshot(snapshot => {
        const newData = { ...initialFamilyData };
        snapshot.forEach(doc => { newData[doc.id] = { ...newData[doc.id], ...doc.data() }; });
        setData(newData);
      });
      return () => unsub();
    }, []);

    useEffect(() => {
      if (toast) {
        const timer = setTimeout(() => setToast(null), 3000);
        return () => clearTimeout(timer);
      }
    }, [toast]);
    
    if (!hasAccess) {
      return <PasswordGate onAccess={setHasAccess} />;
    }
    
    return (
      <div className="min-h-screen animated-bg">
        {toast && <ToastMessage message={toast.message} type={toast.type} onClose={() => setToast(null)} />}
        <div className="p-4 md:p-8 lg:p-12 text-white">
          <header className="text-center py-8">
            <h1 className="text-5xl md:text-6xl font-extrabold mb-2 gradient-text">
              Ultimate Health Dashboard
            </h1>
            <p className="text-lg md:text-xl font-medium text-white/80">
              <i className="fas fa-heartbeat mr-2 pulse"></i> 우리 가족 건강 관리
            </p>
          </header>
          <div className="fade-in">
            <div className="grid gap-8 mb-12 lg:grid-cols-2 xl:grid-cols-4">
              {Object.keys(data).map(id => (
                <FamilyMember
                  key={id}
                  memberData={data[id]}
                  onUpdate={() => {}} // Placeholder, logic is in handleSave
                  baseData={initialFamilyData[id]}
                  setToast={setToast}
                />
              ))}
            </div>
            <div className="w-full h-[400px] glassmorphism p-4 rounded-3xl">
              <AdvancedBMIChart familyHealthData={data} />
            </div>
          </div>
          <footer className="text-center text-white/50 text-sm mt-12 py-4 border-t border-white/20">
            © 2025. 수아동혁가족. All Rights Reserved.
          </footer>
        </div>
      </div>
    );
  };

  // Chart.js Component
  const AdvancedBMIChart = ({ familyHealthData }) => {
    const canvasRef = useRef(null);
    const chartRef = useRef(null);

    useEffect(() => {
      if (!familyHealthData || Object.keys(familyHealthData).length === 0) return;
      
      const ctx = canvasRef.current.getContext('2d');
      
      if (chartRef.current) {
          chartRef.current.destroy();
      }

      const labels = Object.values(familyHealthData).map(member => member.name);
      const currentBmis = Object.values(familyHealthData).map(member => {
        const heightM = initialFamilyData[member.id].height / 100;
        return member.weight ? (member.weight / (heightM * heightM)) : 0;
      });
      const targetBmis = Object.values(initialFamilyData).map(member => member.recommendedBMI);
      
      chartRef.current = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: '현재 BMI',
            data: currentBmis,
            backgroundColor: [
              'rgba(75, 192, 192, 0.6)', 
              'rgba(255, 159, 64, 0.6)', 
              'rgba(54, 162, 235, 0.6)', 
              'rgba(153, 102, 255, 0.6)'
            ],
            borderColor: [
              'rgba(75, 192, 192, 1)', 
              'rgba(255, 159, 64, 1)', 
              'rgba(54, 162, 235, 1)', 
              'rgba(153, 102, 255, 1)'
            ],
            borderWidth: 1
          },
          {
            label: '목표 BMI',
            data: targetBmis,
            backgroundColor: 'rgba(255, 255, 255, 0.2)',
            borderColor: 'rgba(255, 255, 255, 0.8)',
            borderWidth: 2,
            type: 'line',
            fill: false,
            datalabels: {
              display: false
            }
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              labels: { color: 'white' }
            },
            title: {
              display: true,
              text: '가족 BMI 추이',
              color: 'white',
              font: { size: 18, family: 'Noto Sans KR' }
            },
            datalabels: {
              color: 'white',
              anchor: 'end',
              align: 'top',
              formatter: (value) => value.toFixed(1)
            }
          },
          scales: {
            x: {
              ticks: { color: 'white' },
              grid: { color: 'rgba(255, 255, 255, 0.2)' }
            },
            y: {
              ticks: { color: 'white' },
              grid: { color: 'rgba(255, 255, 255, 0.2)' },
              min: 15, max: 35
            }
          }
        },
        plugins: [ChartDataLabels]
      });

      return () => {
        if (chartRef.current) {
          chartRef.current.destroy();
        }
      };
    }, [familyHealthData]);

    return <canvas ref={canvasRef} />;
  };

  const root = ReactDOM.createRoot(document.getElementById('root'));
  root.render(<App />);
</script>
</body>
</html>
비만</option>
                      <option value="마른 체형">마른 체형</option>
                      <option value="과체중">과체중</option>
                    </select>
                </div>
              </div>

              {/* AI Insights */}
              <HealthInsights memberData={localData} baseData={baseData} />

              {/* Save Button */}
              <button 
                onClick={handleSave} 
                disabled={isSaving}
                className="w-full py-4 bg-gradient-to-r from-green-400 to-blue-500 text-white font-bold rounded-2xl sparkle hover:from-green-500 hover:to-blue-600 disabled:opacity-50 transition-all transform hover:scale-105 neon-glow"
              >
                {isSaving ? (
                  <div className="flex items-center justify-center space-x-2">
                    <div className="animate-spin rounded-full h-5 w-5 border-2 border-white border-t-transparent"></div>
                    <span>저장 중...</span>
                  </div>
                ) : (
                  <span>
                    <i className="fas fa-save mr-2"></i>
                    데이터 저장하기
                  </span>
                )}
              </button>
            </div>
          )}
        </div>
      );
    };

    // Main App Component
    const App = () => {
      const [hasAccess, setHasAccess] = useState(false);
      const [data, setData] = useState(initialFamilyData);
      const [authReady, setAuthReady] = useState(false);
      const [userId, setUserId] = useState(null);
      const [toast, setToast] = useState(null);

      // Firebase authentication and data listener setup
      useEffect(() => {
        if (!window.firebase) {
            console.error("Firebase is not loaded.");
            return;
        }

        const { auth, initialAuthToken, signInWithCustomToken, signInAnonymously, onAuthStateChanged, db, appId, collection, onSnapshot } = window.firebase;
        
        // Listen for auth state changes
        const unsubscribeAuth = onAuthStateChanged(auth, async (user) => {
            if (user) {
                setUserId(user.uid);
                setAuthReady(true);
                // Listen for changes in the user's data
                const userHealthRef = collection(db, `artifacts/${appId}/users/${user.uid}/health-data`);
                const unsubscribeSnapshot = onSnapshot(userHealthRef, (snapshot) => {
                    if (!snapshot.empty) {
                        const firebaseData = {};
                        snapshot.docs.forEach(doc => {
                            firebaseData[doc.id] = doc.data();
                        });
                        // Merge initial data with data from Firestore
                        setData(prevData => {
                           const updatedData = { ...prevData };
                           Object.keys(firebaseData).forEach(id => {
                               updatedData[id] = { ...updatedData[id], ...firebaseData[id] };
                           });
                           return updatedData;
                        });
                    }
                }, (error) => {
                    console.error("Failed to listen for data updates:", error);
                    setToast({ message: "데이터 로딩 오류. 새로고침을 시도하세요.", type: "error" });
                });
                return () => unsubscribeSnapshot();
            } else {
                setAuthReady(true);
                setUserId(null);
            }
        }, (error) => {
            console.error("Authentication failed:", error);
            setAuthReady(true);
        });
        
        // Sign in with custom token or anonymously
        const authLogin = async () => {
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Authentication error during login:", error);
            }
        };

        if (auth && !auth.currentUser) {
            authLogin();
        }

        return () => unsubscribeAuth();
      }, []);

      useEffect(() => {
        if (toast) {
          const timer = setTimeout(() => setToast(null), 3000);
          return () => clearTimeout(timer);
        }
      }, [toast]);
      
      if (!hasAccess) {
        return <PasswordGate onAccess={setHasAccess} />;
      }
      
      return (
        <div className="min-h-screen animated-bg">
          {toast && <ToastMessage message={toast.message} type={toast.type} onClose={() => setToast(null)} />}
          <div className="p-4 md:p-8 lg:p-12 text-white">
            <header className="text-center py-8">
              <h1 className="text-5xl md:text-6xl font-extrabold mb-2 gradient-text">
                Ultimate Health Dashboard
              </h1>
              <p className="text-lg md:text-xl font-medium text-white/80">
                <i className="fas fa-heartbeat mr-2 pulse"></i> 우리 가족 건강 관리
              </p>
              {userId && (
                  <div className="text-xs text-white/50 mt-2 break-all">User ID: {userId}</div>
              )}
            </header>
            <div className="fade-in">
              <div className="grid gap-8 mb-12 lg:grid-cols-2 xl:grid-cols-4">
                {Object.keys(data).map(id => (
                  <FamilyMember
                    key={id}
                    memberData={data[id]}
                    onUpdate={() => {}} // Placeholder, logic is in handleSave
                    baseData={initialFamilyData[id]}
                    setToast={setToast}
                    auth={window.firebase.auth}
                  />
                ))}
              </div>
              <div className="w-full h-[400px] glassmorphism p-4 rounded-3xl">
                {authReady ? (
                  <AdvancedBMIChart familyHealthData={data} initialData={initialFamilyData} />
                ) : (
                  <div className="flex items-center justify-center w-full h-full text-white/70">
                    <div className="animate-spin rounded-full h-10 w-10 border-4 border-white border-t-transparent mr-4"></div>
                    데이터를 불러오는 중입니다...
                  </div>
                )}
              </div>
            </div>
            <footer className="text-center text-white/50 text-sm mt-12 py-4 border-t border-white/20">
              © 2025. 수아동혁가족. All Rights Reserved.
              <div className="mt-2 text-xs break-all">이 앱은 파이어베이스 데이터베이스에 데이터를 저장합니다.</div>
            </footer>
          </div>
        </div>
      );
    };

    // Chart.js Component
    const AdvancedBMIChart = ({ familyHealthData, initialData }) => {
      const canvasRef = useRef(null);
      const chartRef = useRef(null);

      useEffect(() => {
        if (!familyHealthData || Object.keys(familyHealthData).length === 0) return;
        
        const ctx = canvasRef.current.getContext('2d');
        
        if (chartRef.current) {
            chartRef.current.destroy();
        }

        const labels = Object.values(familyHealthData).map(member => member.name);
        const currentBmis = Object.values(familyHealthData).map(member => {
          const heightM = initialData[member.id].height / 100;
          return member.weight ? (member.weight / (heightM * heightM)) : 0;
        });
        
        const targetBmis = Object.values(initialData).map(member => member.recommendedBMI);
        
        const progressPercentages = Object.values(familyHealthData).map(member => {
          const initialWeight = initialData[member.id].weight;
          const targetWeight = member.targetWeight;
          const currentWeight = member.weight;
          
          if (!targetWeight || initialWeight === targetWeight) {
            return null;
          }
          
          let progress = ((currentWeight - initialWeight) / (targetWeight - initialWeight)) * 100;
          progress = Math.min(100, Math.max(0, progress));
          return progress;
        });

        chartRef.current = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: labels,
            datasets: [{
              label: '현재 BMI',
              data: currentBmis,
              backgroundColor: [
                'rgba(75, 192, 192, 0.6)', 
                'rgba(255, 159, 64, 0.6)', 
                'rgba(54, 162, 235, 0.6)', 
                'rgba(153, 102, 255, 0.6)'
              ],
              borderColor: [
                'rgba(75, 192, 192, 1)', 
                'rgba(255, 159, 64, 1)', 
                'rgba(54, 162, 235, 1)', 
                'rgba(153, 102, 255, 1)'
              ],
              borderWidth: 1,
              datalabels: {
                color: 'white',
                anchor: 'end',
                align: 'top',
                offset: 5,
                formatter: (value) => value > 0 ? value.toFixed(1) : ''
              }
            },
            {
              label: '목표 BMI',
              data: targetBmis,
              backgroundColor: 'rgba(255, 255, 255, 0.2)',
              borderColor: 'rgba(255, 255, 255, 0.8)',
              borderWidth: 2,
              type: 'line',
              fill: false,
              datalabels: {
                display: false
              }
            },
            {
              label: '목표 달성률 (%)',
              data: progressPercentages,
              type: 'line',
              fill: false,
              borderColor: '#f5576c',
              borderWidth: 2,
              borderDash: [5, 5],
              pointBackgroundColor: '#f5576c',
              datalabels: {
                color: '#f5576c',
                anchor: 'start',
                align: 'end',
                offset: 10,
                formatter: (value) => {
                  return value !== null ? `${value.toFixed(0)}%` : '';
                }
              }
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                labels: { color: 'white' }
              },
              title: {
                display: true,
                text: '가족 BMI 및 목표 달성률',
                color: 'white',
                font: { size: 18, family: 'Noto Sans KR' }
              }
            },
            scales: {
              x: {
                ticks: { color: 'white' },
                grid: { color: 'rgba(255, 255, 255, 0.2)' }
              },
              y: {
                ticks: { color: 'white' },
                grid: { color: 'rgba(255, 255, 255, 0.2)' },
                min: 15, max: 35
              }
            }
          },
          plugins: [ChartDataLabels]
        });

        return () => {
          if (chartRef.current) {
            chartRef.current.destroy();
          }
        };
      }, [familyHealthData]);

      return <canvas ref={canvasRef} />;
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>               onUpdate={updateData}
                      baseData={initialFamilyData[id]}
                      setToast={setToast}
                    />
                  ))}
                </div>
                <div className="w-full h-[400px] glassmorphism p-4 rounded-3xl">
                  <AdvancedBMIChart familyHealthData={data} />
                </div>
              </div>
            )}
            <footer className="text-center text-white/50 text-sm mt-12 py-4 border-t border-white/20">
              © 2025. 수아동혁가족. All Rights Reserved.
              <div className="mt-2 text-xs break-all">User ID: {displayUserId}</div>
            </footer>
          </div>
        </div>
      );
    };

    // Chart.js Component
    const AdvancedBMIChart = ({ familyHealthData }) => {
      const canvasRef = useRef(null);
      const chartRef = useRef(null);

      useEffect(() => {
        if (!familyHealthData || Object.keys(familyHealthData).length === 0) return;
        
        const ctx = canvasRef.current.getContext('2d');
        
        if (chartRef.current) {
            chartRef.current.destroy();
        }

        const labels = Object.values(familyHealthData).map(member => member.name);
        const currentBmis = Object.values(familyHealthData).map(member => {
          const heightM = initialFamilyData[member.id].height / 100;
          return member.weight ? (member.weight / (heightM * heightM)) : 0;
        });
        const targetBmis = Object.values(initialFamilyData).map(member => member.recommendedBMI);
        
        chartRef.current = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: labels,
            datasets: [{
              label: '현재 BMI',
              data: currentBmis,
              backgroundColor: [
                'rgba(75, 192, 192, 0.6)', 
                'rgba(255, 159, 64, 0.6)', 
                'rgba(54, 162, 235, 0.6)', 
                'rgba(153, 102, 255, 0.6)'
              ],
              borderColor: [
                'rgba(75, 192, 192, 1)', 
                'rgba(255, 159, 64, 1)', 
                'rgba(54, 162, 235, 1)', 
                'rgba(153, 102, 255, 1)'
              ],
              borderWidth: 1
            },
            {
              label: '목표 BMI',
              data: targetBmis,
              backgroundColor: 'rgba(255, 255, 255, 0.2)',
              borderColor: 'rgba(255, 255, 255, 0.8)',
              borderWidth: 2,
              type: 'line',
              fill: false,
              datalabels: {
                display: false
              }
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                labels: { color: 'white' }
              },
              title: {
                display: true,
                text: '가족 BMI 추이',
                color: 'white',
                font: { size: 18, family: 'Noto Sans KR' }
              },
              datalabels: {
                color: 'white',
                anchor: 'end',
                align: 'top',
                formatter: (value) => value.toFixed(1)
              }
            },
            scales: {
              x: {
                ticks: { color: 'white' },
                grid: { color: 'rgba(255, 255, 255, 0.2)' }
              },
              y: {
                ticks: { color: 'white' },
                grid: { color: 'rgba(255, 255, 255, 0.2)' },
                min: 15, max: 35
              }
            }
          },
          plugins: [ChartDataLabels]
        });

        return () => {
          if (chartRef.current) {
            chartRef.current.destroy();
          }
        };
      }, [familyHealthData]);

      return <canvas ref={canvasRef} />;
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>