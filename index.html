<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>우리 가족 건강 대시보드</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
    <script type="module">
        import { initializeApp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, collection, addDoc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        let app = null;
        let db = null;
        let auth = null;
        let chart = null;
        let userId = null;
        let userHealthDataRef = null;
        let userWeightGoalsRef = null;
        let userLastInputsRef = null;

        // Function: Show custom modal
        function showCustomModal(message, type = 'success') {
            const modal = document.getElementById('custom-modal');
            const modalMessage = document.getElementById('modal-message');
            const modalIcon = document.getElementById('modal-icon');
            
            modalMessage.textContent = message;
            modalIcon.className = '';
            
            if (type === 'success') {
                modalIcon.classList.add('text-green-500', 'fa-solid', 'fa-circle-check');
            } else if (type === 'error') {
                modalIcon.classList.add('text-red-500', 'fa-solid', 'fa-circle-exclamation');
            }
            
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            
            setTimeout(() => {
                modal.classList.remove('flex');
                modal.classList.add('hidden');
            }, 3000);
        }

        // Function: Format date
        function formatDate(date) {
            const d = new Date(date);
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // Function: Calculate BMI
        function calculateBMI(weight, height) {
            if (!weight || !height) return 0;
            const heightInMeters = height / 100;
            return (weight / (heightInMeters * heightInMeters)).toFixed(2);
        }

        // Function: Render chart
        function renderChart(data) {
            const ctx = document.getElementById('healthChart').getContext('2d');
            if (chart) chart.destroy();
            
            const labels = data.map(item => item.date);
            const weights = data.map(item => item.weight);
            const bmis = data.map(item => item.bmi);
            
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '체중 (kg)',
                        data: weights,
                        borderColor: '#38a169',
                        tension: 0.1,
                        fill: false,
                        yAxisID: 'y'
                    }, {
                        label: 'BMI 지수',
                        data: bmis,
                        borderColor: '#4299e1',
                        tension: 0.1,
                        fill: false,
                        yAxisID: 'y1'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: '체중 (kg)',
                                color: '#a0aec0'
                            },
                            ticks: {
                                color: '#a0aec0'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'BMI 지수',
                                color: '#a0aec0'
                            },
                            ticks: {
                                color: '#a0aec0'
                            },
                            grid: {
                                drawOnChartArea: false
                            }
                        },
                        x: {
                            ticks: {
                                color: '#a0aec0'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: '#a0aec0'
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.7)',
                            titleColor: '#fff',
                            bodyColor: '#fff'
                        },
                        datalabels: {
                            display: false,
                        }
                    }
                }
            });
        }

        // Function: Load health data
        async function loadHealthData() {
            if (!userHealthDataRef || !userWeightGoalsRef) {
                console.error("Firebase references not initialized.");
                return;
            }

            const dataContainer = document.getElementById('data-container');
            const goalsContainer = document.getElementById('goals-container');
            
            onSnapshot(userHealthDataRef, (healthSnapshot) => {
                const healthData = [];
                healthSnapshot.forEach((doc) => {
                    healthData.push({ ...doc.data(), id: doc.id });
                });
                
                healthData.sort((a, b) => new Date(a.date) - new Date(b.date));
                
                // Update UI
                dataContainer.innerHTML = '';
                healthData.forEach(item => {
                    const row = document.createElement('div');
                    row.className = 'grid grid-cols-5 sm:grid-cols-7 gap-2 items-center bg-[#2d3748] p-3 rounded-lg shadow-md mb-2';
                    row.innerHTML = `
                        <div class="col-span-1 text-sm sm:text-base text-gray-300">${item.date}</div>
                        <div class="col-span-1 text-sm sm:text-base text-white text-center">${item.name}</div>
                        <div class="col-span-1 text-sm sm:text-base text-white text-center">${item.gender || 'N/A'}</div>
                        <div class="col-span-1 text-sm sm:text-base text-white text-center">${item.bodyType || 'N/A'}</div>
                        <div class="col-span-1 text-sm sm:text-base text-white text-center">${item.weight} kg</div>
                        <div class="col-span-1 text-sm sm:text-base text-white text-center">${item.height} cm</div>
                        <div class="col-span-1 text-sm sm:text-base text-white font-bold text-center">${item.bmi}</div>
                    `;
                    dataContainer.appendChild(row);
                });

                // Update chart
                renderChart(healthData);

                // Load and calculate goal achievement rate
                onSnapshot(userWeightGoalsRef, (goalsSnapshot) => {
                    const goalsData = {};
                    goalsSnapshot.forEach(doc => {
                        const data = doc.data();
                        goalsData[data.name] = data;
                    });

                    goalsContainer.innerHTML = '';
                    const members = [...new Set(healthData.map(item => item.name))];

                    members.forEach(name => {
                        const memberData = healthData.filter(item => item.name === name);
                        if (memberData.length > 0) {
                            const initialWeight = memberData[0].weight;
                            const currentWeight = memberData[memberData.length - 1].weight;
                            const goal = goalsData[name];

                            let achievementRate = 0;
                            // Achievement rate calculation logic: (Initial weight - current weight) / (Initial weight - goal weight) * 100
                            if (goal && initialWeight !== goal.goalWeight) {
                                achievementRate = ((initialWeight - currentWeight) / (initialWeight - goal.goalWeight) * 100).toFixed(1);
                                if (achievementRate < 0) achievementRate = 0;
                                if (achievementRate > 100) achievementRate = 100;
                            }

                            const goalText = goal ? `목표: ${goal.goalWeight} kg` : '목표 설정 필요';
                            const rateText = goal ? `${achievementRate}% 달성` : '';
                            const rateColor = achievementRate >= 100 ? 'text-green-500' : 'text-yellow-500';

                            const goalCard = document.createElement('div');
                            goalCard.className = 'bg-[#2d3748] p-4 rounded-xl shadow-md text-center';
                            goalCard.innerHTML = `
                                <h3 class="text-xl font-bold mb-2">${name}</h3>
                                <p class="text-gray-300">현재 체중: ${currentWeight} kg</p>
                                <p class="text-gray-300">${goalText}</p>
                                <p class="text-2xl font-bold mt-2 ${rateColor}">${rateText}</p>
                            `;
                            goalsContainer.appendChild(goalCard);
                        }
                    });
                });
            });
        }
        
        // Function: Load last entered inputs
        async function loadLastInputs() {
            if (!userLastInputsRef) {
                console.error("Firebase reference for last inputs is not initialized.");
                return;
            }

            try {
                const docSnap = await getDoc(doc(userLastInputsRef, 'lastEntry'));
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    document.getElementById('memberName').value = data.name || '';
                    document.getElementById('memberGender').value = data.gender || '남성';
                    document.getElementById('memberBodyType').value = data.bodyType || '보통';
                    document.getElementById('memberHeight').value = data.height || '';
                    document.getElementById('memberGoalWeight').value = data.goalWeight || '';
                    console.log("Last inputs loaded successfully.");
                } else {
                    console.log("No last inputs found.");
                }
            } catch (e) {
                console.error("Error loading last inputs:", e);
            }
        }

        // Function: Add health data
        async function addHealthData() {
            if (!userHealthDataRef || !userWeightGoalsRef || !userLastInputsRef) {
                showCustomModal('데이터 저장에 실패했습니다. Firebase가 초기화되지 않았습니다.', 'error');
                return;
            }
            
            const name = document.getElementById('memberName').value;
            const gender = document.getElementById('memberGender').value;
            const bodyType = document.getElementById('memberBodyType').value;
            const weight = parseFloat(document.getElementById('memberWeight').value);
            const height = parseFloat(document.getElementById('memberHeight').value);
            const goalWeight = document.getElementById('memberGoalWeight').value ? parseFloat(document.getElementById('memberGoalWeight').value) : null;
            
            if (!name || !weight || !height) {
                showCustomModal('이름, 체중, 키를 모두 입력해주세요.', 'error');
                return;
            }

            const bmi = calculateBMI(weight, height);
            const date = formatDate(new Date());

            const newHealthData = {
                name,
                gender,
                bodyType,
                weight,
                height,
                bmi,
                date,
                userId: userId,
            };

            try {
                await addDoc(userHealthDataRef, newHealthData);
                
                if (goalWeight !== null) {
                    const goalDocRef = doc(userWeightGoalsRef, name);
                    await setDoc(goalDocRef, {
                        name: name,
                        goalWeight: goalWeight,
                        userId: userId,
                    }, { merge: true }); // Update if goal exists
                }

                // Save last inputs for the user
                const lastInputDocRef = doc(userLastInputsRef, 'lastEntry');
                await setDoc(lastInputDocRef, {
                    name,
                    gender,
                    bodyType,
                    height,
                    goalWeight,
                });
                
                document.getElementById('memberWeight').value = '';
                showCustomModal('건강 데이터가 성공적으로 저장되었습니다.', 'success');
            } catch (e) {
                console.error("Error adding data: ", e);
                showCustomModal('데이터 저장 중 오류가 발생했습니다.', 'error');
            }
        }

        // Firebase initialization
        if (firebaseConfig.apiKey) {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            setLogLevel('debug');
            console.log("Firebase initialized.");
            
            // Authentication state detection and data loading
            onAuthStateChanged(auth, async (user) => {
                const userIdDisplay = document.getElementById('userIdDisplay');
                if (user) {
                    userId = user.uid;
                    userIdDisplay.textContent = `사용자 ID: ${userId}`;
                    console.log(`User signed in with ID: ${userId}`);
                    userHealthDataRef = collection(db, `artifacts/${appId}/public/data/healthData`);
                    userWeightGoalsRef = collection(db, `artifacts/${appId}/public/data/weightGoals`);
                    userLastInputsRef = collection(db, `artifacts/${appId}/users/${userId}/lastInputs`);
                    await loadHealthData();
                    await loadLastInputs();

                    // Add event listener only after Firebase is ready
                    document.getElementById('addBtn').addEventListener('click', addHealthData);
                    console.log("Add button event listener attached.");
                } else {
                    userIdDisplay.textContent = '사용자 ID: (로그인 중...)';
                    console.log("User signed out, signing in anonymously...");
                    try {
                        if (typeof __initial_auth_token !== 'undefined') {
                            await signInWithCustomToken(auth, __initial_auth_token);
                            console.log("Signed in with custom token.");
                        } else {
                            await signInAnonymously(auth);
                            console.log("Signed in anonymously.");
                        }
                    } catch (error) {
                        console.error("Authentication error:", error);
                    }
                }
            });
        } else {
            console.error("Firebase config is missing. Please provide the firebase_config variable.");
            const userIdDisplay = document.getElementById('userIdDisplay');
            userIdDisplay.textContent = 'Firebase 설정 오류';
        }
    </script>
</head>

<body class="bg-[#1a202c] text-white font-[Inter]">
    <div class="container mx-auto px-4 py-8 max-w-4xl">
        <header class="text-center mb-8">
            <h1 class="text-4xl sm:text-5xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-green-400 to-blue-500 mb-2">우리 가족 건강 대시보드</h1>
            <p class="text-gray-400 text-lg">가족 구성원의 체중과 BMI 변화를 추적하세요.</p>
            <div id="userIdDisplay" class="mt-2 text-sm text-gray-500 break-words"></div>
        </header>

        <!-- Data input form -->
        <div class="bg-[#2d3748] rounded-xl p-6 shadow-xl mb-8">
            <h2 class="text-2xl font-bold mb-4 text-center">건강 데이터 추가하기</h2>
            <form id="dataForm" class="grid grid-cols-1 md:grid-cols-6 gap-4 items-end">
                <div class="flex flex-col">
                    <label for="memberName" class="text-gray-300 mb-2">이름 (예: 철수)</label>
                    <input type="text" id="memberName" placeholder="예: 철수" class="bg-[#1e2a38] text-white border border-[#4a5568] rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="flex flex-col">
                    <label for="memberGender" class="text-gray-300 mb-2">성별</label>
                    <select id="memberGender" class="bg-[#1e2a38] text-white border border-[#4a5568] rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="남성">남성</option>
                        <option value="여성">여성</option>
                    </select>
                </div>
                <div class="flex flex-col">
                    <label for="memberBodyType" class="text-gray-300 mb-2">체형</label>
                    <select id="memberBodyType" class="bg-[#1e2a38] text-white border border-[#4a5568] rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="보통">보통</option>
                        <option value="마른">마른</option>
                        <option value="근육형">근육형</option>
                        <option value="비만">비만</option>
                    </select>
                </div>
                <div class="flex flex-col">
                    <label for="memberWeight" class="text-gray-300 mb-2">현재 체중 (kg)</label>
                    <input type="number" id="memberWeight" step="0.1" placeholder="예: 70.5" class="bg-[#1e2a38] text-white border border-[#4a5568] rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="flex flex-col">
                    <label for="memberHeight" class="text-gray-300 mb-2">키 (cm)</label>
                    <input type="number" id="memberHeight" step="0.1" placeholder="예: 175.2" class="bg-[#1e2a38] text-white border border-[#4a5568] rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="flex flex-col">
                    <label for="memberGoalWeight" class="text-gray-300 mb-2">목표 체중 (kg)</label>
                    <input type="number" id="memberGoalWeight" step="0.1" placeholder="선택사항: 65.0" class="bg-[#1e2a38] text-white border border-[#4a5568] rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <button type="button" id="addBtn" class="w-full col-span-1 md:col-span-6 bg-gradient-to-r from-green-500 to-blue-500 text-white font-bold py-3 rounded-lg shadow-lg hover:from-green-600 hover:to-blue-600 transition-colors duration-300 mt-2">
                    추가하기
                </button>
            </form>
        </div>

        <!-- Health data visualization and list -->
        <div class="bg-[#2d3748] rounded-xl p-6 shadow-xl mb-8">
            <h2 class="text-2xl font-bold mb-4 text-center">건강 데이터</h2>
            <div class="h-64 sm:h-80 md:h-96">
                <canvas id="healthChart"></canvas>
            </div>
            
            <div class="mt-8 overflow-x-auto">
                <div class="min-w-[500px] md:min-w-0">
                    <div class="grid grid-cols-5 sm:grid-cols-7 gap-2 items-center bg-[#1e2a38] font-bold p-3 rounded-lg mb-2 text-gray-400">
                        <div>날짜</div>
                        <div class="text-center">이름</div>
                        <div class="text-center">성별</div>
                        <div class="text-center">체형</div>
                        <div class="text-center">체중 (kg)</div>
                        <div class="text-center">키 (cm)</div>
                        <div class="text-center">BMI 지수</div>
                    </div>
                    <div id="data-container">
                        <!-- Data will be added dynamically here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Goal achievement dashboard -->
        <div class="bg-[#2d3748] rounded-xl p-6 shadow-xl mb-8">
            <h2 class="text-2xl font-bold mb-4 text-center">체중 목표 달성률</h2>
            <div id="goals-container" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4">
                <!-- Goal achievement cards will be added dynamically here -->
                <div class="bg-[#1e2a38] p-4 rounded-xl shadow-md text-center">
                    <h3 class="text-xl font-bold mb-2 text-gray-400">목표를 설정해주세요</h3>
                    <p class="text-gray-500">첫 번째 데이터 입력 시 목표 체중을 입력하면 여기에 달성률이 표시됩니다.</p>
                </div>
            </div>
        </div>

        <div class="bmi-container p-4 sm:p-6">
            <div class="overflow-x-auto -mx-2 sm:mx-0">
            <div class="min-w-[720px] md:min-w-0 px-2 sm:px-0">
            <h2 class="text-2xl font-bold mb-4 text-center">BMI 지수 참고표</h2>
            <div class="text-sm text-gray-300 mb-4 text-center">
                <p>BMI 지수는 키와 체중만으로 측정되는 지표입니다. 아래 표는 일반적인 참고 기준이며, 나이, 성별, 체형에 따라 건강한 BMI 범위는 달라질 수 있습니다.</p>
            </div>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                <div class="bg-[#1e2a38] p-3 rounded-lg">
                    <p class="text-lg font-semibold">저체중</p>
                    <p class="text-sm text-yellow-400">18.5 미만</p>
                </div>
                <div class="bg-[#2d3748] p-3 rounded-lg flex flex-col items-center justify-center">
                    <p class="text-lg font-semibold text-white">정상 체중</p>
                    <p class="text-sm text-green-400">18.5 ~ 24.9</p>
                </div>
                <div class="bg-[#2d3748] p-3 rounded-lg flex flex-col items-center justify-center">
                    <p class="text-lg font-semibold text-white">과체중</p>
                    <p class="text-sm text-orange-400">25.0 ~ 29.9</p>
                </div>
                <div class="bg-[#2d3748] p-3 rounded-lg flex flex-col items-center justify-center">
                    <p class="text-lg font-semibold text-white">비만</p>
                    <p class="text-sm text-red-400">30.0 이상</p>
                </div>
            </div>
        </div>
    </div>
    <!-- Custom modal UI -->
    <div id="custom-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-gray-900 bg-opacity-75">
        <div class="bg-[#1a202c] rounded-xl p-6 text-center shadow-2xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
            <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full mb-4">
                <i id="modal-icon" class="fa-solid fa-circle-check text-green-500 text-3xl"></i>
            </div>
            <h3 id="modal-message" class="text-lg font-semibold text-white"></h3>
            <div class="mt-4">
                <button type="button" class="inline-flex justify-center rounded-md border border-transparent bg-blue-600 px-4 py-2 text-base font-medium text-white shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 sm:text-sm" onclick="document.getElementById('custom-modal').classList.add('hidden');">
                    확인
                </button>
            </div>
        </div>
    </div>
    <script src="https://kit.fontawesome.com/a933f75727.js" crossorigin="anonymous"></script>
</body>
</html>
