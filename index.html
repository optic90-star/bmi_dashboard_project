<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>가족 통합 건강 대시보드</title>
  <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; background: #0f172a; color: white; display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 1rem; }
    .container { max-width: 800px; width: 100%; }
    .card { background: #1e293b; border: 1px solid #334155; border-radius: 1rem; padding: 1.5rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    .btn { background: #3b82f6; color: white; padding: 0.5rem 1rem; border-radius: 0.5rem; transition: background 0.2s; }
    .btn:hover { background: #2563eb; }
    .chart-container { background: #1e293b; border-radius: 1rem; padding: 1rem; margin-top: 2rem; border: 1px solid #334155; }
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.75); display: flex; justify-content: center; align-items: center; z-index: 50; }
    .modal-content { background: #1e293b; padding: 2rem; border-radius: 1rem; text-align: center; max-width: 90%; width: 400px; }
    .input-field { background: #334155; border: 1px solid #475569; border-radius: 0.5rem; padding: 0.5rem; color: white; width: 100%; margin-top: 0.5rem; }
  </style>
</head>
<body>

<div id="root" class="container"></div>

<script type="text/babel">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
  import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
  import { getFirestore, collection, doc, setDoc, onSnapshot, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

  const { useState, useEffect, useRef } = React;
  const { createRoot } = ReactDOM;
  const Chart = window.Chart;
  const ChartDataLabels = window.ChartDataLabels;

  const firebaseConfig = {
    apiKey: "AIzaSyDVvT5a8vh8CICbT18cqF5dMqRkxalgJWk",
    authDomain: "bmi-dashboard-project.firebaseapp.com",
    projectId: "bmi-dashboard-project",
    storageBucket: "bmi-dashboard-project.firebasestorage.app",
    messagingSenderId: "124744707008",
    appId: "1:124744707008:web:02757469b90412cc013625",
    measurementId: "G-CZQNBEYYCW"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const MEMBER_PASSWORD = '1115';

  const App = () => {
    const [isAuthenticated, setIsAuthenticated] = useState(false);
    const [password, setPassword] = useState('');
    const [familyHealthData, setFamilyHealthData] = useState([]);
    const [selectedMember, setSelectedMember] = useState(null);
    const [isInputModalOpen, setIsInputModalOpen] = useState(false);
    const [inputWeight, setInputWeight] = useState('');
    const [inputHeight, setInputHeight] = useState('');
    const [inputTargetWeight, setInputTargetWeight] = useState('');
    const [userAuthInfo, setUserAuthInfo] = useState(null);
    const [authReady, setAuthReady] = useState(false);
    const [currentMember, setCurrentMember] = useState(null);

    useEffect(() => {
      const unsubscribeAuth = onAuthStateChanged(auth, async (user) => {
        if (user) {
          setUserAuthInfo({ uid: user.uid });
        } else {
          try {
            await signInAnonymously(auth);
          } catch (error) {
            console.error("Anonymous sign-in failed", error);
          }
        }
        setAuthReady(true);
      });

      return () => unsubscribeAuth();
    }, []);

    useEffect(() => {
      if (!authReady || !userAuthInfo) return;

      const userDocRef = doc(db, `user_data/${userAuthInfo.uid}`);
      const unsubscribeUser = onSnapshot(userDocRef, (doc) => {
        if (doc.exists()) {
          setCurrentMember(doc.data());
        }
      }, (error) => {
        console.error("Error fetching user data:", error);
      });

      const q = query(collection(db, "family_data"));
      const unsubscribeFirestore = onSnapshot(q, (snapshot) => {
        const data = snapshot.docs.map(d => d.data());
        setFamilyHealthData(data);
      }, (error) => {
        console.error("Error fetching family data:", error);
      });

      return () => {
        unsubscribeUser();
        unsubscribeFirestore();
      };
    }, [authReady, userAuthInfo]);

    const handlePasswordChange = (e) => setPassword(e.target.value);
    const handleLogin = () => {
      if (password === MEMBER_PASSWORD) {
        setIsAuthenticated(true);
        if (userAuthInfo) {
          console.log("User logged in with UID:", userAuthInfo.uid);
        }
      } else {
        console.log('비밀번호가 틀렸습니다.');
      }
    };

    const handleCardClick = (member) => {
      setSelectedMember(member);
      setInputWeight(member.currentWeight || '');
      setInputHeight(member.height || '');
      setInputTargetWeight(member.targetWeight || '');
      setIsInputModalOpen(true);
    };

    const handleSave = async () => {
      if (!selectedMember || !userAuthInfo) return;

      const memberId = selectedMember.name;
      const userDocRef = doc(db, `user_data/${userAuthInfo.uid}`);
      const memberDocRef = doc(db, `family_data/${memberId}`);
      const newBmi = parseFloat(inputWeight) / (parseFloat(inputHeight) / 100) ** 2;

      const memberData = {
        name: selectedMember.name,
        gender: selectedMember.gender,
        height: parseFloat(inputHeight),
        targetWeight: parseFloat(inputTargetWeight),
        currentWeight: parseFloat(inputWeight),
        bmi: parseFloat(newBmi.toFixed(1)),
        initialWeight: selectedMember.initialWeight || parseFloat(inputWeight),
        initialTargetWeight: selectedMember.initialTargetWeight || parseFloat(inputTargetWeight),
        log: [
          ...(selectedMember.log || []),
          { date: new Date().toISOString().slice(0, 10), weight: parseFloat(inputWeight), bmi: newBmi }
        ],
      };

      try {
        await setDoc(userDocRef, memberData);
        await setDoc(memberDocRef, memberData);
        console.log('데이터가 성공적으로 저장되었습니다.');
        setIsInputModalOpen(false);
      } catch (e) {
        console.error("Error writing document: ", e);
        console.log('데이터 저장에 실패했습니다.');
      }
    };

    const PasswordScreen = () => (
      <div className="flex flex-col items-center justify-center h-screen bg-slate-900 text-white p-4">
        <div className="card w-full max-w-sm flex flex-col items-center p-8">
          <h2 className="text-2xl mb-4 font-bold text-center">대시보드 접속</h2>
          <p className="text-gray-400 mb-6 text-center">비밀번호를 입력하세요.</p>
          <input
            type="password"
            className="input-field mb-4 text-center"
            value={password}
            onChange={handlePasswordChange}
            onKeyPress={(e) => { if (e.key === 'Enter') handleLogin(); }}
            placeholder="비밀번호"
          />
          <button onClick={handleLogin} className="btn w-full">확인</button>
          <p className="mt-4 text-sm text-gray-500">
            접속 오류 시, Firebase 콘솔 &gt; Firestore Database &gt; Rules에서 'allow read, write: if true'로 변경해주세요.
          </p>
        </div>
      </div>
    );

    const MemberCard = ({ member, onClick }) => {
      const bmiCategory = (bmi) => {
        if (bmi < 18.5) return '저체중';
        if (bmi >= 18.5 && bmi < 24.9) return '정상';
        if (bmi >= 25 && bmi < 29.9) return '과체중';
        return '비만';
      };

      const bmiColor = (bmi) => {
        if (bmi < 18.5) return 'text-blue-400';
        if (bmi >= 18.5 && bmi < 24.9) return 'text-green-400';
        if (bmi >= 25 && bmi < 29.9) return 'text-yellow-400';
        return 'text-red-400';
      };

      const weightChange = member.initialWeight ? member.initialWeight - member.currentWeight : 0;
      const progress = member.initialWeight && member.targetWeight && member.currentWeight
        ? ((member.initialWeight - member.currentWeight) / (member.initialWeight - member.targetWeight)) * 100
        : 0;
      const progressClass = progress >= 100 ? 'bg-green-500' : 'bg-blue-500';

      return (
        <div onClick={() => onClick(member)} className="card p-4 transition-transform transform hover:scale-105 cursor-pointer">
          <div className="flex justify-between items-center mb-2">
            <h3 className="text-xl font-semibold">{member.name}</h3>
            <span className={`px-2 py-1 text-xs rounded-full ${bmiColor(member.bmi)}`}>{bmiCategory(member.bmi)}</span>
          </div>
          <div className="text-sm text-gray-400">
            <p>현재 체중: {member.currentWeight ? `${member.currentWeight} kg` : '미입력'}</p>
            <p>초기 체중: {member.initialWeight ? `${member.initialWeight} kg` : '미입력'}</p>
            <p>목표 체중: {member.targetWeight ? `${member.targetWeight} kg` : '미입력'}</p>
          </div>
          <div className="mt-2 text-sm">
            <p>체중 변화: {weightChange.toFixed(1)} kg</p>
            <p>목표 달성률: {progress.toFixed(1)}%</p>
          </div>
          <div className="w-full h-2 bg-gray-600 rounded-full mt-2 overflow-hidden">
            <div className={`h-full ${progressClass}`} style={{ width: `${Math.min(100, progress)}%` }}></div>
          </div>
        </div>
      );
    };

    const BmiChart = ({ data }) => {
      const chartRef = useRef(null);
      const canvasRef = useRef(null);

      useEffect(() => {
        if (chartRef.current) {
          chartRef.current.destroy();
        }

        const labels = data.map(m => m.name);
        const bmiData = data.map(m => m.bmi);
        const targetData = data.map(m => m.targetWeight);
        const currentData = data.map(m => m.currentWeight);
        const initialData = data.map(m => m.initialWeight);
        const progressData = data.map(m => {
          if (!m.initialWeight || !m.targetWeight || !m.currentWeight) return 0;
          return ((m.initialWeight - m.currentWeight) / (m.initialWeight - m.targetWeight)) * 100;
        });

        const ctx = canvasRef.current.getContext('2d');
        chartRef.current = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: labels,
            datasets: [
              {
                label: '현재 체중',
                data: currentData,
                backgroundColor: '#3b82f6',
                borderColor: '#3b82f6',
                borderWidth: 1,
                order: 2,
              },
              {
                label: '목표 체중',
                data: targetData,
                backgroundColor: '#ef4444',
                borderColor: '#ef4444',
                borderWidth: 1,
                order: 2,
              },
              {
                label: '초기 체중',
                data: initialData,
                backgroundColor: '#6b7280',
                borderColor: '#6b7280',
                borderWidth: 1,
                order: 2,
              },
              {
                label: '목표 달성률 (%)',
                data: progressData,
                type: 'line',
                fill: false,
                borderColor: '#4ade80',
                tension: 0.1,
                pointRadius: 5,
                yAxisID: 'progress-y-axis',
                order: 1,
                datalabels: {
                  color: '#4ade80',
                  anchor: 'end',
                  align: 'top',
                  formatter: (value) => value.toFixed(1) + '%'
                }
              }
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                labels: { color: 'white' }
              },
              title: {
                display: true,
                text: '가족 건강 대시보드',
                color: 'white',
                font: { size: 18, family: 'Inter' }
              },
              datalabels: {
                color: 'white',
                anchor: 'end',
                align: 'top',
                formatter: (value, context) => {
                  const datasetLabel = context.dataset.label;
                  if (datasetLabel === '목표 달성률 (%)') {
                    return `${value.toFixed(1)}%`;
                  }
                  return '';
                }
              }
            },
            scales: {
              x: {
                ticks: { color: 'white' },
                grid: { color: 'rgba(255, 255, 255, 0.2)' }
              },
              y: {
                ticks: { color: 'white' },
                grid: { color: 'rgba(255, 255, 255, 0.2)' },
                title: {
                  display: true,
                  text: '체중 (kg)',
                  color: 'white'
                }
              },
              'progress-y-axis': {
                position: 'right',
                min: 0,
                max: 100,
                ticks: { color: 'white' },
                grid: { display: false },
                title: {
                  display: true,
                  text: '달성률 (%)',
                  color: 'white'
                }
              }
            }
          },
          plugins: [ChartDataLabels]
        });

        return () => {
          if (chartRef.current) {
            chartRef.current.destroy();
          }
        };
      }, [data]);

      return <canvas ref={canvasRef} />;
    };

    const MainAppView = () => (
      <div className="p-4 sm:p-8">
        <h1 className="text-3xl sm:text-4xl font-bold text-center mb-6">가족 건강 대시보드</h1>
        <p className="text-center text-sm text-gray-400 mb-8">
          클릭하여 체중 정보를 업데이트하세요
        </p>

        {currentMember && (
          <div className="card mb-6">
            <h2 className="text-xl font-semibold mb-2">나의 정보</h2>
            <p>이름: {currentMember.name || '미입력'}</p>
            <p>현재 체중: {currentMember.currentWeight ? `${currentMember.currentWeight} kg` : '미입력'}</p>
            <p>초기 체중: {currentMember.initialWeight ? `${currentMember.initialWeight} kg` : '미입력'}</p>
            <p>목표 체중: {currentMember.targetWeight ? `${currentMember.targetWeight} kg` : '미입력'}</p>
          </div>
        )}

        <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
          {familyHealthData.length > 0 ? (
            familyHealthData.map(member => (
              <MemberCard key={member.name} member={member} onClick={handleCardClick} />
            ))
          ) : (
            <div className="col-span-4 text-center text-gray-400">
              <p>데이터가 없습니다. 첫 번째 데이터를 입력해주세요.</p>
            </div>
          )}
        </div>

        <div className="chart-container">
          <BmiChart data={familyHealthData} />
        </div>

        {isInputModalOpen && (
          <div className="modal-overlay">
            <div className="modal-content">
              <h3 className="text-xl font-bold mb-4">{selectedMember.name}님 데이터 입력</h3>
              <label className="block text-left text-sm mb-2">
                현재 체중 (kg)
                <input
                  type="number"
                  className="input-field mt-1"
                  value={inputWeight}
                  onChange={(e) => setInputWeight(e.target.value)}
                  placeholder="체중"
                />
              </label>
              <label className="block text-left text-sm mb-2">
                키 (cm)
                <input
                  type="number"
                  className="input-field mt-1"
                  value={inputHeight}
                  onChange={(e) => setInputHeight(e.target.value)}
                  placeholder="키"
                />
              </label>
              <label className="block text-left text-sm mb-4">
                목표 체중 (kg)
                <input
                  type="number"
                  className="input-field mt-1"
                  value={inputTargetWeight}
                  onChange={(e) => setInputTargetWeight(e.target.value)}
                  placeholder="목표 체중"
                />
              </label>
              <div className="flex justify-end gap-2">
                <button onClick={() => setIsInputModalOpen(false)} className="btn bg-gray-600">취소</button>
                <button onClick={handleSave} className="btn bg-green-500">저장</button>
              </div>
            </div>
          </div>
        )}
      </div>
    );

    const MainApp = () => {
        return (
            <div>
                {isAuthenticated ? <MainAppView /> : <PasswordScreen />}
            </div>
        );
    };
    
    // 이 부분이 올바른 실행을 보장합니다.
    const rootElement = document.getElementById('root');
    if (rootElement) {
      createRoot(rootElement).render(<MainApp />);
    } else {
      console.error("Root element not found.");
    }
  };
</script>
</body>
</html>ole.error('Save failed:', e);
          setToast({ message: "데이터 저장 실패. 다시 시도해주세요. ❌", type: "error" });
        } finally {
          setIsSaving(false);
        }
      };

      const heightM = baseData.height / 100;
      const currentBmi = localData.weight && localData.weight > 0 ? (localData.weight / (heightM * heightM)) : 0;
      const targetBmi = localData.targetWeight ? (localData.targetWeight / (heightM * heightM)) : 0;
      const bmiDifference = targetBmi ? (targetBmi - currentBmi) : null;
      
      const getBmiCategory = (bmi) => {
        if (bmi < 18.5) return { text: '저체중', class: 'bmi-excellent', icon: '📉', color: '#4facfe' };
        if (bmi < 25) return { text: '정상', class: 'bmi-good', icon: '✅', color: '#43e97b' };
        if (bmi < 30) return { text: '과체중', class: 'bmi-warning', icon: '⚠️', color: '#feca57' };
        return { text: '비만', class: 'bmi-danger', icon: '🔴', color: '#ff6b6b' };
      };

      const bmiCategory = getBmiCategory(currentBmi);

      // Calculate progress percentage
      const initialWeight = baseData.weight;
      const targetWeight = localData.targetWeight;
      const currentWeight = localData.weight;
      let progress = 0;
      if (targetWeight && initialWeight !== targetWeight) {
        progress = ((currentWeight - initialWeight) / (targetWeight - initialWeight)) * 100;
      }
      progress = Math.min(100, Math.max(0, progress));

      return (
        <div className="glassmorphism rounded-3xl p-6 card-hover fade-in">
          {/* Header */}
          <div className="flex items-center justify-between mb-6">
            <div className="flex items-center space-x-4">
              <div className="text-6xl hover:scale-110 transition-transform cursor-pointer">
                {baseData.emoji}
              </div>
              <div>
                <h2 className="text-2xl font-bold text-white mb-1">{baseData.name}</h2>
                <p className="text-white/70 text-sm mb-2">{baseData.desc}</p>
                <div className="flex flex-wrap gap-2 text-xs">
                  <span className="bg-white/10 px-2 py-1 rounded-full text-white/80">
                    <i className="fas fa-birthday-cake mr-1"></i>{baseData.age}세
                  </span>
                  <span className="bg-white/10 px-2 py-1 rounded-full text-white/80">
                    <i className="fas fa-ruler-vertical mr-1"></i>{baseData.height}cm
                  </span>
                  <span className="bg-white/10 px-2 py-1 rounded-full text-white/80">
                    <i className="fas fa-briefcase mr-1"></i>{baseData.profession}
                  </span>
                </div>
              </div>
            </div>
          </div>

          {/* BMI Status */}
          <div className="grid grid-cols-2 gap-6 mb-6">
            <div className="text-center">
              <CircularProgress 
                value={currentBmi} 
                maxValue={35} 
                color={bmiCategory.color}
              />
              <p className="text-white/80 text-sm mt-3 font-medium">현재 BMI</p>
            </div>
            <div className="space-y-3">
              <div className={`${bmiCategory.class} rounded-xl p-4 text-center sparkle`}>
                <div className="text-white font-bold text-lg mb-1">
                  {bmiCategory.icon} {bmiCategory.text}
                </div>
                <div className="text-white/90 text-sm">BMI {currentBmi.toFixed(1)}</div>
              </div>
              {targetBmi > 0 && (
                <div className="bg-white/10 rounded-xl p-3 text-center">
                  <div className="text-white/80 text-sm">목표: {targetBmi.toFixed(1)}</div>
                  <div className="text-white/60 text-xs">
                    {bmiDifference > 0 ? '↑' : '↓'} {Math.abs(bmiDifference).toFixed(1)}
                  </div>
                </div>
              )}
            </div>
          </div>
           <button 
                onClick={() => setShowDetails(!showDetails)}
                className="w-full py-3 bg-white/20 text-white font-semibold rounded-2xl mb-4 hover:bg-white/30 transition-all transform hover:scale-105"
            >
                {showDetails ? (
                  <span><i className="fas fa-chevron-up mr-2"></i>접기</span>
                ) : (
                  <span><i className="fas fa-chevron-down mr-2"></i>상세 보기</span>
                )}
            </button>

          {/* Details */}
          {showDetails && (
            <div className="space-y-6 slide-up">
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label className="flex items-center text-white/80 font-medium mb-2 text-sm">
                    <i className="fas fa-weight-scale mr-2"></i>초기 체중 (kg)
                  </label>
                  <p className="w-full p-3 bg-white/10 rounded-xl text-white/80 backdrop-blur-sm">
                    {initialWeight} kg
                  </p>
                </div>
                <div>
                  <label className="flex items-center text-white/80 font-medium mb-2 text-sm">
                    <i className="fas fa-bullseye mr-2"></i>목표 체중 (kg)
                  </label>
                  <input 
                    type="number" 
                    value={localData.targetWeight || ''} 
                    onChange={e => handleChange('targetWeight', e.target.value)} 
                    step="0.1" 
                    className="w-full p-3 bg-white/10 border border-white/20 rounded-xl text-white placeholder-white/50 backdrop-blur-sm focus:outline-none focus:border-white/50 focus:bg-white/15 transition-all"
                    placeholder="목표 체중"
                  />
                </div>
                <div>
                  <label className="flex items-center text-white/80 font-medium mb-2 text-sm">
                    <i className="fas fa-weight-hanging mr-2"></i>현재 체중 (kg)
                  </label>
                  <input 
                    type="number" 
                    value={localData.weight || ''} 
                    onChange={e => handleChange('weight', e.target.value)} 
                    step="0.1" 
                    className="w-full p-3 bg-white/10 border border-white/20 rounded-xl text-white placeholder-white/50 backdrop-blur-sm focus:outline-none focus:border-white/50 focus:bg-white/15 transition-all"
                    placeholder="체중 입력"
                  />
                </div>
                <div>
                  <label className="flex items-center text-white/80 font-medium mb-2 text-sm">
                    <i className="fas fa-percentage mr-2"></i>목표 진행률 (%)
                  </label>
                  <p className="w-full p-3 bg-white/10 rounded-xl text-white backdrop-blur-sm">
                    {progress.toFixed(1)} %
                  </p>
                </div>
                <div>
                    <label className="flex items-center text-white/80 font-medium mb-2 text-sm">
                      <i className="fas fa-dumbbell mr-2"></i>체형
                    </label>
                    <select 
                      value={localData.bodyType || '보통'} 
                      onChange={e => handleChange('bodyType', e.target.value)} 
                      className="w-full p-3 bg-white/10 border border-white/20 rounded-xl text-white backdrop-blur-sm focus:outline-none focus:border-white/50 focus:bg-white/15 transition-all"
                    >
                      <option value="보통">보통</option>
                      <option value="근육형">근육형</option>
                      <option value="마른 비만">마른 비만</option>
                      <option value="마른 체형">마른 체형</option>
                      <option value="과체중">과체중</option>
                    </select>
                </div>
              </div>

              {/* AI Insights */}
              <HealthInsights memberData={localData} baseData={baseData} />

              {/* Save Button */}
              <button 
                onClick={handleSave} 
                disabled={isSaving}
                className="w-full py-4 bg-gradient-to-r from-green-400 to-blue-500 text-white font-bold rounded-2xl sparkle hover:from-green-500 hover:to-blue-600 disabled:opacity-50 transition-all transform hover:scale-105 neon-glow"
              >
                {isSaving ? (
                  <div className="flex items-center justify-center space-x-2">
                    <div className="animate-spin rounded-full h-5 w-5 border-2 border-white border-t-transparent"></div>
                    <span>저장 중...</span>
                  </div>
                ) : (
                  <span>
                    <i className="fas fa-save mr-2"></i>
                    데이터 저장하기
                  </span>
                )}
              </button>
            </div>
          )}
        </div>
      );
    };

    // Main App Component
    const App = () => {
      const [hasAccess, setHasAccess] = useState(false);
      const [data, setData] = useState(initialFamilyData);
      const [authReady, setAuthReady] = useState(false);
      const [userId, setUserId] = useState(null);
      const [toast, setToast] = useState(null);

      // Firebase authentication and data listener setup
      useEffect(() => {
        if (!window.firebase) {
            console.error("Firebase is not loaded.");
            return;
        }

        const { auth, initialAuthToken, signInWithCustomToken, signInAnonymously, onAuthStateChanged, db, appId, collection, onSnapshot } = window.firebase;
        
        // Listen for auth state changes
        const unsubscribeAuth = onAuthStateChanged(auth, async (user) => {
            if (user) {
                setUserId(user.uid);
                setAuthReady(true);
                // Listen for changes in the user's data
                const userHealthRef = collection(db, `artifacts/${appId}/users/${user.uid}/health-data`);
                const unsubscribeSnapshot = onSnapshot(userHealthRef, (snapshot) => {
                    if (!snapshot.empty) {
                        const firebaseData = {};
                        snapshot.docs.forEach(doc => {
                            firebaseData[doc.id] = doc.data();
                        });
                        // Merge initial data with data from Firestore
                        setData(prevData => {
                           const updatedData = { ...prevData };
                           Object.keys(firebaseData).forEach(id => {
                               updatedData[id] = { ...updatedData[id], ...firebaseData[id] };
                           });
                           return updatedData;
                        });
                    }
                }, (error) => {
                    console.error("Failed to listen for data updates:", error);
                    setToast({ message: "데이터 로딩 오류. 새로고침을 시도하세요.", type: "error" });
                });
                return () => unsubscribeSnapshot();
            } else {
                setAuthReady(true);
                setUserId(null);
            }
        }, (error) => {
            console.error("Authentication failed:", error);
            setAuthReady(true);
        });
        
        // Sign in with custom token or anonymously
        const authLogin = async () => {
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Authentication error during login:", error);
            }
        };

        if (auth && !auth.currentUser) {
            authLogin();
        }

        return () => unsubscribeAuth();
      }, []);

      useEffect(() => {
        if (toast) {
          const timer = setTimeout(() => setToast(null), 3000);
          return () => clearTimeout(timer);
        }
      }, [toast]);
      
      if (!hasAccess) {
        return <PasswordGate onAccess={setHasAccess} />;
      }
      
      return (
        <div className="min-h-screen animated-bg">
          {toast && <ToastMessage message={toast.message} type={toast.type} onClose={() => setToast(null)} />}
          <div className="p-4 md:p-8 lg:p-12 text-white">
            <header className="text-center py-8">
              <h1 className="text-5xl md:text-6xl font-extrabold mb-2 gradient-text">
                Ultimate Health Dashboard
              </h1>
              <p className="text-lg md:text-xl font-medium text-white/80">
                <i className="fas fa-heartbeat mr-2 pulse"></i> 우리 가족 건강 관리
              </p>
              {userId && (
                  <div className="text-xs text-white/50 mt-2 break-all">User ID: {userId}</div>
              )}
            </header>
            <div className="fade-in">
              <div className="grid gap-8 mb-12 lg:grid-cols-2 xl:grid-cols-4">
                {Object.keys(data).map(id => (
                  <FamilyMember
                    key={id}
                    memberData={data[id]}
                    onUpdate={() => {}} // Placeholder, logic is in handleSave
                    baseData={initialFamilyData[id]}
                    setToast={setToast}
                    auth={window.firebase.auth}
                  />
                ))}
              </div>
              <div className="w-full h-[400px] glassmorphism p-4 rounded-3xl">
                {authReady ? (
                  <AdvancedBMIChart familyHealthData={data} initialData={initialFamilyData} />
                ) : (
                  <div className="flex items-center justify-center w-full h-full text-white/70">
                    <div className="animate-spin rounded-full h-10 w-10 border-4 border-white border-t-transparent mr-4"></div>
                    데이터를 불러오는 중입니다...
                  </div>
                )}
              </div>
            </div>
            <footer className="text-center text-white/50 text-sm mt-12 py-4 border-t border-white/20">
              © 2025. 수아동혁가족. All Rights Reserved.
              <div className="mt-2 text-xs break-all">이 앱은 파이어베이스 데이터베이스에 데이터를 저장합니다.</div>
            </footer>
          </div>
        </div>
      );
    };

    // Chart.js Component
    const AdvancedBMIChart = ({ familyHealthData, initialData }) => {
      const canvasRef = useRef(null);
      const chartRef = useRef(null);

      useEffect(() => {
        if (!familyHealthData || Object.keys(familyHealthData).length === 0) return;
        
        const ctx = canvasRef.current.getContext('2d');
        
        if (chartRef.current) {
            chartRef.current.destroy();
        }

        const labels = Object.values(familyHealthData).map(member => member.name);
        const currentBmis = Object.values(familyHealthData).map(member => {
          const heightM = initialData[member.id].height / 100;
          return member.weight ? (member.weight / (heightM * heightM)) : 0;
        });
        
        const targetBmis = Object.values(initialData).map(member => member.recommendedBMI);
        
        const progressPercentages = Object.values(familyHealthData).map(member => {
          const initialWeight = initialData[member.id].weight;
          const targetWeight = member.targetWeight;
          const currentWeight = member.weight;
          
          if (!targetWeight || initialWeight === targetWeight) {
            return null;
          }
          
          let progress = ((currentWeight - initialWeight) / (targetWeight - initialWeight)) * 100;
          progress = Math.min(100, Math.max(0, progress));
          return progress;
        });

        chartRef.current = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: labels,
            datasets: [{
              label: '현재 BMI',
              data: currentBmis,
              backgroundColor: [
                'rgba(75, 192, 192, 0.6)', 
                'rgba(255, 159, 64, 0.6)', 
                'rgba(54, 162, 235, 0.6)', 
                'rgba(153, 102, 255, 0.6)'
              ],
              borderColor: [
                'rgba(75, 192, 192, 1)', 
                'rgba(255, 159, 64, 1)', 
                'rgba(54, 162, 235, 1)', 
                'rgba(153, 102, 255, 1)'
              ],
              borderWidth: 1,
              datalabels: {
                color: 'white',
                anchor: 'end',
                align: 'top',
                offset: 5,
                formatter: (value) => value > 0 ? value.toFixed(1) : ''
              }
            },
            {
              label: '목표 BMI',
              data: targetBmis,
              backgroundColor: 'rgba(255, 255, 255, 0.2)',
              borderColor: 'rgba(255, 255, 255, 0.8)',
              borderWidth: 2,
              type: 'line',
              fill: false,
              datalabels: {
                display: false
              }
            },
            {
              label: '목표 달성률 (%)',
              data: progressPercentages,
              type: 'line',
              fill: false,
              borderColor: '#f5576c',
              borderWidth: 2,
              borderDash: [5, 5],
              pointBackgroundColor: '#f5576c',
              datalabels: {
                color: '#f5576c',
                anchor: 'start',
                align: 'end',
                offset: 10,
                formatter: (value) => {
                  return value !== null ? `${value.toFixed(0)}%` : '';
                }
              }
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                labels: { color: 'white' }
              },
              title: {
                display: true,
                text: '가족 BMI 및 목표 달성률',
                color: 'white',
                font: { size: 18, family: 'Noto Sans KR' }
              }
            },
            scales: {
              x: {
                ticks: { color: 'white' },
                grid: { color: 'rgba(255, 255, 255, 0.2)' }
              },
              y: {
                ticks: { color: 'white' },
                grid: { color: 'rgba(255, 255, 255, 0.2)' },
                min: 15, max: 35
              }
            }
          },
          plugins: [ChartDataLabels]
        });

        return () => {
          if (chartRef.current) {
            chartRef.current.destroy();
          }
        };
      }, [familyHealthData]);

      return <canvas ref={canvasRef} />;
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>               onUpdate={updateData}
                      baseData={initialFamilyData[id]}
                      setToast={setToast}
                    />
                  ))}
                </div>
                <div className="w-full h-[400px] glassmorphism p-4 rounded-3xl">
                  <AdvancedBMIChart familyHealthData={data} />
                </div>
              </div>
            )}
            <footer className="text-center text-white/50 text-sm mt-12 py-4 border-t border-white/20">
              © 2025. 수아동혁가족. All Rights Reserved.
              <div className="mt-2 text-xs break-all">User ID: {displayUserId}</div>
            </footer>
          </div>
        </div>
      );
    };

    // Chart.js Component
    const AdvancedBMIChart = ({ familyHealthData }) => {
      const canvasRef = useRef(null);
      const chartRef = useRef(null);

      useEffect(() => {
        if (!familyHealthData || Object.keys(familyHealthData).length === 0) return;
        
        const ctx = canvasRef.current.getContext('2d');
        
        if (chartRef.current) {
            chartRef.current.destroy();
        }

        const labels = Object.values(familyHealthData).map(member => member.name);
        const currentBmis = Object.values(familyHealthData).map(member => {
          const heightM = initialFamilyData[member.id].height / 100;
          return member.weight ? (member.weight / (heightM * heightM)) : 0;
        });
        const targetBmis = Object.values(initialFamilyData).map(member => member.recommendedBMI);
        
        chartRef.current = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: labels,
            datasets: [{
              label: '현재 BMI',
              data: currentBmis,
              backgroundColor: [
                'rgba(75, 192, 192, 0.6)', 
                'rgba(255, 159, 64, 0.6)', 
                'rgba(54, 162, 235, 0.6)', 
                'rgba(153, 102, 255, 0.6)'
              ],
              borderColor: [
                'rgba(75, 192, 192, 1)', 
                'rgba(255, 159, 64, 1)', 
                'rgba(54, 162, 235, 1)', 
                'rgba(153, 102, 255, 1)'
              ],
              borderWidth: 1
            },
            {
              label: '목표 BMI',
              data: targetBmis,
              backgroundColor: 'rgba(255, 255, 255, 0.2)',
              borderColor: 'rgba(255, 255, 255, 0.8)',
              borderWidth: 2,
              type: 'line',
              fill: false,
              datalabels: {
                display: false
              }
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                labels: { color: 'white' }
              },
              title: {
                display: true,
                text: '가족 BMI 추이',
                color: 'white',
                font: { size: 18, family: 'Noto Sans KR' }
              },
              datalabels: {
                color: 'white',
                anchor: 'end',
                align: 'top',
                formatter: (value) => value.toFixed(1)
              }
            },
            scales: {
              x: {
                ticks: { color: 'white' },
                grid: { color: 'rgba(255, 255, 255, 0.2)' }
              },
              y: {
                ticks: { color: 'white' },
                grid: { color: 'rgba(255, 255, 255, 0.2)' },
                min: 15, max: 35
              }
            }
          },
          plugins: [ChartDataLabels]
        });

        return () => {
          if (chartRef.current) {
            chartRef.current.destroy();
          }
        };
      }, [familyHealthData]);

      return <canvas ref={canvasRef} />;
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>