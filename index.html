<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ìˆ˜ì•„ë™í˜ê°€ì¡± BMI ëŒ€ì‹œë³´ë“œ</title>
  <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

  <!-- âœ… Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore-compat.js"></script>

  <style>
    body { font-family: 'Inter', sans-serif; background: #0f172a; color: white; min-height: 100vh; }
    .glassmorphism { background: rgba(255,255,255,0.1); backdrop-filter: blur(10px); }
    .gradient-text { background: linear-gradient(to right, #4facfe, #00f2fe); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
  </style>
</head>
<body>
<div id="root"></div>

<script type="text/babel">
  const { useState, useEffect, useRef } = React;
  const { createRoot } = ReactDOM;
  const Chart = window.Chart;
  const ChartDataLabels = window.ChartDataLabels;

  // âœ… Firebase ì´ˆê¸°í™” (ë¯¼ì² ë‹˜ í”„ë¡œì íŠ¸ ì„¤ì •ê°’)
  const firebaseConfig = {
    apiKey: "AIzaSyDVvT5a8vh8CICbT18cqF5dMqRkxalgJWk",
    authDomain: "bmi-dashboard-project.firebaseapp.com",
    projectId: "bmi-dashboard-project",
    storageBucket: "bmi-dashboard-project.firebasestorage.app",
    messagingSenderId: "124744707008",
    appId: "1:124744707008:web:02757469b90412cc013625",
    measurementId: "G-CZQNBEYYCW"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // ê¸°ë³¸ ê°€ì¡± ë°ì´í„°
  const initialFamilyData = {
    dad: { id: "dad", name: "ì•„ë¹ ", height: 178, weight: 95, recommendedBMI: 24 },
    mom: { id: "mom", name: "ì—„ë§ˆ", height: 165, weight: 60, recommendedBMI: 22 },
    daughter: { id: "daughter", name: "ìˆ˜ì•„", height: 160, weight: 48, recommendedBMI: 21 },
    son: { id: "son", name: "ë™í˜", height: 170, weight: 70, recommendedBMI: 23 }
  };

  // ë¹„ë°€ë²ˆí˜¸ ê²Œì´íŠ¸
  const PasswordGate = ({ onAccess }) => {
    const [pw, setPw] = useState("");
    const handleLogin = () => { if (pw === "1115") onAccess(true); };
    return (
      <div className="flex flex-col items-center justify-center h-screen bg-slate-900">
        <div className="bg-slate-800 p-8 rounded-xl">
          <h2 className="text-2xl mb-4 font-bold">ì ‘ì† ë¹„ë°€ë²ˆí˜¸ ì…ë ¥</h2>
          <input type="password" value={pw} onChange={e => setPw(e.target.value)} className="p-2 rounded text-black mb-4" />
          <button onClick={handleLogin} className="bg-blue-500 px-4 py-2 rounded">í™•ì¸</button>
        </div>
      </div>
    );
  };

  // BMI ì°¨íŠ¸
  const AdvancedBMIChart = ({ familyHealthData, initialData }) => {
    const canvasRef = useRef(null);
    const chartRef = useRef(null);

    useEffect(() => {
      if (!familyHealthData || Object.keys(familyHealthData).length === 0) return;
      const ctx = canvasRef.current.getContext("2d");
      if (chartRef.current) chartRef.current.destroy();

      const labels = Object.values(familyHealthData).map(m => m.name);
      const currentBmis = Object.values(familyHealthData).map(m => {
        const h = initialData[m.id].height / 100;
        return m.weight ? (m.weight / (h*h)) : 0;
      });
      const targetBmis = Object.values(initialData).map(m => m.recommendedBMI);

      chartRef.current = new Chart(ctx, {
        type: 'bar',
        data: {
          labels,
          datasets: [
            {
              label: 'í˜„ì¬ BMI',
              data: currentBmis,
              backgroundColor: 'rgba(75,192,192,0.6)',
              borderColor: 'rgba(75,192,192,1)',
              borderWidth: 1,
              datalabels: {
                color: 'white',
                anchor: 'end',
                align: 'top',
                formatter: v => v>0 ? v.toFixed(1) : ''
              }
            },
            {
              label: 'ëª©í‘œ BMI',
              data: targetBmis,
              type: 'line',
              borderColor: 'rgba(255,255,255,0.8)',
              borderWidth: 2,
              datalabels: { display: false }
            }
          ]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { labels: { color: 'white' } },
            title: { display: true, text: 'ê°€ì¡± BMI ì¶”ì´', color: 'white' }
          },
          scales: {
            x: { ticks: { color: 'white' }, grid: { color: 'rgba(255,255,255,0.2)' } },
            y: { ticks: { color: 'white' }, min: 15, max: 35 }
          }
        },
        plugins: [ChartDataLabels]
      });

      return () => { if (chartRef.current) chartRef.current.destroy(); };
    }, [familyHealthData]);

    return <canvas ref={canvasRef} />;
  };

  // ë©”ì¸ ì•±
  const App = () => {
    const [hasAccess, setHasAccess] = useState(false);
    const [data, setData] = useState(initialFamilyData);

    // âœ… Firestore ë°ì´í„° ì‹¤ì‹œê°„ ë¶ˆëŸ¬ì˜¤ê¸°
    useEffect(() => {
      const unsub = db.collection("family").onSnapshot(snapshot => {
        const newData = { ...initialFamilyData };
        snapshot.forEach(doc => {
          newData[doc.id] = { ...newData[doc.id], ...doc.data() };
        });
        setData(newData);
      });
      return () => unsub();
    }, []);

    // âœ… ë°ì´í„° ì €ì¥í•˜ê¸°
    const updateWeight = async (id, newWeight) => {
      await db.collection("family").doc(id).set({ weight: newWeight }, { merge: true });
    };

    if (!hasAccess) return <PasswordGate onAccess={setHasAccess} />;

    return (
      <div className="min-h-screen p-6">
        <header className="text-center py-8">
          <h1 className="text-4xl font-extrabold mb-2 gradient-text">ìˆ˜ì•„ë™í˜ê°€ì¡± BMI ëŒ€ì‹œë³´ë“œ</h1>
          <p className="text-lg text-white/80">ìš°ë¦¬ ê°€ì¡± ê±´ê°• ìƒíƒœë¥¼ ì‹¤ì‹œê°„ ì €ì¥</p>
        </header>

        {/* ì²´ì¤‘ ìˆ˜ì • UI */}
        <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
          {Object.values(data).map(member => (
            <div key={member.id} className="glassmorphism p-4 rounded-xl">
              <h3 className="text-xl font-bold mb-2">{member.name}</h3>
              <p>í‚¤: {member.height} cm</p>
              <p>í˜„ì¬ ì²´ì¤‘: {member.weight} kg</p>
              <input
                type="number"
                className="w-full mt-2 p-2 text-black rounded"
                placeholder="ìƒˆ ì²´ì¤‘ ì…ë ¥ í›„ Enter"
                onKeyDown={e => {
                  if (e.key === "Enter") updateWeight(member.id, parseFloat(e.target.value));
                }}
              />
            </div>
          ))}
        </div>

        {/* BMI ì°¨íŠ¸ */}
        <div className="w-full h-[400px] glassmorphism p-4 rounded-3xl">
          <AdvancedBMIChart familyHealthData={data} initialData={initialFamilyData} />
        </div>

        <footer className="text-center text-white/50 text-sm mt-12 py-4 border-t border-white/20">
          Â© 2025. ìˆ˜ì•„ë™í˜ê°€ì¡±. All Rights Reserved.
        </footer>
      </div>
    );
  };

  createRoot(document.getElementById("root")).render(<App />);
</script>
</body>
</html>Login} className="btn w-full">í™•ì¸</button>
          <p className="mt-4 text-sm text-gray-500">
            ì ‘ì† ì˜¤ë¥˜ ì‹œ, Firebase ì½˜ì†” &gt; Firestore Database &gt; Rulesì—ì„œ 'allow read, write: if true'ë¡œ ë³€ê²½í•´ì£¼ì„¸ìš”.
          </p>
        </div>
      </div>
    );

    const MemberCard = ({ member, onClick }) => {
      const bmiCategory = (bmi) => {
        if (bmi < 18.5) return 'ì €ì²´ì¤‘';
        if (bmi >= 18.5 && bmi < 24.9) return 'ì •ìƒ';
        if (bmi >= 25 && bmi < 29.9) return 'ê³¼ì²´ì¤‘';
        return 'ë¹„ë§Œ';
      };

      const bmiColor = (bmi) => {
        if (bmi < 18.5) return 'text-blue-400';
        if (bmi >= 18.5 && bmi < 24.9) return 'text-green-400';
        if (bmi >= 25 && bmi < 29.9) return 'text-yellow-400';
        return 'text-red-400';
      };

      const weightChange = member.initialWeight ? member.initialWeight - member.currentWeight : 0;
      const progress = member.initialWeight && member.targetWeight && member.currentWeight
        ? ((member.initialWeight - member.currentWeight) / (member.initialWeight - member.targetWeight)) * 100
        : 0;
      const progressClass = progress >= 100 ? 'bg-green-500' : 'bg-blue-500';

      return (
        <div onClick={() => onClick(member)} className="card p-4 transition-transform transform hover:scale-105 cursor-pointer">
          <div className="flex justify-between items-center mb-2">
            <h3 className="text-xl font-semibold">{member.name}</h3>
            <span className={`px-2 py-1 text-xs rounded-full ${bmiColor(member.bmi)}`}>{bmiCategory(member.bmi)}</span>
          </div>
          <div className="text-sm text-gray-400">
            <p>í˜„ì¬ ì²´ì¤‘: {member.currentWeight ? `${member.currentWeight} kg` : 'ë¯¸ì…ë ¥'}</p>
            <p>ì´ˆê¸° ì²´ì¤‘: {member.initialWeight ? `${member.initialWeight} kg` : 'ë¯¸ì…ë ¥'}</p>
            <p>ëª©í‘œ ì²´ì¤‘: {member.targetWeight ? `${member.targetWeight} kg` : 'ë¯¸ì…ë ¥'}</p>
          </div>
          <div className="mt-2 text-sm">
            <p>ì²´ì¤‘ ë³€í™”: {weightChange.toFixed(1)} kg</p>
            <p>ëª©í‘œ ë‹¬ì„±ë¥ : {progress.toFixed(1)}%</p>
          </div>
          <div className="w-full h-2 bg-gray-600 rounded-full mt-2 overflow-hidden">
            <div className={`h-full ${progressClass}`} style={{ width: `${Math.min(100, progress)}%` }}></div>
          </div>
        </div>
      );
    };

    const BmiChart = ({ data }) => {
      const chartRef = useRef(null);
      const canvasRef = useRef(null);

      useEffect(() => {
        if (chartRef.current) {
          chartRef.current.destroy();
        }

        const labels = data.map(m => m.name);
        const bmiData = data.map(m => m.bmi);
        const targetData = data.map(m => m.targetWeight);
        const currentData = data.map(m => m.currentWeight);
        const initialData = data.map(m => m.initialWeight);
        const progressData = data.map(m => {
          if (!m.initialWeight || !m.targetWeight || !m.currentWeight) return 0;
          return ((m.initialWeight - m.currentWeight) / (m.initialWeight - m.targetWeight)) * 100;
        });

        const ctx = canvasRef.current.getContext('2d');
        chartRef.current = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: labels,
            datasets: [
              {
                label: 'í˜„ì¬ ì²´ì¤‘',
                data: currentData,
                backgroundColor: '#3b82f6',
                borderColor: '#3b82f6',
                borderWidth: 1,
                order: 2,
              },
              {
                label: 'ëª©í‘œ ì²´ì¤‘',
                data: targetData,
                backgroundColor: '#ef4444',
                borderColor: '#ef4444',
                borderWidth: 1,
                order: 2,
              },
              {
                label: 'ì´ˆê¸° ì²´ì¤‘',
                data: initialData,
                backgroundColor: '#6b7280',
                borderColor: '#6b7280',
                borderWidth: 1,
                order: 2,
              },
              {
                label: 'ëª©í‘œ ë‹¬ì„±ë¥  (%)',
                data: progressData,
                type: 'line',
                fill: false,
                borderColor: '#4ade80',
                tension: 0.1,
                pointRadius: 5,
                yAxisID: 'progress-y-axis',
                order: 1,
                datalabels: {
                  color: '#4ade80',
                  anchor: 'end',
                  align: 'top',
                  formatter: (value) => value.toFixed(1) + '%'
                }
              }
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                labels: { color: 'white' }
              },
              title: {
                display: true,
                text: 'ê°€ì¡± ê±´ê°• ëŒ€ì‹œë³´ë“œ',
                color: 'white',
                font: { size: 18, family: 'Inter' }
              },
              datalabels: {
                color: 'white',
                anchor: 'end',
                align: 'top',
                formatter: (value, context) => {
                  const datasetLabel = context.dataset.label;
                  if (datasetLabel === 'ëª©í‘œ ë‹¬ì„±ë¥  (%)') {
                    return `${value.toFixed(1)}%`;
                  }
                  return '';
                }
              }
            },
            scales: {
              x: {
                ticks: { color: 'white' },
                grid: { color: 'rgba(255, 255, 255, 0.2)' }
              },
              y: {
                ticks: { color: 'white' },
                grid: { color: 'rgba(255, 255, 255, 0.2)' },
                title: {
                  display: true,
                  text: 'ì²´ì¤‘ (kg)',
                  color: 'white'
                }
              },
              'progress-y-axis': {
                position: 'right',
                min: 0,
                max: 100,
                ticks: { color: 'white' },
                grid: { display: false },
                title: {
                  display: true,
                  text: 'ë‹¬ì„±ë¥  (%)',
                  color: 'white'
                }
              }
            }
          },
          plugins: [ChartDataLabels]
        });

        return () => {
          if (chartRef.current) {
            chartRef.current.destroy();
          }
        };
      }, [data]);

      return <canvas ref={canvasRef} />;
    };

    const MainAppView = () => (
      <div className="p-4 sm:p-8">
        <h1 className="text-3xl sm:text-4xl font-bold text-center mb-6">ê°€ì¡± ê±´ê°• ëŒ€ì‹œë³´ë“œ</h1>
        <p className="text-center text-sm text-gray-400 mb-8">
          í´ë¦­í•˜ì—¬ ì²´ì¤‘ ì •ë³´ë¥¼ ì—…ë°ì´íŠ¸í•˜ì„¸ìš”
        </p>

        {currentMember && (
          <div className="card mb-6">
            <h2 className="text-xl font-semibold mb-2">ë‚˜ì˜ ì •ë³´</h2>
            <p>ì´ë¦„: {currentMember.name || 'ë¯¸ì…ë ¥'}</p>
            <p>í˜„ì¬ ì²´ì¤‘: {currentMember.currentWeight ? `${currentMember.currentWeight} kg` : 'ë¯¸ì…ë ¥'}</p>
            <p>ì´ˆê¸° ì²´ì¤‘: {currentMember.initialWeight ? `${currentMember.initialWeight} kg` : 'ë¯¸ì…ë ¥'}</p>
            <p>ëª©í‘œ ì²´ì¤‘: {currentMember.targetWeight ? `${currentMember.targetWeight} kg` : 'ë¯¸ì…ë ¥'}</p>
          </div>
        )}

        <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
          {familyHealthData.length > 0 ? (
            familyHealthData.map(member => (
              <MemberCard key={member.name} member={member} onClick={handleCardClick} />
            ))
          ) : (
            <div className="col-span-4 text-center text-gray-400">
              <p>ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ì²« ë²ˆì§¸ ë°ì´í„°ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.</p>
            </div>
          )}
        </div>

        <div className="chart-container">
          <BmiChart data={familyHealthData} />
        </div>

        {isInputModalOpen && (
          <div className="modal-overlay">
            <div className="modal-content">
              <h3 className="text-xl font-bold mb-4">{selectedMember.name}ë‹˜ ë°ì´í„° ì…ë ¥</h3>
              <label className="block text-left text-sm mb-2">
                í˜„ì¬ ì²´ì¤‘ (kg)
                <input
                  type="number"
                  className="input-field mt-1"
                  value={inputWeight}
                  onChange={(e) => setInputWeight(e.target.value)}
                  placeholder="ì²´ì¤‘"
                />
              </label>
              <label className="block text-left text-sm mb-2">
                í‚¤ (cm)
                <input
                  type="number"
                  className="input-field mt-1"
                  value={inputHeight}
                  onChange={(e) => setInputHeight(e.target.value)}
                  placeholder="í‚¤"
                />
              </label>
              <label className="block text-left text-sm mb-4">
                ëª©í‘œ ì²´ì¤‘ (kg)
                <input
                  type="number"
                  className="input-field mt-1"
                  value={inputTargetWeight}
                  onChange={(e) => setInputTargetWeight(e.target.value)}
                  placeholder="ëª©í‘œ ì²´ì¤‘"
                />
              </label>
              <div className="flex justify-end gap-2">
                <button onClick={() => setIsInputModalOpen(false)} className="btn bg-gray-600">ì·¨ì†Œ</button>
                <button onClick={handleSave} className="btn bg-green-500">ì €ì¥</button>
              </div>
            </div>
          </div>
        )}
      </div>
    );

    const MainApp = () => {
        return (
            <div>
                {isAuthenticated ? <MainAppView /> : <PasswordScreen />}
            </div>
        );
    };
    
    // ì´ ë¶€ë¶„ì´ ì˜¬ë°”ë¥¸ ì‹¤í–‰ì„ ë³´ì¥í•©ë‹ˆë‹¤.
    const rootElement = document.getElementById('root');
    if (rootElement) {
      createRoot(rootElement).render(<MainApp />);
    } else {
      console.error("Root element not found.");
    }
  };
</script>
</body>
</html>ole.error('Save failed:', e);
          setToast({ message: "ë°ì´í„° ì €ì¥ ì‹¤íŒ¨. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”. âŒ", type: "error" });
        } finally {
          setIsSaving(false);
        }
      };

      const heightM = baseData.height / 100;
      const currentBmi = localData.weight && localData.weight > 0 ? (localData.weight / (heightM * heightM)) : 0;
      const targetBmi = localData.targetWeight ? (localData.targetWeight / (heightM * heightM)) : 0;
      const bmiDifference = targetBmi ? (targetBmi - currentBmi) : null;
      
      const getBmiCategory = (bmi) => {
        if (bmi < 18.5) return { text: 'ì €ì²´ì¤‘', class: 'bmi-excellent', icon: 'ğŸ“‰', color: '#4facfe' };
        if (bmi < 25) return { text: 'ì •ìƒ', class: 'bmi-good', icon: 'âœ…', color: '#43e97b' };
        if (bmi < 30) return { text: 'ê³¼ì²´ì¤‘', class: 'bmi-warning', icon: 'âš ï¸', color: '#feca57' };
        return { text: 'ë¹„ë§Œ', class: 'bmi-danger', icon: 'ğŸ”´', color: '#ff6b6b' };
      };

      const bmiCategory = getBmiCategory(currentBmi);

      // Calculate progress percentage
      const initialWeight = baseData.weight;
      const targetWeight = localData.targetWeight;
      const currentWeight = localData.weight;
      let progress = 0;
      if (targetWeight && initialWeight !== targetWeight) {
        progress = ((currentWeight - initialWeight) / (targetWeight - initialWeight)) * 100;
      }
      progress = Math.min(100, Math.max(0, progress));

      return (
        <div className="glassmorphism rounded-3xl p-6 card-hover fade-in">
          {/* Header */}
          <div className="flex items-center justify-between mb-6">
            <div className="flex items-center space-x-4">
              <div className="text-6xl hover:scale-110 transition-transform cursor-pointer">
                {baseData.emoji}
              </div>
              <div>
                <h2 className="text-2xl font-bold text-white mb-1">{baseData.name}</h2>
                <p className="text-white/70 text-sm mb-2">{baseData.desc}</p>
                <div className="flex flex-wrap gap-2 text-xs">
                  <span className="bg-white/10 px-2 py-1 rounded-full text-white/80">
                    <i className="fas fa-birthday-cake mr-1"></i>{baseData.age}ì„¸
                  </span>
                  <span className="bg-white/10 px-2 py-1 rounded-full text-white/80">
                    <i className="fas fa-ruler-vertical mr-1"></i>{baseData.height}cm
                  </span>
                  <span className="bg-white/10 px-2 py-1 rounded-full text-white/80">
                    <i className="fas fa-briefcase mr-1"></i>{baseData.profession}
                  </span>
                </div>
              </div>
            </div>
          </div>

          {/* BMI Status */}
          <div className="grid grid-cols-2 gap-6 mb-6">
            <div className="text-center">
              <CircularProgress 
                value={currentBmi} 
                maxValue={35} 
                color={bmiCategory.color}
              />
              <p className="text-white/80 text-sm mt-3 font-medium">í˜„ì¬ BMI</p>
            </div>
            <div className="space-y-3">
              <div className={`${bmiCategory.class} rounded-xl p-4 text-center sparkle`}>
                <div className="text-white font-bold text-lg mb-1">
                  {bmiCategory.icon} {bmiCategory.text}
                </div>
                <div className="text-white/90 text-sm">BMI {currentBmi.toFixed(1)}</div>
              </div>
              {targetBmi > 0 && (
                <div className="bg-white/10 rounded-xl p-3 text-center">
                  <div className="text-white/80 text-sm">ëª©í‘œ: {targetBmi.toFixed(1)}</div>
                  <div className="text-white/60 text-xs">
                    {bmiDifference > 0 ? 'â†‘' : 'â†“'} {Math.abs(bmiDifference).toFixed(1)}
                  </div>
                </div>
              )}
            </div>
          </div>
           <button 
                onClick={() => setShowDetails(!showDetails)}
                className="w-full py-3 bg-white/20 text-white font-semibold rounded-2xl mb-4 hover:bg-white/30 transition-all transform hover:scale-105"
            >
                {showDetails ? (
                  <span><i className="fas fa-chevron-up mr-2"></i>ì ‘ê¸°</span>
                ) : (
                  <span><i className="fas fa-chevron-down mr-2"></i>ìƒì„¸ ë³´ê¸°</span>
                )}
            </button>

          {/* Details */}
          {showDetails && (
            <div className="space-y-6 slide-up">
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label className="flex items-center text-white/80 font-medium mb-2 text-sm">
                    <i className="fas fa-weight-scale mr-2"></i>ì´ˆê¸° ì²´ì¤‘ (kg)
                  </label>
                  <p className="w-full p-3 bg-white/10 rounded-xl text-white/80 backdrop-blur-sm">
                    {initialWeight} kg
                  </p>
                </div>
                <div>
                  <label className="flex items-center text-white/80 font-medium mb-2 text-sm">
                    <i className="fas fa-bullseye mr-2"></i>ëª©í‘œ ì²´ì¤‘ (kg)
                  </label>
                  <input 
                    type="number" 
                    value={localData.targetWeight || ''} 
                    onChange={e => handleChange('targetWeight', e.target.value)} 
                    step="0.1" 
                    className="w-full p-3 bg-white/10 border border-white/20 rounded-xl text-white placeholder-white/50 backdrop-blur-sm focus:outline-none focus:border-white/50 focus:bg-white/15 transition-all"
                    placeholder="ëª©í‘œ ì²´ì¤‘"
                  />
                </div>
                <div>
                  <label className="flex items-center text-white/80 font-medium mb-2 text-sm">
                    <i className="fas fa-weight-hanging mr-2"></i>í˜„ì¬ ì²´ì¤‘ (kg)
                  </label>
                  <input 
                    type="number" 
                    value={localData.weight || ''} 
                    onChange={e => handleChange('weight', e.target.value)} 
                    step="0.1" 
                    className="w-full p-3 bg-white/10 border border-white/20 rounded-xl text-white placeholder-white/50 backdrop-blur-sm focus:outline-none focus:border-white/50 focus:bg-white/15 transition-all"
                    placeholder="ì²´ì¤‘ ì…ë ¥"
                  />
                </div>
                <div>
                  <label className="flex items-center text-white/80 font-medium mb-2 text-sm">
                    <i className="fas fa-percentage mr-2"></i>ëª©í‘œ ì§„í–‰ë¥  (%)
                  </label>
                  <p className="w-full p-3 bg-white/10 rounded-xl text-white backdrop-blur-sm">
                    {progress.toFixed(1)} %
                  </p>
                </div>
                <div>
                    <label className="flex items-center text-white/80 font-medium mb-2 text-sm">
                      <i className="fas fa-dumbbell mr-2"></i>ì²´í˜•
                    </label>
                    <select 
                      value={localData.bodyType || 'ë³´í†µ'} 
                      onChange={e => handleChange('bodyType', e.target.value)} 
                      className="w-full p-3 bg-white/10 border border-white/20 rounded-xl text-white backdrop-blur-sm focus:outline-none focus:border-white/50 focus:bg-white/15 transition-all"
                    >
                      <option value="ë³´í†µ">ë³´í†µ</option>
                      <option value="ê·¼ìœ¡í˜•">ê·¼ìœ¡í˜•</option>
                      <option value="ë§ˆë¥¸ ë¹„ë§Œ">ë§ˆë¥¸ ë¹„ë§Œ</option>
                      <option value="ë§ˆë¥¸ ì²´í˜•">ë§ˆë¥¸ ì²´í˜•</option>
                      <option value="ê³¼ì²´ì¤‘">ê³¼ì²´ì¤‘</option>
                    </select>
                </div>
              </div>

              {/* AI Insights */}
              <HealthInsights memberData={localData} baseData={baseData} />

              {/* Save Button */}
              <button 
                onClick={handleSave} 
                disabled={isSaving}
                className="w-full py-4 bg-gradient-to-r from-green-400 to-blue-500 text-white font-bold rounded-2xl sparkle hover:from-green-500 hover:to-blue-600 disabled:opacity-50 transition-all transform hover:scale-105 neon-glow"
              >
                {isSaving ? (
                  <div className="flex items-center justify-center space-x-2">
                    <div className="animate-spin rounded-full h-5 w-5 border-2 border-white border-t-transparent"></div>
                    <span>ì €ì¥ ì¤‘...</span>
                  </div>
                ) : (
                  <span>
                    <i className="fas fa-save mr-2"></i>
                    ë°ì´í„° ì €ì¥í•˜ê¸°
                  </span>
                )}
              </button>
            </div>
          )}
        </div>
      );
    };

    // Main App Component
    const App = () => {
      const [hasAccess, setHasAccess] = useState(false);
      const [data, setData] = useState(initialFamilyData);
      const [authReady, setAuthReady] = useState(false);
      const [userId, setUserId] = useState(null);
      const [toast, setToast] = useState(null);

      // Firebase authentication and data listener setup
      useEffect(() => {
        if (!window.firebase) {
            console.error("Firebase is not loaded.");
            return;
        }

        const { auth, initialAuthToken, signInWithCustomToken, signInAnonymously, onAuthStateChanged, db, appId, collection, onSnapshot } = window.firebase;
        
        // Listen for auth state changes
        const unsubscribeAuth = onAuthStateChanged(auth, async (user) => {
            if (user) {
                setUserId(user.uid);
                setAuthReady(true);
                // Listen for changes in the user's data
                const userHealthRef = collection(db, `artifacts/${appId}/users/${user.uid}/health-data`);
                const unsubscribeSnapshot = onSnapshot(userHealthRef, (snapshot) => {
                    if (!snapshot.empty) {
                        const firebaseData = {};
                        snapshot.docs.forEach(doc => {
                            firebaseData[doc.id] = doc.data();
                        });
                        // Merge initial data with data from Firestore
                        setData(prevData => {
                           const updatedData = { ...prevData };
                           Object.keys(firebaseData).forEach(id => {
                               updatedData[id] = { ...updatedData[id], ...firebaseData[id] };
                           });
                           return updatedData;
                        });
                    }
                }, (error) => {
                    console.error("Failed to listen for data updates:", error);
                    setToast({ message: "ë°ì´í„° ë¡œë”© ì˜¤ë¥˜. ìƒˆë¡œê³ ì¹¨ì„ ì‹œë„í•˜ì„¸ìš”.", type: "error" });
                });
                return () => unsubscribeSnapshot();
            } else {
                setAuthReady(true);
                setUserId(null);
            }
        }, (error) => {
            console.error("Authentication failed:", error);
            setAuthReady(true);
        });
        
        // Sign in with custom token or anonymously
        const authLogin = async () => {
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Authentication error during login:", error);
            }
        };

        if (auth && !auth.currentUser) {
            authLogin();
        }

        return () => unsubscribeAuth();
      }, []);

      useEffect(() => {
        if (toast) {
          const timer = setTimeout(() => setToast(null), 3000);
          return () => clearTimeout(timer);
        }
      }, [toast]);
      
      if (!hasAccess) {
        return <PasswordGate onAccess={setHasAccess} />;
      }
      
      return (
        <div className="min-h-screen animated-bg">
          {toast && <ToastMessage message={toast.message} type={toast.type} onClose={() => setToast(null)} />}
          <div className="p-4 md:p-8 lg:p-12 text-white">
            <header className="text-center py-8">
              <h1 className="text-5xl md:text-6xl font-extrabold mb-2 gradient-text">
                Ultimate Health Dashboard
              </h1>
              <p className="text-lg md:text-xl font-medium text-white/80">
                <i className="fas fa-heartbeat mr-2 pulse"></i> ìš°ë¦¬ ê°€ì¡± ê±´ê°• ê´€ë¦¬
              </p>
              {userId && (
                  <div className="text-xs text-white/50 mt-2 break-all">User ID: {userId}</div>
              )}
            </header>
            <div className="fade-in">
              <div className="grid gap-8 mb-12 lg:grid-cols-2 xl:grid-cols-4">
                {Object.keys(data).map(id => (
                  <FamilyMember
                    key={id}
                    memberData={data[id]}
                    onUpdate={() => {}} // Placeholder, logic is in handleSave
                    baseData={initialFamilyData[id]}
                    setToast={setToast}
                    auth={window.firebase.auth}
                  />
                ))}
              </div>
              <div className="w-full h-[400px] glassmorphism p-4 rounded-3xl">
                {authReady ? (
                  <AdvancedBMIChart familyHealthData={data} initialData={initialFamilyData} />
                ) : (
                  <div className="flex items-center justify-center w-full h-full text-white/70">
                    <div className="animate-spin rounded-full h-10 w-10 border-4 border-white border-t-transparent mr-4"></div>
                    ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...
                  </div>
                )}
              </div>
            </div>
            <footer className="text-center text-white/50 text-sm mt-12 py-4 border-t border-white/20">
              Â© 2025. ìˆ˜ì•„ë™í˜ê°€ì¡±. All Rights Reserved.
              <div className="mt-2 text-xs break-all">ì´ ì•±ì€ íŒŒì´ì–´ë² ì´ìŠ¤ ë°ì´í„°ë² ì´ìŠ¤ì— ë°ì´í„°ë¥¼ ì €ì¥í•©ë‹ˆë‹¤.</div>
            </footer>
          </div>
        </div>
      );
    };

    // Chart.js Component
    const AdvancedBMIChart = ({ familyHealthData, initialData }) => {
      const canvasRef = useRef(null);
      const chartRef = useRef(null);

      useEffect(() => {
        if (!familyHealthData || Object.keys(familyHealthData).length === 0) return;
        
        const ctx = canvasRef.current.getContext('2d');
        
        if (chartRef.current) {
            chartRef.current.destroy();
        }

        const labels = Object.values(familyHealthData).map(member => member.name);
        const currentBmis = Object.values(familyHealthData).map(member => {
          const heightM = initialData[member.id].height / 100;
          return member.weight ? (member.weight / (heightM * heightM)) : 0;
        });
        
        const targetBmis = Object.values(initialData).map(member => member.recommendedBMI);
        
        const progressPercentages = Object.values(familyHealthData).map(member => {
          const initialWeight = initialData[member.id].weight;
          const targetWeight = member.targetWeight;
          const currentWeight = member.weight;
          
          if (!targetWeight || initialWeight === targetWeight) {
            return null;
          }
          
          let progress = ((currentWeight - initialWeight) / (targetWeight - initialWeight)) * 100;
          progress = Math.min(100, Math.max(0, progress));
          return progress;
        });

        chartRef.current = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: labels,
            datasets: [{
              label: 'í˜„ì¬ BMI',
              data: currentBmis,
              backgroundColor: [
                'rgba(75, 192, 192, 0.6)', 
                'rgba(255, 159, 64, 0.6)', 
                'rgba(54, 162, 235, 0.6)', 
                'rgba(153, 102, 255, 0.6)'
              ],
              borderColor: [
                'rgba(75, 192, 192, 1)', 
                'rgba(255, 159, 64, 1)', 
                'rgba(54, 162, 235, 1)', 
                'rgba(153, 102, 255, 1)'
              ],
              borderWidth: 1,
              datalabels: {
                color: 'white',
                anchor: 'end',
                align: 'top',
                offset: 5,
                formatter: (value) => value > 0 ? value.toFixed(1) : ''
              }
            },
            {
              label: 'ëª©í‘œ BMI',
              data: targetBmis,
              backgroundColor: 'rgba(255, 255, 255, 0.2)',
              borderColor: 'rgba(255, 255, 255, 0.8)',
              borderWidth: 2,
              type: 'line',
              fill: false,
              datalabels: {
                display: false
              }
            },
            {
              label: 'ëª©í‘œ ë‹¬ì„±ë¥  (%)',
              data: progressPercentages,
              type: 'line',
              fill: false,
              borderColor: '#f5576c',
              borderWidth: 2,
              borderDash: [5, 5],
              pointBackgroundColor: '#f5576c',
              datalabels: {
                color: '#f5576c',
                anchor: 'start',
                align: 'end',
                offset: 10,
                formatter: (value) => {
                  return value !== null ? `${value.toFixed(0)}%` : '';
                }
              }
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                labels: { color: 'white' }
              },
              title: {
                display: true,
                text: 'ê°€ì¡± BMI ë° ëª©í‘œ ë‹¬ì„±ë¥ ',
                color: 'white',
                font: { size: 18, family: 'Noto Sans KR' }
              }
            },
            scales: {
              x: {
                ticks: { color: 'white' },
                grid: { color: 'rgba(255, 255, 255, 0.2)' }
              },
              y: {
                ticks: { color: 'white' },
                grid: { color: 'rgba(255, 255, 255, 0.2)' },
                min: 15, max: 35
              }
            }
          },
          plugins: [ChartDataLabels]
        });

        return () => {
          if (chartRef.current) {
            chartRef.current.destroy();
          }
        };
      }, [familyHealthData]);

      return <canvas ref={canvasRef} />;
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>               onUpdate={updateData}
                      baseData={initialFamilyData[id]}
                      setToast={setToast}
                    />
                  ))}
                </div>
                <div className="w-full h-[400px] glassmorphism p-4 rounded-3xl">
                  <AdvancedBMIChart familyHealthData={data} />
                </div>
              </div>
            )}
            <footer className="text-center text-white/50 text-sm mt-12 py-4 border-t border-white/20">
              Â© 2025. ìˆ˜ì•„ë™í˜ê°€ì¡±. All Rights Reserved.
              <div className="mt-2 text-xs break-all">User ID: {displayUserId}</div>
            </footer>
          </div>
        </div>
      );
    };

    // Chart.js Component
    const AdvancedBMIChart = ({ familyHealthData }) => {
      const canvasRef = useRef(null);
      const chartRef = useRef(null);

      useEffect(() => {
        if (!familyHealthData || Object.keys(familyHealthData).length === 0) return;
        
        const ctx = canvasRef.current.getContext('2d');
        
        if (chartRef.current) {
            chartRef.current.destroy();
        }

        const labels = Object.values(familyHealthData).map(member => member.name);
        const currentBmis = Object.values(familyHealthData).map(member => {
          const heightM = initialFamilyData[member.id].height / 100;
          return member.weight ? (member.weight / (heightM * heightM)) : 0;
        });
        const targetBmis = Object.values(initialFamilyData).map(member => member.recommendedBMI);
        
        chartRef.current = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: labels,
            datasets: [{
              label: 'í˜„ì¬ BMI',
              data: currentBmis,
              backgroundColor: [
                'rgba(75, 192, 192, 0.6)', 
                'rgba(255, 159, 64, 0.6)', 
                'rgba(54, 162, 235, 0.6)', 
                'rgba(153, 102, 255, 0.6)'
              ],
              borderColor: [
                'rgba(75, 192, 192, 1)', 
                'rgba(255, 159, 64, 1)', 
                'rgba(54, 162, 235, 1)', 
                'rgba(153, 102, 255, 1)'
              ],
              borderWidth: 1
            },
            {
              label: 'ëª©í‘œ BMI',
              data: targetBmis,
              backgroundColor: 'rgba(255, 255, 255, 0.2)',
              borderColor: 'rgba(255, 255, 255, 0.8)',
              borderWidth: 2,
              type: 'line',
              fill: false,
              datalabels: {
                display: false
              }
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                labels: { color: 'white' }
              },
              title: {
                display: true,
                text: 'ê°€ì¡± BMI ì¶”ì´',
                color: 'white',
                font: { size: 18, family: 'Noto Sans KR' }
              },
              datalabels: {
                color: 'white',
                anchor: 'end',
                align: 'top',
                formatter: (value) => value.toFixed(1)
              }
            },
            scales: {
              x: {
                ticks: { color: 'white' },
                grid: { color: 'rgba(255, 255, 255, 0.2)' }
              },
              y: {
                ticks: { color: 'white' },
                grid: { color: 'rgba(255, 255, 255, 0.2)' },
                min: 15, max: 35
              }
            }
          },
          plugins: [ChartDataLabels]
        });

        return () => {
          if (chartRef.current) {
            chartRef.current.destroy();
          }
        };
      }, [familyHealthData]);

      return <canvas ref={canvasRef} />;
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>