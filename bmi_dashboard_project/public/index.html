<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ìˆ˜ì•„ë™í˜ê°€ì¡± BMI ë¹„êµUIëŒ€ì‹œë³´ë“œAI - ë°°í¬ìš©</title>
  <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.2.1/dist/chartjs-plugin-annotation.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>body{font-family:Inter,ui-sans-serif,system-ui,-apple-system,'Segoe UI',Roboto,'Helvetica Neue',Arial}</style>

  <!-- Firebase ì„¤ì • JSONì„ ì—¬ê¸°ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš” -->
  <!-- ì˜ˆì‹œ:
  <script>
    const __firebase_config = '{"apiKey":"...","authDomain":"...","projectId":"...","storageBucket":"...","messagingSenderId":"...","appId":"..."}';
  </script>
  -->

</head>
<body class="bg-slate-100 dark:bg-slate-900 text-slate-800 dark:text-slate-200">
  <div id="root"></div>

  <script type="module">
    try {
      if (typeof __firebase_config === 'undefined') {
        console.warn('ê²½ê³ : __firebase_config ê°€ ì •ì˜ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤. ì‹¤ì‹œê°„ ì €ì¥ ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ë ¤ë©´ Firebase ì„¤ì •ì„ ì‚½ì…í•˜ì„¸ìš”.');
      }
    } catch(e) { console.warn(e); }

    import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
    import { getAuth, signInAnonymously, signInWithCustomToken } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
    import { getFirestore, doc, setDoc, onSnapshot, collection } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

    window.firebaseRuntime = { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, getFirestore, doc, setDoc, onSnapshot, collection };

    window.initFirebaseApp = function() {
      if (typeof __firebase_config === 'undefined') return null;
      let cfg;
      try { cfg = JSON.parse(__firebase_config); } catch(e) { console.error('Firebase config JSON íŒŒì‹± ì‹¤íŒ¨:', e); return null; }
      try { return initializeApp(cfg); } catch(e) { console.error('Firebase ì´ˆê¸°í™” ì‹¤íŒ¨:', e); return null; }
    };
  </script>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    const initialFamilyData = {
      dad: { id: 'dad', name: 'ë¯¼ì² ', emoji: 'ğŸ‘¨â€ğŸ¦³', dob: '1971-05-05', height: 178, weight: 95, age: 54, desc: 'ë°±ë°œ, í˜„ì¬ ì§‘ì—ë§Œ ê³„ì‹¬', recommendedWeight: 79.2, recommendedBMI: 25 },
      mom: { id: 'mom', name: 'ì„ ì˜', emoji: 'ğŸ‘©â€ğŸ’¼', dob: '1970-11-15', height: 177, weight: 75, age: 54, desc: 'êµ­ë¯¼ì€í–‰ ë¶€ì§€ì ì¥, í†µë¼ˆ', recommendedWeight: 72.1, recommendedBMI: 23 },
      daughter: { id: 'daughter', name: 'ìˆ˜ì•„', emoji: 'ğŸ€', dob: '2005-01-09', height: 171, weight: 71, age: 20, desc: 'í•œêµ­ì²´ëŒ€ 3í•™ë…„, ë†êµ¬ ì£¼ì „ ì„¼í„°', recommendedWeight: 70.2, recommendedBMI: 24 },
      son: { id: 'son', name: 'ë™í˜', emoji: 'âœˆï¸', dob: '2007-02-19', height: 187, weight: 71, age: 18, desc: 'ê³ 3 ìˆ˜í—˜ìƒ, ìŠ¤íŠœì–´ë“œ í¬ë§', recommendedWeight: 76.9, recommendedBMI: 22 }
    };

    const FamilyMember = ({ memberData, onUpdate, baseData }) => {
      const [localData, setLocalData] = useState(memberData);
      useEffect(() => setLocalData(memberData), [memberData]);
      const handleChange = (field, value) => setLocalData(prev => ({ ...prev, [field]: value }));
      const calculateBMI = (dataToSave) => {
        if (!dataToSave.weight || dataToSave.weight <= 0) return;
        onUpdate({ ...dataToSave, id: baseData.id });
      };
      const heightM = baseData.height / 100;
      const currentBmi = localData.weight ? (localData.weight / (heightM * heightM)).toFixed(2) : 'N/A';
      let category = 'N/A';
      if (currentBmi !== 'N/A') { category = currentBmi < 18.5 ? 'ì €ì²´ì¤‘' : currentBmi < 25 ? 'ì •ìƒ' : currentBmi < 30 ? 'ê³¼ì²´ì¤‘' : 'ë¹„ë§Œ'; }

      return (
        <div className="bg-white dark:bg-slate-800 rounded-xl shadow-lg p-6 space-y-4">
          <div className="flex items-center space-x-3">
            <span className="text-4xl">{baseData.emoji}</span>
            <div>
              <h2 className="text-2xl font-bold text-indigo-600 dark:text-indigo-400">{baseData.name} ({baseData.age}ì„¸)</h2>
              <p className="text-sm text-slate-500 dark:text-slate-400">{baseData.desc}</p>
            </div>
          </div>
          <div className="bg-indigo-50 dark:bg-indigo-900/50 p-3 rounded-lg text-center">
            <p className="text-sm text-indigo-800 dark:text-indigo-200 font-semibold">í˜„ì¬ BMI: {currentBmi} ({category})</p>
          </div>

          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label className="block text-sm font-semibold mb-1 text-slate-600 dark:text-slate-300">í˜„ì¬ ì²´ì¤‘ (kg):</label>
              <input type="number" value={localData.weight || ''} onChange={e => handleChange('weight', e.target.value)} step="0.1" className="w-full p-2 border rounded-md" />
            </div>
            <div>
              <label className="block text-sm font-semibold mb-1 text-slate-600 dark:text-slate-300">ëª©í‘œ ì²´ì¤‘ (kg):</label>
              <input type="number" value={localData.targetWeight || ''} onChange={e => handleChange('targetWeight', e.target.value)} step="0.1" className="w-full p-2 border rounded-md" />
            </div>
            <div>
              <label className="block text-sm font-semibold mb-1 text-slate-600 dark:text-slate-300">ì¸¡ì • ë‚ ì§œ:</label>
              <input type="date" value={localData.date || ''} onChange={e => handleChange('date', e.target.value)} className="w-full p-2 border rounded-md" />
            </div>
            <div>
              <label className="block text-sm font-semibold mb-1 text-slate-600 dark:text-slate-300">ì²´í˜• ì„ íƒ:</label>
              <select value={localData.bodyType || 'normal'} onChange={e => handleChange('bodyType', e.target.value)} className="w-full p-2 border rounded-md">
                <option value="normal">ë³´í†µ</option><option value="muscle">í†µë¼ˆ/ê·¼ìœ¡í˜•</option><option value="slim">ë§ˆë¥¸ ì²´í˜•</option><option value="obese">ë¹„ë§Œ ì²´í˜•</option>
              </select>
            </div>
          </div>

          <button onClick={() => calculateBMI(localData)} className="w-full bg-indigo-600 text-white p-3 rounded-lg">ì‹¤ì‹œê°„ ì €ì¥</button>
        </div>
      );
    };

    const BMIGraph = ({ familyHealthData }) => {
      const chartRef = useRef(null);
      const chartInstance = useRef(null);
      useEffect(() => {
        if (!familyHealthData) return;
        Chart.register(ChartDataLabels);
        const labels = Object.values(initialFamilyData).map(d => d.name);
        const createDataset = (dataKey, defaultKey) => Object.keys(initialFamilyData).map(id => {
          const memberData = familyHealthData[id] || {};
          const weight = parseFloat(memberData[dataKey]) || parseFloat(memberData[defaultKey]) || initialFamilyData[id].weight;
          const height = initialFamilyData[id].height / 100;
          return (weight / (height * height)).toFixed(2);
        });
        const currentBmis = createDataset('weight', 'weight');
        const targetBmis = createDataset('targetWeight', 'weight');
        const recommendedBmis = Object.values(initialFamilyData).map(d => d.recommendedBMI);
        const currentWeights = Object.keys(initialFamilyData).map(id => { const m = familyHealthData[id] || {}; const w = parseFloat(m.weight) || initialFamilyData[id].weight; return w.toFixed(1); });
        const targetWeights = Object.keys(initialFamilyData).map(id => { const m = familyHealthData[id] || {}; const w = parseFloat(m.targetWeight) || initialFamilyData[id].weight; return w.toFixed(1); });
        const recommendedWeights = Object.values(initialFamilyData).map(d => d.recommendedWeight.toFixed(1));

        if (chartInstance.current) chartInstance.current.destroy();
        chartInstance.current = new Chart(chartRef.current, {
          type: 'line', data: { labels, datasets: [
            { label: 'í˜„ì¬ BMI', data: currentBmis, borderColor: '#14b8a6', backgroundColor: '#14b8a6', tension: 0.2, datalabels: { formatter: (v, c) => `${v} (${currentWeights[c.dataIndex]}kg)` } },
            { label: 'ëª©í‘œ BMI', data: targetBmis, borderColor: '#f43f5e', backgroundColor: '#f43f5e', tension: 0.2, datalabels: { formatter: (v, c) => `${v} (${targetWeights[c.dataIndex]}kg)` } },
            { label: 'AI ì¶”ì²œ BMI', data: recommendedBmis, borderColor: '#3b82f6', backgroundColor: '#3b82f6', tension: 0.2, datalabels: { formatter: (v, c) => `${v} (${recommendedWeights[c.dataIndex]}kg)` } }
          ]},
          options: {
            responsive: true, maintainAspectRatio: false,
            scales: { y: { beginAtZero: false, min: 15, max: 35 } },
            plugins: { legend: { position: 'top' }, title: { display: true, text: 'ê°€ì¡± BMI í†µí•© ê·¸ë˜í”„' }, datalabels: { align: 'top' } }
          }
        });
      }, [familyHealthData]);
      return <div className="h-80 md:h-96"><canvas ref={chartRef}></canvas></div>;
    };

    const InfoTables = () => (
      <div className="bg-white dark:bg-slate-800 rounded-xl shadow-lg p-6 space-y-6">
        <div>
          <h3 className="text-xl font-bold text-indigo-600 mb-2">ğŸ“Š BMI ê¸°ì¤€ ì •ë³´</h3>
          <p className="text-sm text-slate-500 mb-4">BMI = ì²´ì¤‘(kg) Ã· (í‚¤(m) Ã— í‚¤(m))</p>
        </div>
      </div>
    );

    const App = () => {
      const [db, setDb] = useState(null);
      const [userId, setUserId] = useState(null);
      const [familyHealthData, setFamilyHealthData] = useState({});
      const [loading, setLoading] = useState(true);
      const [error, setError] = useState(null);

      useEffect(() => {
        const app = window.initFirebaseApp();
        if (!app) { setLoading(false); return; }
        const auth = window.firebaseRuntime.getAuth(app);
        const firestoreDb = window.firebaseRuntime.getFirestore(app);
        setDb(firestoreDb);
        window.firebaseRuntime.signInAnonymously(auth).then(cred => { if (cred && cred.user) setUserId(cred.user.uid); }).catch(e => { console.error(e); setError('ìµëª… ë¡œê·¸ì¸ ì‹¤íŒ¨'); setLoading(false); });
      }, []);

      useEffect(() => {
        if (!db) return;
        setLoading(true);
        const appId = 'family-bmi-dashboard';
        const collectionPath = `artifacts/${appId}/public/data/familyHealth`;
        const collectionRef = window.firebaseRuntime.collection(db, collectionPath);
        const unsubscribes = Object.keys(initialFamilyData).map(memberId => {
          const docRef = window.firebaseRuntime.doc(collectionRef, memberId);
          return window.firebaseRuntime.onSnapshot(docRef, (docSnap) => {
            if (docSnap.exists()) {
              setFamilyHealthData(prev => ({ ...prev, [memberId]: docSnap.data() }));
            } else {
              const initialMemberData = { weight: initialFamilyData[memberId].weight, targetWeight: '', date: new Date().toISOString().split('T')[0], bodyType: 'normal' };
              window.firebaseRuntime.setDoc(docRef, initialMemberData);
            }
          }, (err) => { console.error('ë°ì´í„° ìˆ˜ì‹  ì˜¤ë¥˜', err); setError('ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'); });
        });
        setLoading(false);
        return () => unsubscribes.forEach(u => u && u());
      }, [db]);

      const handleUpdateMember = async (dataToSave) => {
        if (!db) return;
        try {
          const appId = 'family-bmi-dashboard';
          const collectionPath = `artifacts/${appId}/public/data/familyHealth`;
          const docRef = window.firebaseRuntime.doc(db, collectionPath, dataToSave.id);
          await window.firebaseRuntime.setDoc(docRef, dataToSave, { merge: true });
        } catch(e) { console.error('ì €ì¥ ì˜¤ë¥˜', e); setError('ë°ì´í„° ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'); }
      };

      if (loading) return <div className="p-10 text-center">ë¡œë”© ì¤‘...</div>;
      if (error) return <div className="p-10 text-center text-red-500">{error}</div>;

      return (
        <main className="container mx-auto px-4 py-8">
          <header className="text-center mb-8">
            <h1 className="text-3xl font-extrabold text-slate-800 mb-2">ìˆ˜ì•„ë™í˜ê°€ì¡± BMI ë¹„êµUIëŒ€ì‹œë³´ë“œAI</h1>
            <p className="text-md text-slate-600">ìš°ë¦¬ ê°€ì¡± ê±´ê°•, ì‹¤ì‹œê°„ìœ¼ë¡œ í•¨ê»˜ ê´€ë¦¬í•´ìš”!</p>
          </header>
          <div className="bg-white rounded-xl shadow-lg p-4 mb-8"><BMIGraph familyHealthData={familyHealthData} /></div>
          <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            {Object.keys(initialFamilyData).map(id => (
              <FamilyMember key={id} baseData={initialFamilyData[id]} memberData={{...initialFamilyData[id], ...familyHealthData[id]}} onUpdate={handleUpdateMember} />
            ))}
          </div>
          <InfoTables />
        </main>
      );
    };

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
