<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ÏàòÏïÑÎèôÌòÅÍ∞ÄÏ°± Ultimate BMI Dashboard (Firebase)</title>
  <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  
  <!-- Firebase SDK is imported and initialized globally -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, onSnapshot, collection, query, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Global variables from the hosting environment
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    setLogLevel('debug'); // Enable debug logging for Firestore

    window.firebase = {
      app,
      db,
      auth,
      appId,
      initialAuthToken,
      signInWithCustomToken,
      signInAnonymously,
      onAuthStateChanged,
      collection,
      doc,
      setDoc,
      onSnapshot,
      query,
    };
  </script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700;800&display=swap');
    
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body { 
      font-family: 'Noto Sans KR', sans-serif;
      min-height: 100vh;
      overflow-x: hidden;
      background: #242943;
    }

    .animated-bg {
      background: linear-gradient(-45deg, #667eea, #764ba2, #f093fb, #f5576c);
      background-size: 400% 400%;
      animation: gradientMove 15s ease infinite;
    }

    @keyframes gradientMove {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    .glassmorphism {
      background: rgba(255, 255, 255, 0.15);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
    }

    .card-hover {
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .card-hover:hover {
      transform: translateY(-10px) scale(1.02);
      box-shadow: 0 25px 50px rgba(0,0,0,0.2);
    }

    .neon-glow {
      box-shadow: 0 0 20px rgba(102, 126, 234, 0.6),
                  0 0 40px rgba(102, 126, 234, 0.4),
                  0 0 60px rgba(102, 126, 234, 0.2);
    }

    .pulse { animation: pulse 2s infinite; }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }

    .float { animation: float 6s ease-in-out infinite; }
    @keyframes float {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-20px); }
      100% { transform: translateY(0px); }
    }

    .sparkle {
      position: relative;
      overflow: hidden;
    }
    
    .sparkle::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
      animation: sparkle 3s infinite;
    }

    @keyframes sparkle {
      0% { left: -100%; }
      100% { left: 100%; }
    }

    .gradient-text {
      background: linear-gradient(45deg, #ff6b6b, #4ecdc4, #45b7d1, #feca57);
      background-size: 300% 300%;
      animation: gradientText 3s ease-in-out infinite;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    @keyframes gradientText {
      0%, 100% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    .bmi-excellent { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
    .bmi-good { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); }
    .bmi-warning { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); }
    .bmi-danger { background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%); }

    .progress-circle {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      background: conic-gradient(#4facfe 0deg, #4facfe var(--progress), rgba(255,255,255,0.2) var(--progress));
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }

    .progress-circle::before {
      content: '';
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: rgba(255,255,255,0.9);
      position: absolute;
    }

    .progress-value {
      position: relative;
      z-index: 1;
      font-weight: bold;
      color: #333;
    }

    .fade-in {
      animation: fadeIn 0.6s ease-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .slide-up {
      animation: slideUp 0.5s ease-out;
    }

    @keyframes slideUp {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .toast-enter {
      animation: toastIn 0.5s ease-out forwards;
    }
    
    .toast-exit {
      animation: toastOut 0.5s ease-in forwards;
    }

    @keyframes toastIn {
      from { transform: translateY(-100%); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    @keyframes toastOut {
      from { transform: translateY(0); opacity: 1; }
      to { transform: translateY(-100%); opacity: 0; }
    }

    @media (max-width: 768px) {
      .glassmorphism {
        backdrop-filter: blur(10px);
      }
      .card-hover:hover {
        transform: translateY(-5px) scale(1.01);
      }
    }
  </style>
</head>

<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef, useMemo } = React;

    const initialFamilyData = {
      dad: { 
        id: 'dad', name: 'ÎØºÏ≤†', emoji: 'üë®‚Äçü¶≥', dob: '1971-05-05', height: 178, weight: 95, age: 54, 
        desc: 'Î∞±Î∞ú, ÌòÑÏû¨ ÏßëÏóêÎßå Í≥ÑÏã¨', recommendedWeight: 79.2, recommendedBMI: 25,
        profession: 'Ìú¥ÏãùÏ§ë', healthGoal: 'Ï≤¥Ï§ëÍ∞êÎüâ', activityLevel: 'low', bodyType: 'ÎßàÎ•∏ ÎπÑÎßå'
      },
      mom: { 
        id: 'mom', name: 'ÏÑ†ÏòÅ', emoji: 'üë©‚Äçüíº', dob: '1970-11-15', height: 177, weight: 75, age: 54, 
        desc: 'Íµ≠ÎØºÏùÄÌñâ Î∂ÄÏßÄÏ†êÏû•, ÌÜµÎºà', recommendedWeight: 72.1, recommendedBMI: 23,
        profession: 'ÏùÄÌñâÏõê', healthGoal: 'Í±¥Í∞ïÏú†ÏßÄ', activityLevel: 'medium', bodyType: 'Í∑ºÏú°Ìòï'
      },
      daughter: { 
        id: 'daughter', name: 'ÏàòÏïÑ', emoji: 'üèÄ', dob: '2005-01-09', height: 171, weight: 71, age: 20, 
        desc: 'ÌïúÍµ≠Ï≤¥ÎåÄ 3ÌïôÎÖÑ, ÎÜçÍµ¨ Ï£ºÏ†Ñ ÏÑºÌÑ∞', recommendedWeight: 70.2, recommendedBMI: 24,
        profession: 'ÌïôÏÉù-Ï≤¥Ïú°', healthGoal: 'Í∑ºÎ†•Ï¶ùÍ∞Ä', activityLevel: 'high', bodyType: 'Í∑ºÏú°Ìòï'
      },
      son: { 
        id: 'son', name: 'ÎèôÌòÅ', emoji: '‚úàÔ∏è', dob: '2007-02-19', height: 187, weight: 71, age: 18, 
        desc: 'Í≥†3 ÏàòÌóòÏÉù, Ïä§ÌäúÏñ¥Îìú Ìù¨Îßù', recommendedWeight: 76.9, recommendedBMI: 22,
        profession: 'ÌïôÏÉù-Í≥†3', healthGoal: 'Ï≤¥Ï§ëÏ¶ùÍ∞Ä', activityLevel: 'low', bodyType: 'ÎßàÎ•∏ Ï≤¥Ìòï'
      }
    };
    
    // Password Gate Component
    const PasswordGate = ({ onAccess }) => {
      const [input, setInput] = useState("");
      const [error, setError] = useState("");
      const [isVerifying, setIsVerifying] = useState(false);
      const familyPassword = "1115";

      const handleSubmit = (e) => {
        e.preventDefault();
        setIsVerifying(true);
        setError("");
        
        setTimeout(() => {
          if (input === familyPassword) {
            onAccess(true);
          } else {
            setError("ÎπÑÎ∞ÄÎ≤àÌò∏Í∞Ä ÌãÄÎ†∏ÏäµÎãàÎã§ ‚ùå");
            setIsVerifying(false);
          }
        }, 500);
      };
      
      return (
        <div className="min-h-screen flex items-center justify-center p-4">
          <div className="glassmorphism rounded-3xl p-8 w-full max-w-md float">
            <div className="text-center mb-8">
              <div className="text-7xl mb-6 pulse">üè†</div>
              <h1 className="text-4xl font-bold text-white mb-3 gradient-text">Í∞ÄÏ°± Ï†ÑÏö©</h1>
              <h2 className="text-xl text-white/80 font-medium">Ultimate Health Dashboard</h2>
              <p className="text-white/60 text-sm mt-2">Ïö∞Î¶¨ Í∞ÄÏ°±ÎßåÏùò ÌäπÎ≥ÑÌïú Í±¥Í∞ï Í¥ÄÎ¶¨ Í≥µÍ∞Ñ</p>
            </div>
            
            <form onSubmit={handleSubmit} className="space-y-6">
              <div className="relative group">
                <i className="fas fa-lock absolute left-4 top-1/2 transform -translate-y-1/2 text-white/60 group-focus-within:text-white/80 transition-colors"></i>
                <input 
                  type="password" 
                  placeholder="Í∞ÄÏ°± ÎπÑÎ∞ÄÎ≤àÌò∏Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî" 
                  value={input} 
                  onChange={e => setInput(e.target.value)}
                  className="w-full pl-12 pr-4 py-4 bg-white/10 border border-white/20 rounded-2xl text-white placeholder-white/50 backdrop-blur-sm focus:outline-none focus:border-white/50 focus:bg-white/15 transition-all"
                  disabled={isVerifying}
                />
              </div>
              
              {error && (
                <div className="text-red-300 text-center bg-red-500/20 py-3 px-4 rounded-xl border border-red-400/30 fade-in">
                  <i className="fas fa-exclamation-triangle mr-2"></i>
                  {error}
                </div>
              )}
              
              <button 
                type="submit" 
                disabled={isVerifying}
                className="w-full py-4 bg-gradient-to-r from-purple-500 to-pink-500 text-white font-bold rounded-2xl sparkle hover:from-purple-600 hover:to-pink-600 disabled:opacity-50 transition-all transform hover:scale-105 neon-glow"
              >
                {isVerifying ? (
                  <div className="flex items-center justify-center space-x-2">
                    <div className="animate-spin rounded-full h-5 w-5 border-2 border-white border-t-transparent"></div>
                    <span>Ïù∏Ï¶ù Ï§ë...</span>
                  </div>
                ) : (
                  <span><i className="fas fa-door-open mr-2"></i>ÏûÖÏû•ÌïòÍ∏∞</span>
                )}
              </button>
            </form>
            
            <div className="text-center mt-6 text-white/50 text-sm">
              <i className="fas fa-shield-alt mr-1"></i>
              ÏïàÏ†ÑÌïú Î°úÏª¨ Ï†ëÏÜç
            </div>
          </div>
        </div>
      );
    };

    // Circular Progress Chart for BMI
    const CircularProgress = ({ value, maxValue, size = 120, color = "#4facfe" }) => {
      const percentage = Math.min((value / maxValue) * 100, 100);
      const degrees = (percentage / 100) * 360;
      
      return (
        <div 
          className="progress-circle" 
          style={{ '--progress': `${degrees}deg` }}
        >
          <div className="progress-value text-xl font-bold">
            {value.toFixed(1)}
          </div>
        </div>
      );
    };
    
    // Toast Notification Component
    const ToastMessage = ({ message, type, onClose }) => {
      const icon = type === 'success' ? '‚úÖ' : '‚ùå';
      const color = type === 'success' ? 'bg-green-500/20 text-green-300' : 'bg-red-500/20 text-red-300';

      return (
        <div className={`fixed top-4 left-1/2 -translate-x-1/2 z-50 p-4 rounded-xl shadow-lg border ${color} fade-in`}>
          <div className="flex items-center space-x-2">
            <span>{icon}</span>
            <span className="text-sm font-medium">{message}</span>
            <button onClick={onClose} className="text-white/60 hover:text-white/80 transition-colors ml-2">
              <i className="fas fa-times"></i>
            </button>
          </div>
        </div>
      );
    };

    // AI Health Insights Component
    const HealthInsights = ({ memberData, baseData }) => {
      const insights = useMemo(() => {
        const heightM = baseData.height / 100;
        const currentBmi = memberData.weight ? (memberData.weight / (heightM * heightM)) : 0;
        const recommendations = [];
        const tips = [];
        
        // BMI based recommendations
        if (currentBmi < 18.5) {
          recommendations.push("üí™ Ï≤¥Ï§ë Ï¶ùÍ∞ÄÎ•º ÏúÑÌïú Í∑ºÎ†• Ïö¥ÎèôÍ≥º Îã®Î∞±Ïßà ÏÑ≠Ï∑®Î•º ÎäòÎ†§Î≥¥ÏÑ∏Ïöî");
        } else if (currentBmi > 25) {
          recommendations.push("üèÉ‚Äç‚ôÄÔ∏è Ïú†ÏÇ∞ÏÜå Ïö¥ÎèôÍ≥º ÏãùÎã® Ï°∞Ï†àÎ°ú Í±¥Í∞ïÌïú Ï≤¥Ï§ë Í∞êÎüâÏùÑ Ìï¥Î≥¥ÏÑ∏Ïöî");
        } else {
          recommendations.push("‚ú® ÌòÑÏû¨ Í±¥Í∞ïÌïú Ï≤¥Ï§ëÏùÑ Ïûò Ïú†ÏßÄÌïòÍ≥† ÏûàÏñ¥Ïöî!");
        }
        
        // Weight difference based recommendation
        if (memberData.targetWeight && memberData.weight > 0) {
          const weightDiff = memberData.targetWeight - memberData.weight;
          if (Math.abs(weightDiff) > 5) {
            recommendations.push(`üéØ Î™©ÌëúÍπåÏßÄ ${Math.abs(weightDiff).toFixed(1)}kg, Ïõî 1-2kgÏî© ${weightDiff > 0 ? 'Ï¶ùÍ∞Ä' : 'Í∞êÏÜå'}Í∞Ä Í±¥Í∞ïÌï¥Ïöî`);
          }
        }

        // Body type and activity level based tips
        if (memberData.bodyType === 'Í∑ºÏú°Ìòï') {
            tips.push("üèãÔ∏è‚Äç‚ôÇÔ∏è Í∑ºÏú°ÎüâÏù¥ ÎßéÏïÑ Ï≤¥Ï§ëÏù¥ ÎÜíÏùÑ Ïàò ÏûàÏñ¥Ïöî. Îã®Î∞±Ïßà ÏúÑÏ£º ÏãùÎã®Í≥º Ïä§Ìä∏Î†àÏπ≠ÏùÑ Î≥ëÌñâÌïòÏÑ∏Ïöî.");
        } else if (memberData.bodyType === 'ÎßàÎ•∏ ÎπÑÎßå') {
            tips.push("üçé Ï≤¥ÏßÄÎ∞©ÏùÑ Ï§ÑÏù¥Í≥† Í∑ºÏú°ÏùÑ ÌÇ§Ïö∞Îäî Í≤ÉÏù¥ Ï§ëÏöîÌï¥Ïöî. Í∑úÏπôÏ†ÅÏù∏ ÏãùÏÇ¨ÏôÄ Í∑ºÎ†• Ïö¥ÎèôÏù¥ ÌïÑÏàò!");
        } else if (memberData.bodyType === 'ÎßàÎ•∏ Ï≤¥Ìòï') {
            tips.push("üçΩÔ∏è Í±¥Í∞ïÌïú ÌÉÑÏàòÌôîÎ¨ºÍ≥º Îã®Î∞±Ïßà ÏÑ≠Ï∑®Î°ú Ï≤¥Ï§ëÏùÑ ÎäòÎ†§Î≥¥ÏÑ∏Ïöî. ÎÅºÎãàÎ•º Í±∞Î•¥ÏßÄ ÏïäÎäî Í≤ÉÏù¥ Ï§ëÏöîÌï¥Ïöî.");
        } else if (memberData.bodyType === 'Î≥¥ÌÜµ') {
            tips.push("üëå ÌòÑÏû¨ Í±¥Í∞ïÌïú ÏÉÅÌÉúÎ•º Ïûò Ïú†ÏßÄÌïòÍ≥† ÏûàÏñ¥Ïöî. Íæ∏Ï§ÄÌïú Í¥ÄÎ¶¨Î°ú ÌòÑÏû¨ ÏÉÅÌÉúÎ•º Ïú†ÏßÄÌïòÏÑ∏Ïöî.");
        } else if (memberData.bodyType === 'Í≥ºÏ≤¥Ï§ë') {
            tips.push("üèÉ‚Äç‚ôÇÔ∏è Ïú†ÏÇ∞ÏÜå Ïö¥ÎèôÍ≥º Ìï®Íªò Í±¥Í∞ïÌïú ÏãùÎã®ÏúºÎ°ú Ï≤¥Ï§ëÏùÑ Í¥ÄÎ¶¨Ìï¥ Î≥¥ÏÑ∏Ïöî.");
        }

        if (baseData.activityLevel === 'high') {
          tips.push("‚ö° Ïö¥ÎèôÎüâÏù¥ ÎßéÏúºÎãà Ï∂©Î∂ÑÌïú Ìú¥ÏãùÍ≥º ÏòÅÏñë Î≥¥Ï∂©Ïù¥ Ï§ëÏöîÌï¥Ïöî");
        } else if (baseData.activityLevel === 'low') {
          tips.push("üö∂‚Äç‚ôÄÔ∏è ÏùºÏùº ÎßåÎ≥¥ Í±∑Í∏∞Î∂ÄÌÑ∞ ÏãúÏûëÌï¥Î≥¥Îäî Í≤ÉÏùÄ Ïñ¥Îñ®ÍπåÏöî?");
        }
        
        return { recommendations, tips };
      }, [memberData, baseData]);

      return (
        <div className="glassmorphism rounded-2xl p-4 mt-4 slide-up">
          <h4 className="text-white font-semibold mb-3 flex items-center">
            <i className="fas fa-brain mr-2 text-purple-300"></i>
            AI Í±¥Í∞ï Ïù∏ÏÇ¨Ïù¥Ìä∏
          </h4>
          <div className="space-y-3">
            {insights.recommendations.map((rec, idx) => (
              <div key={idx} className="text-white/90 text-sm bg-white/10 rounded-lg p-3 border-l-4 border-blue-400">
                {rec}
              </div>
            ))}
            {insights.tips.map((tip, idx) => (
              <div key={idx} className="text-white/80 text-xs bg-white/5 rounded-lg p-2 border border-white/10">
                {tip}
              </div>
            ))}
          </div>
        </div>
      );
    };

    // Family Member Card Component
    const FamilyMember = ({ memberData, onUpdate, baseData, setToast, auth }) => {
      const [localData, setLocalData] = useState(memberData);
      const [isSaving, setIsSaving] = useState(false);
      const [showDetails, setShowDetails] = useState(false);

      useEffect(() => {
        if (memberData !== localData) {
          setLocalData(memberData);
        }
      }, [memberData]);

      const handleChange = (field, value) => setLocalData(prev => ({ ...prev, [field]: value }));

      const handleSave = async () => {
        if (!auth.currentUser) {
            setToast({ message: "ÏÇ¨Ïö©Ïûê Ïù∏Ï¶ùÏù¥ ÌïÑÏöîÌï©ÎãàÎã§. ‚ùå", type: "error" });
            return;
        }

        const weight = Number(localData.weight);
        if (isNaN(weight) || weight <= 0) {
          setToast({ message: "Ï≤¥Ï§ëÏùÑ Ï†ïÌôïÌïòÍ≤å ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.", type: "error" });
          return;
        }
        
        setIsSaving(true);
        try {
          const { db, appId, doc, setDoc } = window.firebase;
          const userId = auth.currentUser.uid;
          const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/health-data`, baseData.id);
          
          await setDoc(userDocRef, {
            ...localData,
            weight: weight,
            targetWeight: Number(localData.targetWeight)
          }, { merge: true });

          setToast({ message: "Îç∞Ïù¥ÌÑ∞Í∞Ä ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§! ‚úÖ", type: "success" });
        } catch (e) {
          console.error('Save failed:', e);
          setToast({ message: "Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû• Ïã§Ìå®. Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî. ‚ùå", type: "error" });
        } finally {
          setIsSaving(false);
        }
      };

      const heightM = baseData.height / 100;
      const currentBmi = localData.weight && localData.weight > 0 ? (localData.weight / (heightM * heightM)) : 0;
      const targetBmi = localData.targetWeight ? (localData.targetWeight / (heightM * heightM)) : 0;
      const bmiDifference = targetBmi ? (targetBmi - currentBmi) : null;
      
      const getBmiCategory = (bmi) => {
        if (bmi < 18.5) return { text: 'Ï†ÄÏ≤¥Ï§ë', class: 'bmi-excellent', icon: 'üìâ', color: '#4facfe' };
        if (bmi < 25) return { text: 'Ï†ïÏÉÅ', class: 'bmi-good', icon: '‚úÖ', color: '#43e97b' };
        if (bmi < 30) return { text: 'Í≥ºÏ≤¥Ï§ë', class: 'bmi-warning', icon: '‚ö†Ô∏è', color: '#feca57' };
        return { text: 'ÎπÑÎßå', class: 'bmi-danger', icon: 'üî¥', color: '#ff6b6b' };
      };

      const bmiCategory = getBmiCategory(currentBmi);

      // Calculate progress percentage
      const initialWeight = baseData.weight;
      const targetWeight = localData.targetWeight;
      const currentWeight = localData.weight;
      let progress = 0;
      if (targetWeight && initialWeight !== targetWeight) {
        progress = ((currentWeight - initialWeight) / (targetWeight - initialWeight)) * 100;
      }
      progress = Math.min(100, Math.max(0, progress));

      return (
        <div className="glassmorphism rounded-3xl p-6 card-hover fade-in">
          {/* Header */}
          <div className="flex items-center justify-between mb-6">
            <div className="flex items-center space-x-4">
              <div className="text-6xl hover:scale-110 transition-transform cursor-pointer">
                {baseData.emoji}
              </div>
              <div>
                <h2 className="text-2xl font-bold text-white mb-1">{baseData.name}</h2>
                <p className="text-white/70 text-sm mb-2">{baseData.desc}</p>
                <div className="flex flex-wrap gap-2 text-xs">
                  <span className="bg-white/10 px-2 py-1 rounded-full text-white/80">
                    <i className="fas fa-birthday-cake mr-1"></i>{baseData.age}ÏÑ∏
                  </span>
                  <span className="bg-white/10 px-2 py-1 rounded-full text-white/80">
                    <i className="fas fa-ruler-vertical mr-1"></i>{baseData.height}cm
                  </span>
                  <span className="bg-white/10 px-2 py-1 rounded-full text-white/80">
                    <i className="fas fa-briefcase mr-1"></i>{baseData.profession}
                  </span>
                </div>
              </div>
            </div>
          </div>

          {/* BMI Status */}
          <div className="grid grid-cols-2 gap-6 mb-6">
            <div className="text-center">
              <CircularProgress 
                value={currentBmi} 
                maxValue={35} 
                color={bmiCategory.color}
              />
              <p className="text-white/80 text-sm mt-3 font-medium">ÌòÑÏû¨ BMI</p>
            </div>
            <div className="space-y-3">
              <div className={`${bmiCategory.class} rounded-xl p-4 text-center sparkle`}>
                <div className="text-white font-bold text-lg mb-1">
                  {bmiCategory.icon} {bmiCategory.text}
                </div>
                <div className="text-white/90 text-sm">BMI {currentBmi.toFixed(1)}</div>
              </div>
              {targetBmi > 0 && (
                <div className="bg-white/10 rounded-xl p-3 text-center">
                  <div className="text-white/80 text-sm">Î™©Ìëú: {targetBmi.toFixed(1)}</div>
                  <div className="text-white/60 text-xs">
                    {bmiDifference > 0 ? '‚Üë' : '‚Üì'} {Math.abs(bmiDifference).toFixed(1)}
                  </div>
                </div>
              )}
            </div>
          </div>
           <button 
                onClick={() => setShowDetails(!showDetails)}
                className="w-full py-3 bg-white/20 text-white font-semibold rounded-2xl mb-4 hover:bg-white/30 transition-all transform hover:scale-105"
            >
                {showDetails ? (
                  <span><i className="fas fa-chevron-up mr-2"></i>Ï†ëÍ∏∞</span>
                ) : (
                  <span><i className="fas fa-chevron-down mr-2"></i>ÏÉÅÏÑ∏ Î≥¥Í∏∞</span>
                )}
            </button>

          {/* Details */}
          {showDetails && (
            <div className="space-y-6 slide-up">
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label className="flex items-center text-white/80 font-medium mb-2 text-sm">
                    <i className="fas fa-weight-scale mr-2"></i>Ï¥àÍ∏∞ Ï≤¥Ï§ë (kg)
                  </label>
                  <p className="w-full p-3 bg-white/10 rounded-xl text-white/80 backdrop-blur-sm">
                    {initialWeight} kg
                  </p>
                </div>
                <div>
                  <label className="flex items-center text-white/80 font-medium mb-2 text-sm">
                    <i className="fas fa-bullseye mr-2"></i>Î™©Ìëú Ï≤¥Ï§ë (kg)
                  </label>
                  <input 
                    type="number" 
                    value={localData.targetWeight || ''} 
                    onChange={e => handleChange('targetWeight', e.target.value)} 
                    step="0.1" 
                    className="w-full p-3 bg-white/10 border border-white/20 rounded-xl text-white placeholder-white/50 backdrop-blur-sm focus:outline-none focus:border-white/50 focus:bg-white/15 transition-all"
                    placeholder="Î™©Ìëú Ï≤¥Ï§ë"
                  />
                </div>
                <div>
                  <label className="flex items-center text-white/80 font-medium mb-2 text-sm">
                    <i className="fas fa-weight-hanging mr-2"></i>ÌòÑÏû¨ Ï≤¥Ï§ë (kg)
                  </label>
                  <input 
                    type="number" 
                    value={localData.weight || ''} 
                    onChange={e => handleChange('weight', e.target.value)} 
                    step="0.1" 
                    className="w-full p-3 bg-white/10 border border-white/20 rounded-xl text-white placeholder-white/50 backdrop-blur-sm focus:outline-none focus:border-white/50 focus:bg-white/15 transition-all"
                    placeholder="Ï≤¥Ï§ë ÏûÖÎ†•"
                  />
                </div>
                <div>
                  <label className="flex items-center text-white/80 font-medium mb-2 text-sm">
                    <i className="fas fa-percentage mr-2"></i>Î™©Ìëú ÏßÑÌñâÎ•† (%)
                  </label>
                  <p className="w-full p-3 bg-white/10 rounded-xl text-white backdrop-blur-sm">
                    {progress.toFixed(1)} %
                  </p>
                </div>
                <div>
                    <label className="flex items-center text-white/80 font-medium mb-2 text-sm">
                      <i className="fas fa-dumbbell mr-2"></i>Ï≤¥Ìòï
                    </label>
                    <select 
                      value={localData.bodyType || 'Î≥¥ÌÜµ'} 
                      onChange={e => handleChange('bodyType', e.target.value)} 
                      className="w-full p-3 bg-white/10 border border-white/20 rounded-xl text-white backdrop-blur-sm focus:outline-none focus:border-white/50 focus:bg-white/15 transition-all"
                    >
                      <option value="Î≥¥ÌÜµ">Î≥¥ÌÜµ</option>
                      <option value="Í∑ºÏú°Ìòï">Í∑ºÏú°Ìòï</option>
                      <option value="ÎßàÎ•∏ ÎπÑÎßå">ÎßàÎ•∏ ÎπÑÎßå</option>
                      <option value="ÎßàÎ•∏ Ï≤¥Ìòï">ÎßàÎ•∏ Ï≤¥Ìòï</option>
                      <option value="Í≥ºÏ≤¥Ï§ë">Í≥ºÏ≤¥Ï§ë</option>
                    </select>
                </div>
              </div>

              {/* AI Insights */}
              <HealthInsights memberData={localData} baseData={baseData} />

              {/* Save Button */}
              <button 
                onClick={handleSave} 
                disabled={isSaving}
                className="w-full py-4 bg-gradient-to-r from-green-400 to-blue-500 text-white font-bold rounded-2xl sparkle hover:from-green-500 hover:to-blue-600 disabled:opacity-50 transition-all transform hover:scale-105 neon-glow"
              >
                {isSaving ? (
                  <div className="flex items-center justify-center space-x-2">
                    <div className="animate-spin rounded-full h-5 w-5 border-2 border-white border-t-transparent"></div>
                    <span>Ï†ÄÏû• Ï§ë...</span>
                  </div>
                ) : (
                  <span>
                    <i className="fas fa-save mr-2"></i>
                    Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû•ÌïòÍ∏∞
                  </span>
                )}
              </button>
            </div>
          )}
        </div>
      );
    };

    // Main App Component
    const App = () => {
      const [hasAccess, setHasAccess] = useState(false);
      const [data, setData] = useState(initialFamilyData);
      const [authReady, setAuthReady] = useState(false);
      const [userId, setUserId] = useState(null);
      const [toast, setToast] = useState(null);

      // Firebase authentication and data listener setup
      useEffect(() => {
        if (!window.firebase) {
            console.error("Firebase is not loaded.");
            return;
        }

        const { auth, initialAuthToken, signInWithCustomToken, signInAnonymously, onAuthStateChanged, db, appId, collection, onSnapshot } = window.firebase;
        
        // Listen for auth state changes
        const unsubscribeAuth = onAuthStateChanged(auth, async (user) => {
            if (user) {
                setUserId(user.uid);
                setAuthReady(true);
                // Listen for changes in the user's data
                const userHealthRef = collection(db, `artifacts/${appId}/users/${user.uid}/health-data`);
                const unsubscribeSnapshot = onSnapshot(userHealthRef, (snapshot) => {
                    if (!snapshot.empty) {
                        const firebaseData = {};
                        snapshot.docs.forEach(doc => {
                            firebaseData[doc.id] = doc.data();
                        });
                        // Merge initial data with data from Firestore
                        setData(prevData => {
                           const updatedData = { ...prevData };
                           Object.keys(firebaseData).forEach(id => {
                               updatedData[id] = { ...updatedData[id], ...firebaseData[id] };
                           });
                           return updatedData;
                        });
                    }
                }, (error) => {
                    console.error("Failed to listen for data updates:", error);
                    setToast({ message: "Îç∞Ïù¥ÌÑ∞ Î°úÎî© Ïò§Î•ò. ÏÉàÎ°úÍ≥†Ïπ®ÏùÑ ÏãúÎèÑÌïòÏÑ∏Ïöî.", type: "error" });
                });
                return () => unsubscribeSnapshot();
            } else {
                setAuthReady(true);
                setUserId(null);
            }
        }, (error) => {
            console.error("Authentication failed:", error);
            setAuthReady(true);
        });
        
        // Sign in with custom token or anonymously
        const authLogin = async () => {
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Authentication error during login:", error);
            }
        };

        if (auth && !auth.currentUser) {
            authLogin();
        }

        return () => unsubscribeAuth();
      }, []);

      useEffect(() => {
        if (toast) {
          const timer = setTimeout(() => setToast(null), 3000);
          return () => clearTimeout(timer);
        }
      }, [toast]);
      
      if (!hasAccess) {
        return <PasswordGate onAccess={setHasAccess} />;
      }
      
      return (
        <div className="min-h-screen animated-bg">
          {toast && <ToastMessage message={toast.message} type={toast.type} onClose={() => setToast(null)} />}
          <div className="p-4 md:p-8 lg:p-12 text-white">
            <header className="text-center py-8">
              <h1 className="text-5xl md:text-6xl font-extrabold mb-2 gradient-text">
                Ultimate Health Dashboard
              </h1>
              <p className="text-lg md:text-xl font-medium text-white/80">
                <i className="fas fa-heartbeat mr-2 pulse"></i> Ïö∞Î¶¨ Í∞ÄÏ°± Í±¥Í∞ï Í¥ÄÎ¶¨
              </p>
              {userId && (
                  <div className="text-xs text-white/50 mt-2 break-all">User ID: {userId}</div>
              )}
            </header>
            <div className="fade-in">
              <div className="grid gap-8 mb-12 lg:grid-cols-2 xl:grid-cols-4">
                {Object.keys(data).map(id => (
                  <FamilyMember
                    key={id}
                    memberData={data[id]}
                    onUpdate={() => {}} // Placeholder, logic is in handleSave
                    baseData={initialFamilyData[id]}
                    setToast={setToast}
                    auth={window.firebase.auth}
                  />
                ))}
              </div>
              <div className="w-full h-[400px] glassmorphism p-4 rounded-3xl">
                {authReady ? (
                  <AdvancedBMIChart familyHealthData={data} initialData={initialFamilyData} />
                ) : (
                  <div className="flex items-center justify-center w-full h-full text-white/70">
                    <div className="animate-spin rounded-full h-10 w-10 border-4 border-white border-t-transparent mr-4"></div>
                    Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§Îäî Ï§ëÏûÖÎãàÎã§...
                  </div>
                )}
              </div>
            </div>
            <footer className="text-center text-white/50 text-sm mt-12 py-4 border-t border-white/20">
              ¬© 2025. ÏàòÏïÑÎèôÌòÅÍ∞ÄÏ°±. All Rights Reserved.
              <div className="mt-2 text-xs break-all">Ïù¥ Ïï±ÏùÄ ÌååÏù¥Ïñ¥Î≤†Ïù¥Ïä§ Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§Ïóê Îç∞Ïù¥ÌÑ∞Î•º Ï†ÄÏû•Ìï©ÎãàÎã§.</div>
            </footer>
          </div>
        </div>
      );
    };

    // Chart.js Component
    const AdvancedBMIChart = ({ familyHealthData, initialData }) => {
      const canvasRef = useRef(null);
      const chartRef = useRef(null);

      useEffect(() => {
        if (!familyHealthData || Object.keys(familyHealthData).length === 0) return;
        
        const ctx = canvasRef.current.getContext('2d');
        
        if (chartRef.current) {
            chartRef.current.destroy();
        }

        const labels = Object.values(familyHealthData).map(member => member.name);
        const currentBmis = Object.values(familyHealthData).map(member => {
          const heightM = initialData[member.id].height / 100;
          return member.weight ? (member.weight / (heightM * heightM)) : 0;
        });
        
        const targetBmis = Object.values(initialData).map(member => member.recommendedBMI);
        
        const progressPercentages = Object.values(familyHealthData).map(member => {
          const initialWeight = initialData[member.id].weight;
          const targetWeight = member.targetWeight;
          const currentWeight = member.weight;
          
          if (!targetWeight || initialWeight === targetWeight) {
            return null;
          }
          
          let progress = ((currentWeight - initialWeight) / (targetWeight - initialWeight)) * 100;
          progress = Math.min(100, Math.max(0, progress));
          return progress;
        });

        chartRef.current = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: labels,
            datasets: [{
              label: 'ÌòÑÏû¨ BMI',
              data: currentBmis,
              backgroundColor: [
                'rgba(75, 192, 192, 0.6)', 
                'rgba(255, 159, 64, 0.6)', 
                'rgba(54, 162, 235, 0.6)', 
                'rgba(153, 102, 255, 0.6)'
              ],
              borderColor: [
                'rgba(75, 192, 192, 1)', 
                'rgba(255, 159, 64, 1)', 
                'rgba(54, 162, 235, 1)', 
                'rgba(153, 102, 255, 1)'
              ],
              borderWidth: 1,
              datalabels: {
                color: 'white',
                anchor: 'end',
                align: 'top',
                offset: 5,
                formatter: (value) => value > 0 ? value.toFixed(1) : ''
              }
            },
            {
              label: 'Î™©Ìëú BMI',
              data: targetBmis,
              backgroundColor: 'rgba(255, 255, 255, 0.2)',
              borderColor: 'rgba(255, 255, 255, 0.8)',
              borderWidth: 2,
              type: 'line',
              fill: false,
              datalabels: {
                display: false
              }
            },
            {
              label: 'Î™©Ìëú Îã¨ÏÑ±Î•† (%)',
              data: progressPercentages,
              type: 'line',
              fill: false,
              borderColor: '#f5576c',
              borderWidth: 2,
              borderDash: [5, 5],
              pointBackgroundColor: '#f5576c',
              datalabels: {
                color: '#f5576c',
                anchor: 'start',
                align: 'end',
                offset: 10,
                formatter: (value) => {
                  return value !== null ? `${value.toFixed(0)}%` : '';
                }
              }
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                labels: { color: 'white' }
              },
              title: {
                display: true,
                text: 'Í∞ÄÏ°± BMI Î∞è Î™©Ìëú Îã¨ÏÑ±Î•†',
                color: 'white',
                font: { size: 18, family: 'Noto Sans KR' }
              }
            },
            scales: {
              x: {
                ticks: { color: 'white' },
                grid: { color: 'rgba(255, 255, 255, 0.2)' }
              },
              y: {
                ticks: { color: 'white' },
                grid: { color: 'rgba(255, 255, 255, 0.2)' },
                min: 15, max: 35
              }
            }
          },
          plugins: [ChartDataLabels]
        });

        return () => {
          if (chartRef.current) {
            chartRef.current.destroy();
          }
        };
      }, [familyHealthData]);

      return <canvas ref={canvasRef} />;
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>               onUpdate={updateData}
                      baseData={initialFamilyData[id]}
                      setToast={setToast}
                    />
                  ))}
                </div>
                <div className="w-full h-[400px] glassmorphism p-4 rounded-3xl">
                  <AdvancedBMIChart familyHealthData={data} />
                </div>
              </div>
            )}
            <footer className="text-center text-white/50 text-sm mt-12 py-4 border-t border-white/20">
              ¬© 2025. ÏàòÏïÑÎèôÌòÅÍ∞ÄÏ°±. All Rights Reserved.
              <div className="mt-2 text-xs break-all">User ID: {displayUserId}</div>
            </footer>
          </div>
        </div>
      );
    };

    // Chart.js Component
    const AdvancedBMIChart = ({ familyHealthData }) => {
      const canvasRef = useRef(null);
      const chartRef = useRef(null);

      useEffect(() => {
        if (!familyHealthData || Object.keys(familyHealthData).length === 0) return;
        
        const ctx = canvasRef.current.getContext('2d');
        
        if (chartRef.current) {
            chartRef.current.destroy();
        }

        const labels = Object.values(familyHealthData).map(member => member.name);
        const currentBmis = Object.values(familyHealthData).map(member => {
          const heightM = initialFamilyData[member.id].height / 100;
          return member.weight ? (member.weight / (heightM * heightM)) : 0;
        });
        const targetBmis = Object.values(initialFamilyData).map(member => member.recommendedBMI);
        
        chartRef.current = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: labels,
            datasets: [{
              label: 'ÌòÑÏû¨ BMI',
              data: currentBmis,
              backgroundColor: [
                'rgba(75, 192, 192, 0.6)', 
                'rgba(255, 159, 64, 0.6)', 
                'rgba(54, 162, 235, 0.6)', 
                'rgba(153, 102, 255, 0.6)'
              ],
              borderColor: [
                'rgba(75, 192, 192, 1)', 
                'rgba(255, 159, 64, 1)', 
                'rgba(54, 162, 235, 1)', 
                'rgba(153, 102, 255, 1)'
              ],
              borderWidth: 1
            },
            {
              label: 'Î™©Ìëú BMI',
              data: targetBmis,
              backgroundColor: 'rgba(255, 255, 255, 0.2)',
              borderColor: 'rgba(255, 255, 255, 0.8)',
              borderWidth: 2,
              type: 'line',
              fill: false,
              datalabels: {
                display: false
              }
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                labels: { color: 'white' }
              },
              title: {
                display: true,
                text: 'Í∞ÄÏ°± BMI Ï∂îÏù¥',
                color: 'white',
                font: { size: 18, family: 'Noto Sans KR' }
              },
              datalabels: {
                color: 'white',
                anchor: 'end',
                align: 'top',
                formatter: (value) => value.toFixed(1)
              }
            },
            scales: {
              x: {
                ticks: { color: 'white' },
                grid: { color: 'rgba(255, 255, 255, 0.2)' }
              },
              y: {
                ticks: { color: 'white' },
                grid: { color: 'rgba(255, 255, 255, 0.2)' },
                min: 15, max: 35
              }
            }
          },
          plugins: [ChartDataLabels]
        });

        return () => {
          if (chartRef.current) {
            chartRef.current.destroy();
          }
        };
      }, [familyHealthData]);

      return <canvas ref={canvasRef} />;
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>