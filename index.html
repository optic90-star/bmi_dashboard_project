<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>가족 건강 대시보드</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ===================================================================================
        // Firebase 프로젝트 구성 정보가 적용되었습니다.
        // ===================================================================================
        const firebaseConfig = {
            apiKey: "AIzaSyDVvT5a8vh8CICbT18cqF5dMqRkxalgJWk",
            authDomain: "bmi-dashboard-project.firebaseapp.com",
            projectId: "bmi-dashboard-project",
            storageBucket: "bmi-dashboard-project.firebasestorage.app",
            messagingSenderId: "124744707008",
            appId: "1:124744707008:web:02757469b90412cc013625",
            measurementId: "G-CZQNBEYYCW"
        };
        // ===================================================================================

        let db, auth;
        let userId = null;
        let familyHealthData = [];
        let myChart = null;

        // 추가된 부분: 초기 샘플 데이터
        const getInitialFamilyData = () => {
            const today = new Date().toISOString().split('T')[0];
            return {
                '아빠': {
                    name: '아빠', age: 45, gender: '남자', body_type: '표준', height: 175, target_weight: 72, initial_weight: 75,
                    bmi_history: [{ date: today, bmi: calculateBMI(175, 75) }], weight_history: [{ date: today, weight: 75 }]
                },
                '엄마': {
                    name: '엄마', age: 42, gender: '여자', body_type: '표준', height: 162, target_weight: 55, initial_weight: 58,
                    bmi_history: [{ date: today, bmi: calculateBMI(162, 58) }], weight_history: [{ date: today, weight: 58 }]
                },
                '큰딸': {
                    name: '큰딸', age: 16, gender: '여자', body_type: '마른 체형', height: 165, target_weight: 52, initial_weight: 50,
                    bmi_history: [{ date: today, bmi: calculateBMI(165, 50) }], weight_history: [{ date: today, weight: 50 }]
                },
                '둘째아들': {
                    name: '둘째아들', age: 12, gender: '남자', body_type: '표준', height: 150, target_weight: 45, initial_weight: 43,
                    bmi_history: [{ date: today, bmi: calculateBMI(150, 43) }], weight_history: [{ date: today, weight: 43 }]
                }
            };
        };


        window.onload = async () => {
            if (firebaseConfig && firebaseConfig.apiKey) {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        const docRef = doc(db, `users/${userId}/health_data/family_info`);
                        
                        onSnapshot(docRef, async (docSnap) => {
                            if (!docSnap.exists() || Object.keys(docSnap.data()).length === 0) {
                                console.log("초기 데이터가 없어 샘플 데이터를 생성합니다.");
                                await setDoc(docRef, getInitialFamilyData());
                                // onSnapshot이 데이터를 다시 로드하므로 여기서 UI를 직접 렌더링할 필요 없음
                            } else {
                                familyHealthData = Object.values(docSnap.data());
                                renderFamilyList(familyHealthData);
                                renderChart(familyHealthData);
                                renderAchievementRate(calculateAchievementRate(familyHealthData));
                            }
                            
                            document.getElementById('user-id-display').textContent = userId.substring(0, 10) + '...';
                        }, (error) => {
                            console.error("데이터 수신 오류: ", error);
                        });

                    } else {
                        console.log("로그인된 사용자가 없습니다.");
                        userId = null;
                        document.getElementById('user-id-display').textContent = '로그인 필요';
                    }
                });

                try {
                    await signInAnonymously(auth);
                } catch (error) {
                    console.error("Firebase 익명 인증 오류: ", error);
                    alert("Firebase 인증에 실패했습니다. 설정을 확인해주세요.");
                }
            } else {
                console.error("Firebase 설정이 비어있습니다. 데이터를 로드할 수 없습니다.");
                alert("Firebase 구성(Config) 정보가 index.html 파일에 입력되지 않았습니다. 코드를 수정해주세요.");
            }
        };

        const getBmiStatusText = (bmi) => {
            if (bmi < 18.5) return '저체중';
            if (bmi >= 18.5 && bmi < 24.9) return '정상';
            if (bmi >= 25 && bmi < 29.9) return '과체중';
            return '비만';
        };

        const calculateBMI = (height, weight) => {
            if (!height || !weight || height <= 0 || weight <= 0) return 0;
            const heightM = height / 100;
            return (weight / (heightM * heightM));
        };

        const calculateAchievementRate = (data) => {
            if (data.length === 0) return 0;
            let normalCount = 0;
            let weightGoalCount = 0;

            data.forEach(member => {
                const latestBmi = member.bmi_history.length > 0 ? member.bmi_history[member.bmi_history.length - 1].bmi : 0;
                const latestWeight = member.weight_history.length > 0 ? member.weight_history[member.weight_history.length - 1].weight : 0;
                
                if (latestBmi >= 18.5 && latestBmi < 24.9) {
                    normalCount++;
                }

                const isWeightGoalAchieved = member.target_weight && latestWeight >= member.target_weight - 1 && latestWeight <= member.target_weight + 1;
                if (isWeightGoalAchieved) {
                    weightGoalCount++;
                }
            });

            const totalGoals = data.length * 2;
            if (totalGoals === 0) return 0;
            const achievedGoals = normalCount + weightGoalCount;
            return Math.round((achievedGoals / totalGoals) * 100);
        };

        window.handleSave = async () => {
            if (!userId) {
                alert("로그인 중이 아닙니다. 데이터를 저장할 수 없습니다.");
                return;
            }

            const name = document.getElementById('memberName').value;
            const age = parseInt(document.getElementById('memberAge').value);
            const gender = document.getElementById('memberGender').value;
            const bodyType = document.getElementById('memberBodyType').value;
            const height = parseFloat(document.getElementById('memberHeight').value);
            const weight = parseFloat(document.getElementById('memberWeight').value);
            const targetWeight = parseFloat(document.getElementById('memberTargetWeight').value);

            if (!name || !age || !gender || !bodyType || !height || !weight || !targetWeight) {
                alert('모든 정보를 정확히 입력해주세요.');
                return;
            }

            const bmi = calculateBMI(height, weight);
            const today = new Date().toISOString().split('T')[0];

            const docRef = doc(db, `users/${userId}/health_data/family_info`);

            try {
                const docSnap = await getDoc(docRef);
                const currentData = docSnap.exists() ? docSnap.data() : {};

                const existingMemberData = currentData[name] || {
                    name: name,
                    initial_weight: weight,
                    bmi_history: [],
                    weight_history: []
                };

                const newBmiHistory = [...existingMemberData.bmi_history, { date: today, bmi: bmi }];
                const newWeightHistory = [...existingMemberData.weight_history, { date: today, weight: weight }];
                
                const updatedMemberData = {
                    ...existingMemberData,
                    age,
                    gender,
                    body_type: bodyType,
                    height,
                    target_weight: targetWeight,
                    bmi_history: newBmiHistory.slice(-5),
                    weight_history: newWeightHistory.slice(-5)
                };

                await setDoc(docRef, {
                    ...currentData,
                    [name]: updatedMemberData
                });
                
                document.getElementById('memberName').value = '';
                document.getElementById('memberAge').value = '';
                document.getElementById('memberGender').value = '남자';
                document.getElementById('memberBodyType').value = '표준';
                document.getElementById('memberHeight').value = '';
                document.getElementById('memberWeight').value = '';
                document.getElementById('memberTargetWeight').value = '';
                
            } catch (e) {
                console.error("문서 추가/업데이트 오류: ", e);
                alert("데이터 저장 중 오류가 발생했습니다.");
            }
        };

        const renderFamilyList = (data) => {
            const listContainer = document.getElementById('family-list-container');
            listContainer.innerHTML = '';
            if (data.length === 0) {
                listContainer.innerHTML = '<p class="text-gray-400">가족 정보를 추가해주세요.</p>';
            } else {
                data.forEach(member => {
                    const latestBmi = member.bmi_history.length > 0 ? member.bmi_history[member.bmi_history.length - 1].bmi : 0;
                    const latestWeight = member.weight_history.length > 0 ? member.weight_history[member.weight_history.length - 1].weight : 0;
                    const bmiStatusText = getBmiStatusText(latestBmi);
                    
                    const memberCard = `
                        <div class="bg-[#2e2e4a] p-4 rounded-xl shadow-md transition-transform hover:scale-105">
                            <h3 class="text-xl font-semibold mb-2">${member.name} (${member.age}, ${member.gender})</h3>
                            <div class="text-sm text-gray-400 space-y-1">
                                <p>체형: ${member.body_type}</p>
                                <p>초기 체중: <span class="text-white font-bold">${member.initial_weight}kg</span></p>
                                <p>현재 체중: <span class="text-white font-bold">${latestWeight}kg</span></p>
                                <p>목표 체중: <span class="text-white font-bold">${member.target_weight}kg</span></p>
                                <p>현재 BMI: <span class="text-white font-bold">${latestBmi.toFixed(1)}</span> (${bmiStatusText})</p>
                            </div>
                        </div>
                    `;
                    listContainer.innerHTML += memberCard;
                });
            }
        };

        const renderAchievementRate = (rate) => {
            const rateDisplay = document.getElementById('achievement-rate-display');
            const progressBar = document.getElementById('progress-bar');
            rateDisplay.textContent = `${rate}%`;
            progressBar.style.width = `${rate}%`;
        };

        window.renderChart = (data) => {
            const chartCanvas = document.getElementById('bmi-chart');
            if (myChart) {
                myChart.destroy();
            }

            const allDates = [...new Set(data.flatMap(member => member.weight_history.map(d => d.date)))].sort();
            
            const datasets = data.map(member => {
                const color = '#' + Math.floor(Math.random() * 16777215).toString(16).padStart(6, '0');
                return {
                    label: `${member.name} 체중`,
                    data: allDates.map(date => {
                        const record = member.weight_history.find(d => d.date === date);
                        return record ? record.weight : null;
                    }),
                    borderColor: color,
                    backgroundColor: color,
                    type: 'line',
                    fill: false,
                    yAxisID: 'y'
                }
            });

            myChart = new Chart(chartCanvas, {
                data: {
                    labels: allDates,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    spanGaps: true,
                    plugins: {
                        legend: { labels: { color: 'white' } },
                        title: { display: true, text: '가족 체중 변화 추이', color: 'white', font: { size: 18 } },
                        datalabels: { color: 'white', anchor: 'end', align: 'top', formatter: (value) => value ? value.toFixed(1) : '' }
                    },
                    scales: {
                        x: { ticks: { color: 'white' }, grid: { color: 'rgba(255, 255, 255, 0.2)' } },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: { display: true, text: '체중 (kg)', color: 'white' },
                            ticks: { color: 'white' },
                            grid: { color: 'rgba(255, 255, 255, 0.2)' }
                        }
                    }
                },
                plugins: [ChartDataLabels]
            });
        };
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a1a2e;
            color: #ffffff;
        }
        .bmi-container {
            background-color: #272740;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .progress-bar-container {
            width: 100%;
            height: 12px;
            background-color: #1a1a2e;
            border-radius: 6px;
            overflow: hidden;
        }
        .progress-bar {
            height: 100%;
            background-color: #4CAF50;
            transition: width 0.5s ease-in-out;
        }
    </style>
</head>
<body class="p-6 md:p-12 min-h-screen flex items-center justify-center">
    <div class="w-full max-w-4xl mx-auto flex flex-col md:flex-row gap-8">
        <!-- Input Form and Family List -->
        <div class="md:w-1/3 w-full space-y-8">
            <div class="bmi-container p-6">
                <h2 class="text-2xl font-bold mb-4">가족 정보 입력</h2>
                <div class="space-y-4">
                    <div>
                        <label for="memberName" class="block text-sm font-medium text-gray-300">이름</label>
                        <input type="text" id="memberName" class="mt-1 block w-full rounded-md bg-[#1a1a2e] border-gray-600 focus:border-indigo-500 focus:ring-indigo-500 text-white shadow-sm" placeholder="예: 아빠">
                    </div>
                    <div>
                        <label for="memberAge" class="block text-sm font-medium text-gray-300">나이</label>
                        <input type="number" id="memberAge" class="mt-1 block w-full rounded-md bg-[#1a1a2e] border-gray-600 focus:border-indigo-500 focus:ring-indigo-500 text-white shadow-sm" placeholder="예: 45">
                    </div>
                    <div>
                        <label for="memberGender" class="block text-sm font-medium text-gray-300">성별</label>
                        <select id="memberGender" class="mt-1 block w-full rounded-md bg-[#1a1a2e] border-gray-600 focus:border-indigo-500 focus:ring-indigo-500 text-white shadow-sm">
                            <option value="남자">남자</option>
                            <option value="여자">여자</option>
                        </select>
                    </div>
                    <div>
                        <label for="memberBodyType" class="block text-sm font-medium text-gray-300">체형</label>
                        <select id="memberBodyType" class="mt-1 block w-full rounded-md bg-[#1a1a2e] border-gray-600 focus:border-indigo-500 focus:ring-indigo-500 text-white shadow-sm">
                            <option value="표준">표준</option>
                            <option value="마른 체형">마른 체형</option>
                            <option value="근육형">근육형</option>
                        </select>
                    </div>
                    <div>
                        <label for="memberHeight" class="block text-sm font-medium text-gray-300">키 (cm)</label>
                        <input type="number" id="memberHeight" class="mt-1 block w-full rounded-md bg-[#1a1a2e] border-gray-600 focus:border-indigo-500 focus:ring-indigo-500 text-white shadow-sm" placeholder="예: 175">
                    </div>
                    <div>
                        <label for="memberWeight" class="block text-sm font-medium text-gray-300">몸무게 (kg)</label>
                        <input type="number" id="memberWeight" class="mt-1 block w-full rounded-md bg-[#1a1a2e] border-gray-600 focus:border-indigo-500 focus:ring-indigo-500 text-white shadow-sm" placeholder="예: 70">
                    </div>
                    <div>
                        <label for="memberTargetWeight" class="block text-sm font-medium text-gray-300">목표 체중 (kg)</label>
                        <input type="number" id="memberTargetWeight" class="mt-1 block w-full rounded-md bg-[#1a1a2e] border-gray-600 focus:border-indigo-500 focus:ring-indigo-500 text-white shadow-sm" placeholder="예: 68">
                    </div>
                    <button onclick="handleSave()" class="w-full py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors">
                        저장
                    </button>
                </div>
            </div>
            
            <div class="bmi-container p-6">
                <h2 class="text-2xl font-bold mb-4">종합 건강 달성률</h2>
                <div class="text-center">
                    <p class="text-4xl font-bold mb-2"><span id="achievement-rate-display">0%</span></p>
                    <div class="progress-bar-container">
                        <div id="progress-bar" class="progress-bar"></div>
                    </div>
                </div>
            </div>

            <div class="bmi-container p-6">
                <h2 class="text-2xl font-bold mb-4">등록된 가족</h2>
                <div id="family-list-container" class="space-y-4">
                    <p class="text-gray-400">가족 정보를 추가해주세요.</p>
                </div>
                <div class="mt-4 p-2 bg-[#1a1a2e] text-center rounded-lg text-sm text-gray-400">
                    <p>유저 아이디: <span id="user-id-display">로딩 중...</span></p>
                </div>
            </div>
        </div>

        <!-- BMI Chart -->
        <div class="md:w-2/3 w-full bmi-container p-6 flex flex-col items-center justify-center">
            <h2 class="text-2xl font-bold mb-4 text-center">가족 건강 추이</h2>
            <div class="w-full h-80">
                <canvas id="bmi-chart"></canvas>
            </div>
        </div>
    </div>
</body>
</html>

